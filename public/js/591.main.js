/*! For license information please see 591.main.js.LICENSE.txt */
"use strict";(self.webpackChunklistapp=self.webpackChunklistapp||[]).push([[591],{591:(t,e,n)=>{n.r(e),n.d(e,{AbstractUserDataWriter:()=>Af,Bytes:()=>Td,CACHE_SIZE_UNLIMITED:()=>ed,CollectionReference:()=>zl,DocumentReference:()=>$l,DocumentSnapshot:()=>Zd,FieldPath:()=>wd,FieldValue:()=>bd,Firestore:()=>nd,FirestoreError:()=>Ls,GeoPoint:()=>Id,LoadBundleTask:()=>td,Query:()=>Gl,QueryConstraint:()=>of,QueryDocumentSnapshot:()=>tf,QuerySnapshot:()=>ef,SnapshotMetadata:()=>Jd,Timestamp:()=>Ys,Transaction:()=>Gf,WriteBatch:()=>Df,_DatabaseId:()=>Rl,_DocumentKey:()=>wr,_EmptyAppCheckTokenProvider:()=>Ks,_EmptyAuthCredentialsProvider:()=>Os,_FieldPath:()=>rr,_cast:()=>ql,_debugAssert:()=>Ns,_isBase64Available:()=>or,_logWarn:()=>_s,_validateIsNotUsedTogether:()=>Pl,addDoc:()=>Uf,arrayRemove:()=>Yf,arrayUnion:()=>Wf,clearIndexedDbPersistence:()=>hd,collection:()=>Hl,collectionGroup:()=>Ql,connectFirestoreEmulator:()=>Kl,deleteDoc:()=>qf,deleteField:()=>Hf,disableNetwork:()=>fd,doc:()=>Wl,documentId:()=>vd,enableIndexedDbPersistence:()=>ad,enableMultiTabIndexedDbPersistence:()=>cd,enableNetwork:()=>dd,endAt:()=>Tf,endBefore:()=>vf,ensureFirestoreConfigured:()=>id,executeWrite:()=>Kf,getDoc:()=>Nf,getDocFromCache:()=>Rf,getDocFromServer:()=>Lf,getDocs:()=>Mf,getDocsFromCache:()=>Pf,getDocsFromServer:()=>Of,getFirestore:()=>rd,increment:()=>Xf,initializeFirestore:()=>sd,limit:()=>ff,limitToLast:()=>mf,loadBundle:()=>gd,namedQuery:()=>pd,onSnapshot:()=>Bf,onSnapshotsInSync:()=>jf,orderBy:()=>lf,query:()=>af,queryEqual:()=>Xl,refEqual:()=>Yl,runTransaction:()=>zf,serverTimestamp:()=>Qf,setDoc:()=>Ff,setLogLevel:()=>Es,snapshotEqual:()=>sf,startAfter:()=>yf,startAt:()=>pf,terminate:()=>md,updateDoc:()=>Vf,waitForPendingWrites:()=>ld,where:()=>uf,writeBatch:()=>Jf});var s,r=n(238),i=n(463),o=n(333),a=n(444),c="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==n.g?n.g:"undefined"!=typeof self?self:{},u={},h=h||{},l=c||self;function d(){}function f(t){var e=typeof t;return"array"==(e="object"!=e?e:t?Array.isArray(t)?"array":e:"null")||"object"==e&&"number"==typeof t.length}function m(t){var e=typeof t;return"object"==e&&null!=t||"function"==e}var g="closure_uid_"+(1e9*Math.random()>>>0),p=0;function y(t,e,n){return t.call.apply(t.bind,arguments)}function w(t,e,n){if(!t)throw Error();if(2<arguments.length){var s=Array.prototype.slice.call(arguments,2);return function(){var n=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(n,s),t.apply(e,n)}}return function(){return t.apply(e,arguments)}}function v(t,e,n){return(v=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?y:w).apply(null,arguments)}function T(t,e){var n=Array.prototype.slice.call(arguments,1);return function(){var e=n.slice();return e.push.apply(e,arguments),t.apply(this,e)}}function b(t,e){function n(){}n.prototype=e.prototype,t.Z=e.prototype,t.prototype=new n,t.prototype.constructor=t,t.Vb=function(t,n,s){for(var r=Array(arguments.length-2),i=2;i<arguments.length;i++)r[i-2]=arguments[i];return e.prototype[n].apply(t,r)}}function I(){this.s=this.s,this.o=this.o}var E={};I.prototype.s=!1,I.prototype.na=function(){if(!this.s&&(this.s=!0,this.M(),0)){var t=function(t){return Object.prototype.hasOwnProperty.call(t,g)&&t[g]||(t[g]=++p)}(this);delete E[t]}},I.prototype.M=function(){if(this.o)for(;this.o.length;)this.o.shift()()};const S=Array.prototype.indexOf?function(t,e){return Array.prototype.indexOf.call(t,e,void 0)}:function(t,e){if("string"==typeof t)return"string"!=typeof e||1!=e.length?-1:t.indexOf(e,0);for(let n=0;n<t.length;n++)if(n in t&&t[n]===e)return n;return-1},A=Array.prototype.forEach?function(t,e,n){Array.prototype.forEach.call(t,e,n)}:function(t,e,n){const s=t.length,r="string"==typeof t?t.split(""):t;for(let i=0;i<s;i++)i in r&&e.call(n,r[i],i,t)};function _(t){return Array.prototype.concat.apply([],arguments)}function k(t){const e=t.length;if(0<e){const n=Array(e);for(let s=0;s<e;s++)n[s]=t[s];return n}return[]}function D(t){return/^[\s\xa0]*$/.test(t)}var C,N=String.prototype.trim?function(t){return t.trim()}:function(t){return/^[\s\xa0]*([\s\S]*?)[\s\xa0]*$/.exec(t)[1]};function x(t,e){return-1!=t.indexOf(e)}function R(t,e){return t<e?-1:t>e?1:0}t:{var L=l.navigator;if(L){var M=L.userAgent;if(M){C=M;break t}}C=""}function P(t,e,n){for(const s in t)e.call(n,t[s],s,t)}function O(t){const e={};for(const n in t)e[n]=t[n];return e}var F="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function V(t,e){let n,s;for(let e=1;e<arguments.length;e++){for(n in s=arguments[e],s)t[n]=s[n];for(let e=0;e<F.length;e++)n=F[e],Object.prototype.hasOwnProperty.call(s,n)&&(t[n]=s[n])}}function q(t){return q[" "](t),t}q[" "]=d;var U,B,j=x(C,"Opera"),K=x(C,"Trident")||x(C,"MSIE"),$=x(C,"Edge"),G=$||K,z=x(C,"Gecko")&&!(x(C.toLowerCase(),"webkit")&&!x(C,"Edge"))&&!(x(C,"Trident")||x(C,"MSIE"))&&!x(C,"Edge"),H=x(C.toLowerCase(),"webkit")&&!x(C,"Edge");function Q(){var t=l.document;return t?t.documentMode:void 0}t:{var W="",Y=(B=C,z?/rv:([^\);]+)(\)|;)/.exec(B):$?/Edge\/([\d\.]+)/.exec(B):K?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(B):H?/WebKit\/(\S+)/.exec(B):j?/(?:Version)[ \/]?(\S+)/.exec(B):void 0);if(Y&&(W=Y?Y[1]:""),K){var X=Q();if(null!=X&&X>parseFloat(W)){U=String(X);break t}}U=W}var J,Z={};function tt(){return t=Z,Object.prototype.hasOwnProperty.call(t,9)?t[9]:t[9]=function(){let t=0;const e=N(String(U)).split("."),n=N("9").split("."),s=Math.max(e.length,n.length);for(let o=0;0==t&&o<s;o++){var r=e[o]||"",i=n[o]||"";do{if(r=/(\d*)(\D*)(.*)/.exec(r)||["","","",""],i=/(\d*)(\D*)(.*)/.exec(i)||["","","",""],0==r[0].length&&0==i[0].length)break;t=R(0==r[1].length?0:parseInt(r[1],10),0==i[1].length?0:parseInt(i[1],10))||R(0==r[2].length,0==i[2].length)||R(r[2],i[2]),r=r[3],i=i[3]}while(0==t)}return 0<=t}();var t}l.document&&K?J=Q()||parseInt(U,10)||void 0:J=void 0;var et=J,nt=function(){if(!l.addEventListener||!Object.defineProperty)return!1;var t=!1,e=Object.defineProperty({},"passive",{get:function(){t=!0}});try{l.addEventListener("test",d,e),l.removeEventListener("test",d,e)}catch(t){}return t}();function st(t,e){this.type=t,this.g=this.target=e,this.defaultPrevented=!1}function rt(t,e){if(st.call(this,t?t.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,t){var n=this.type=t.type,s=t.changedTouches&&t.changedTouches.length?t.changedTouches[0]:null;if(this.target=t.target||t.srcElement,this.g=e,e=t.relatedTarget){if(z){t:{try{q(e.nodeName);var r=!0;break t}catch(t){}r=!1}r||(e=null)}}else"mouseover"==n?e=t.fromElement:"mouseout"==n&&(e=t.toElement);this.relatedTarget=e,s?(this.clientX=void 0!==s.clientX?s.clientX:s.pageX,this.clientY=void 0!==s.clientY?s.clientY:s.pageY,this.screenX=s.screenX||0,this.screenY=s.screenY||0):(this.clientX=void 0!==t.clientX?t.clientX:t.pageX,this.clientY=void 0!==t.clientY?t.clientY:t.pageY,this.screenX=t.screenX||0,this.screenY=t.screenY||0),this.button=t.button,this.key=t.key||"",this.ctrlKey=t.ctrlKey,this.altKey=t.altKey,this.shiftKey=t.shiftKey,this.metaKey=t.metaKey,this.pointerId=t.pointerId||0,this.pointerType="string"==typeof t.pointerType?t.pointerType:it[t.pointerType]||"",this.state=t.state,this.i=t,t.defaultPrevented&&rt.Z.h.call(this)}}st.prototype.h=function(){this.defaultPrevented=!0},b(rt,st);var it={2:"touch",3:"pen",4:"mouse"};rt.prototype.h=function(){rt.Z.h.call(this);var t=this.i;t.preventDefault?t.preventDefault():t.returnValue=!1};var ot="closure_listenable_"+(1e6*Math.random()|0),at=0;function ct(t,e,n,s,r){this.listener=t,this.proxy=null,this.src=e,this.type=n,this.capture=!!s,this.ia=r,this.key=++at,this.ca=this.fa=!1}function ut(t){t.ca=!0,t.listener=null,t.proxy=null,t.src=null,t.ia=null}function ht(t){this.src=t,this.g={},this.h=0}function lt(t,e){var n=e.type;if(n in t.g){var s,r=t.g[n],i=S(r,e);(s=0<=i)&&Array.prototype.splice.call(r,i,1),s&&(ut(e),0==t.g[n].length&&(delete t.g[n],t.h--))}}function dt(t,e,n,s){for(var r=0;r<t.length;++r){var i=t[r];if(!i.ca&&i.listener==e&&i.capture==!!n&&i.ia==s)return r}return-1}ht.prototype.add=function(t,e,n,s,r){var i=t.toString();(t=this.g[i])||(t=this.g[i]=[],this.h++);var o=dt(t,e,s,r);return-1<o?(e=t[o],n||(e.fa=!1)):((e=new ct(e,this.src,i,!!s,r)).fa=n,t.push(e)),e};var ft="closure_lm_"+(1e6*Math.random()|0),mt={};function gt(t,e,n,s,r){if(s&&s.once)return yt(t,e,n,s,r);if(Array.isArray(e)){for(var i=0;i<e.length;i++)gt(t,e[i],n,s,r);return null}return n=St(n),t&&t[ot]?t.N(e,n,m(s)?!!s.capture:!!s,r):pt(t,e,n,!1,s,r)}function pt(t,e,n,s,r,i){if(!e)throw Error("Invalid event type");var o=m(r)?!!r.capture:!!r,a=It(t);if(a||(t[ft]=a=new ht(t)),(n=a.add(e,n,s,o,i)).proxy)return n;if(s=function(){var t=bt;return function e(n){return t.call(e.src,e.listener,n)}}(),n.proxy=s,s.src=t,s.listener=n,t.addEventListener)nt||(r=o),void 0===r&&(r=!1),t.addEventListener(e.toString(),s,r);else if(t.attachEvent)t.attachEvent(Tt(e.toString()),s);else{if(!t.addListener||!t.removeListener)throw Error("addEventListener and attachEvent are unavailable.");t.addListener(s)}return n}function yt(t,e,n,s,r){if(Array.isArray(e)){for(var i=0;i<e.length;i++)yt(t,e[i],n,s,r);return null}return n=St(n),t&&t[ot]?t.O(e,n,m(s)?!!s.capture:!!s,r):pt(t,e,n,!0,s,r)}function wt(t,e,n,s,r){if(Array.isArray(e))for(var i=0;i<e.length;i++)wt(t,e[i],n,s,r);else s=m(s)?!!s.capture:!!s,n=St(n),t&&t[ot]?(t=t.i,(e=String(e).toString())in t.g&&-1<(n=dt(i=t.g[e],n,s,r))&&(ut(i[n]),Array.prototype.splice.call(i,n,1),0==i.length&&(delete t.g[e],t.h--))):t&&(t=It(t))&&(e=t.g[e.toString()],t=-1,e&&(t=dt(e,n,s,r)),(n=-1<t?e[t]:null)&&vt(n))}function vt(t){if("number"!=typeof t&&t&&!t.ca){var e=t.src;if(e&&e[ot])lt(e.i,t);else{var n=t.type,s=t.proxy;e.removeEventListener?e.removeEventListener(n,s,t.capture):e.detachEvent?e.detachEvent(Tt(n),s):e.addListener&&e.removeListener&&e.removeListener(s),(n=It(e))?(lt(n,t),0==n.h&&(n.src=null,e[ft]=null)):ut(t)}}}function Tt(t){return t in mt?mt[t]:mt[t]="on"+t}function bt(t,e){if(t.ca)t=!0;else{e=new rt(e,this);var n=t.listener,s=t.ia||t.src;t.fa&&vt(t),t=n.call(s,e)}return t}function It(t){return(t=t[ft])instanceof ht?t:null}var Et="__closure_events_fn_"+(1e9*Math.random()>>>0);function St(t){return"function"==typeof t?t:(t[Et]||(t[Et]=function(e){return t.handleEvent(e)}),t[Et])}function At(){I.call(this),this.i=new ht(this),this.P=this,this.I=null}function _t(t,e){var n,s=t.I;if(s)for(n=[];s;s=s.I)n.push(s);if(t=t.P,s=e.type||e,"string"==typeof e)e=new st(e,t);else if(e instanceof st)e.target=e.target||t;else{var r=e;V(e=new st(s,t),r)}if(r=!0,n)for(var i=n.length-1;0<=i;i--){var o=e.g=n[i];r=kt(o,s,!0,e)&&r}if(r=kt(o=e.g=t,s,!0,e)&&r,r=kt(o,s,!1,e)&&r,n)for(i=0;i<n.length;i++)r=kt(o=e.g=n[i],s,!1,e)&&r}function kt(t,e,n,s){if(!(e=t.i.g[String(e)]))return!0;e=e.concat();for(var r=!0,i=0;i<e.length;++i){var o=e[i];if(o&&!o.ca&&o.capture==n){var a=o.listener,c=o.ia||o.src;o.fa&&lt(t.i,o),r=!1!==a.call(c,s)&&r}}return r&&!s.defaultPrevented}b(At,I),At.prototype[ot]=!0,At.prototype.removeEventListener=function(t,e,n,s){wt(this,t,e,n,s)},At.prototype.M=function(){if(At.Z.M.call(this),this.i){var t,e=this.i;for(t in e.g){for(var n=e.g[t],s=0;s<n.length;s++)ut(n[s]);delete e.g[t],e.h--}}this.I=null},At.prototype.N=function(t,e,n,s){return this.i.add(String(t),e,!1,n,s)},At.prototype.O=function(t,e,n,s){return this.i.add(String(t),e,!0,n,s)};var Dt=l.JSON.stringify;function Ct(){var t=Ot;let e=null;return t.g&&(e=t.g,t.g=t.g.next,t.g||(t.h=null),e.next=null),e}var Nt,xt=new class{constructor(t,e){this.i=t,this.j=e,this.h=0,this.g=null}get(){let t;return 0<this.h?(this.h--,t=this.g,this.g=t.next,t.next=null):t=this.i(),t}}((()=>new Rt),(t=>t.reset()));class Rt{constructor(){this.next=this.g=this.h=null}set(t,e){this.h=t,this.g=e,this.next=null}reset(){this.next=this.g=this.h=null}}function Lt(t){l.setTimeout((()=>{throw t}),0)}function Mt(t,e){Nt||function(){var t=l.Promise.resolve(void 0);Nt=function(){t.then(Ft)}}(),Pt||(Nt(),Pt=!0),Ot.add(t,e)}var Pt=!1,Ot=new class{constructor(){this.h=this.g=null}add(t,e){const n=xt.get();n.set(t,e),this.h?this.h.next=n:this.g=n,this.h=n}};function Ft(){for(var t;t=Ct();){try{t.h.call(t.g)}catch(t){Lt(t)}var e=xt;e.j(t),100>e.h&&(e.h++,t.next=e.g,e.g=t)}Pt=!1}function Vt(t,e){At.call(this),this.h=t||1,this.g=e||l,this.j=v(this.kb,this),this.l=Date.now()}function qt(t){t.da=!1,t.S&&(t.g.clearTimeout(t.S),t.S=null)}function Ut(t,e,n){if("function"==typeof t)n&&(t=v(t,n));else{if(!t||"function"!=typeof t.handleEvent)throw Error("Invalid listener argument");t=v(t.handleEvent,t)}return 2147483647<Number(e)?-1:l.setTimeout(t,e||0)}function Bt(t){t.g=Ut((()=>{t.g=null,t.i&&(t.i=!1,Bt(t))}),t.j);const e=t.h;t.h=null,t.m.apply(null,e)}b(Vt,At),(s=Vt.prototype).da=!1,s.S=null,s.kb=function(){if(this.da){var t=Date.now()-this.l;0<t&&t<.8*this.h?this.S=this.g.setTimeout(this.j,this.h-t):(this.S&&(this.g.clearTimeout(this.S),this.S=null),_t(this,"tick"),this.da&&(qt(this),this.start()))}},s.start=function(){this.da=!0,this.S||(this.S=this.g.setTimeout(this.j,this.h),this.l=Date.now())},s.M=function(){Vt.Z.M.call(this),qt(this),delete this.g};class jt extends I{constructor(t,e){super(),this.m=t,this.j=e,this.h=null,this.i=!1,this.g=null}l(t){this.h=arguments,this.g?this.i=!0:Bt(this)}M(){super.M(),this.g&&(l.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function Kt(t){I.call(this),this.h=t,this.g={}}b(Kt,I);var $t=[];function Gt(t,e,n,s){Array.isArray(n)||(n&&($t[0]=n.toString()),n=$t);for(var r=0;r<n.length;r++){var i=gt(e,n[r],s||t.handleEvent,!1,t.h||t);if(!i)break;t.g[i.key]=i}}function zt(t){P(t.g,(function(t,e){this.g.hasOwnProperty(e)&&vt(t)}),t),t.g={}}function Ht(){this.g=!0}function Qt(t,e,n,s){t.info((function(){return"XMLHTTP TEXT ("+e+"): "+function(t,e){if(!t.g)return e;if(!e)return null;try{var n=JSON.parse(e);if(n)for(t=0;t<n.length;t++)if(Array.isArray(n[t])){var s=n[t];if(!(2>s.length)){var r=s[1];if(Array.isArray(r)&&!(1>r.length)){var i=r[0];if("noop"!=i&&"stop"!=i&&"close"!=i)for(var o=1;o<r.length;o++)r[o]=""}}}return Dt(n)}catch(t){return e}}(t,n)+(s?" "+s:"")}))}Kt.prototype.M=function(){Kt.Z.M.call(this),zt(this)},Kt.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")},Ht.prototype.Aa=function(){this.g=!1},Ht.prototype.info=function(){};var Wt={},Yt=null;function Xt(){return Yt=Yt||new At}function Jt(t){st.call(this,Wt.Ma,t)}function Zt(t){const e=Xt();_t(e,new Jt(e,t))}function te(t,e){st.call(this,Wt.STAT_EVENT,t),this.stat=e}function ee(t){const e=Xt();_t(e,new te(e,t))}function ne(t,e){st.call(this,Wt.Na,t),this.size=e}function se(t,e){if("function"!=typeof t)throw Error("Fn must not be null and must be a function");return l.setTimeout((function(){t()}),e)}Wt.Ma="serverreachability",b(Jt,st),Wt.STAT_EVENT="statevent",b(te,st),Wt.Na="timingevent",b(ne,st);var re={NO_ERROR:0,lb:1,yb:2,xb:3,sb:4,wb:5,zb:6,Ja:7,TIMEOUT:8,Cb:9},ie={qb:"complete",Mb:"success",Ka:"error",Ja:"abort",Eb:"ready",Fb:"readystatechange",TIMEOUT:"timeout",Ab:"incrementaldata",Db:"progress",tb:"downloadprogress",Ub:"uploadprogress"};function oe(){}function ae(t){return t.h||(t.h=t.i())}function ce(){}oe.prototype.h=null;var ue,he={OPEN:"a",pb:"b",Ka:"c",Bb:"d"};function le(){st.call(this,"d")}function de(){st.call(this,"c")}function fe(){}function me(t,e,n,s){this.l=t,this.j=e,this.m=n,this.X=s||1,this.V=new Kt(this),this.P=pe,t=G?125:void 0,this.W=new Vt(t),this.H=null,this.i=!1,this.s=this.A=this.v=this.K=this.F=this.Y=this.B=null,this.D=[],this.g=null,this.C=0,this.o=this.u=null,this.N=-1,this.I=!1,this.O=0,this.L=null,this.aa=this.J=this.$=this.U=!1,this.h=new ge}function ge(){this.i=null,this.g="",this.h=!1}b(le,st),b(de,st),b(fe,oe),fe.prototype.g=function(){return new XMLHttpRequest},fe.prototype.i=function(){return{}},ue=new fe;var pe=45e3,ye={},we={};function ve(t,e,n){t.K=1,t.v=je(Oe(e)),t.s=n,t.U=!0,Te(t,null)}function Te(t,e){t.F=Date.now(),Se(t),t.A=Oe(t.v);var n=t.A,s=t.X;Array.isArray(s)||(s=[String(s)]),en(n.h,"t",s),t.C=0,n=t.l.H,t.h=new ge,t.g=ns(t.l,n?e:null,!t.s),0<t.O&&(t.L=new jt(v(t.Ia,t,t.g),t.O)),Gt(t.V,t.g,"readystatechange",t.gb),e=t.H?O(t.H):{},t.s?(t.u||(t.u="POST"),e["Content-Type"]="application/x-www-form-urlencoded",t.g.ea(t.A,t.u,t.s,e)):(t.u="GET",t.g.ea(t.A,t.u,null,e)),Zt(1),function(t,e,n,s,r,i){t.info((function(){if(t.g)if(i)for(var o="",a=i.split("&"),c=0;c<a.length;c++){var u=a[c].split("=");if(1<u.length){var h=u[0];u=u[1];var l=h.split("_");o=2<=l.length&&"type"==l[1]?o+(h+"=")+u+"&":o+(h+"=redacted&")}}else o=null;else o=i;return"XMLHTTP REQ ("+s+") [attempt "+r+"]: "+e+"\n"+n+"\n"+o}))}(t.j,t.u,t.A,t.m,t.X,t.s)}function be(t){return!!t.g&&"GET"==t.u&&2!=t.K&&t.l.Ba}function Ie(t,e,n){let s,r=!0;for(;!t.I&&t.C<n.length;){if(s=Ee(t,n),s==we){4==e&&(t.o=4,ee(14),r=!1),Qt(t.j,t.m,null,"[Incomplete Response]");break}if(s==ye){t.o=4,ee(15),Qt(t.j,t.m,n,"[Invalid Chunk]"),r=!1;break}Qt(t.j,t.m,s,null),Ce(t,s)}be(t)&&s!=we&&s!=ye&&(t.h.g="",t.C=0),4!=e||0!=n.length||t.h.h||(t.o=1,ee(16),r=!1),t.i=t.i&&r,r?0<n.length&&!t.aa&&(t.aa=!0,(e=t.l).g==t&&e.$&&!e.L&&(e.h.info("Great, no buffering proxy detected. Bytes received: "+n.length),Qn(e),e.L=!0,ee(11))):(Qt(t.j,t.m,n,"[Invalid Chunked Response]"),De(t),ke(t))}function Ee(t,e){var n=t.C,s=e.indexOf("\n",n);return-1==s?we:(n=Number(e.substring(n,s)),isNaN(n)?ye:(s+=1)+n>e.length?we:(e=e.substr(s,n),t.C=s+n,e))}function Se(t){t.Y=Date.now()+t.P,Ae(t,t.P)}function Ae(t,e){if(null!=t.B)throw Error("WatchDog timer not null");t.B=se(v(t.eb,t),e)}function _e(t){t.B&&(l.clearTimeout(t.B),t.B=null)}function ke(t){0==t.l.G||t.I||Xn(t.l,t)}function De(t){_e(t);var e=t.L;e&&"function"==typeof e.na&&e.na(),t.L=null,qt(t.W),zt(t.V),t.g&&(e=t.g,t.g=null,e.abort(),e.na())}function Ce(t,e){try{var n=t.l;if(0!=n.G&&(n.g==t||cn(n.i,t)))if(n.I=t.N,!t.J&&cn(n.i,t)&&3==n.G){try{var s=n.Ca.g.parse(e)}catch(t){s=null}if(Array.isArray(s)&&3==s.length){var r=s;if(0==r[0]){t:if(!n.u){if(n.g){if(!(n.g.F+3e3<t.F))break t;Yn(n),qn(n)}Hn(n),ee(18)}}else n.ta=r[1],0<n.ta-n.U&&37500>r[2]&&n.N&&0==n.A&&!n.v&&(n.v=se(v(n.ab,n),6e3));if(1>=an(n.i)&&n.ka){try{n.ka()}catch(t){}n.ka=void 0}}else Zn(n,11)}else if((t.J||n.g==t)&&Yn(n),!D(e))for(r=n.Ca.g.parse(e),e=0;e<r.length;e++){let u=r[e];if(n.U=u[0],u=u[1],2==n.G)if("c"==u[0]){n.J=u[1],n.la=u[2];const e=u[3];null!=e&&(n.ma=e,n.h.info("VER="+n.ma));const r=u[4];null!=r&&(n.za=r,n.h.info("SVER="+n.za));const h=u[5];null!=h&&"number"==typeof h&&0<h&&(s=1.5*h,n.K=s,n.h.info("backChannelRequestTimeoutMs_="+s)),s=n;const l=t.g;if(l){const t=l.g?l.g.getResponseHeader("X-Client-Wire-Protocol"):null;if(t){var i=s.i;!i.g&&(x(t,"spdy")||x(t,"quic")||x(t,"h2"))&&(i.j=i.l,i.g=new Set,i.h&&(un(i,i.h),i.h=null))}if(s.D){const t=l.g?l.g.getResponseHeader("X-HTTP-Session-Id"):null;t&&(s.sa=t,Be(s.F,s.D,t))}}n.G=3,n.j&&n.j.xa(),n.$&&(n.O=Date.now()-t.F,n.h.info("Handshake RTT: "+n.O+"ms"));var o=t;if((s=n).oa=es(s,s.H?s.la:null,s.W),o.J){hn(s.i,o);var a=o,c=s.K;c&&a.setTimeout(c),a.B&&(_e(a),Se(a)),s.g=o}else zn(s);0<n.l.length&&jn(n)}else"stop"!=u[0]&&"close"!=u[0]||Zn(n,7);else 3==n.G&&("stop"==u[0]||"close"==u[0]?"stop"==u[0]?Zn(n,7):Vn(n):"noop"!=u[0]&&n.j&&n.j.wa(u),n.A=0)}Zt(4)}catch(t){}}function Ne(t,e){if(t.forEach&&"function"==typeof t.forEach)t.forEach(e,void 0);else if(f(t)||"string"==typeof t)A(t,e,void 0);else{if(t.T&&"function"==typeof t.T)var n=t.T();else if(t.R&&"function"==typeof t.R)n=void 0;else if(f(t)||"string"==typeof t){n=[];for(var s=t.length,r=0;r<s;r++)n.push(r)}else for(r in n=[],s=0,t)n[s++]=r;s=function(t){if(t.R&&"function"==typeof t.R)return t.R();if("string"==typeof t)return t.split("");if(f(t)){for(var e=[],n=t.length,s=0;s<n;s++)e.push(t[s]);return e}for(s in e=[],n=0,t)e[n++]=t[s];return e}(t),r=s.length;for(var i=0;i<r;i++)e.call(void 0,s[i],n&&n[i],t)}}function xe(t,e){this.h={},this.g=[],this.i=0;var n=arguments.length;if(1<n){if(n%2)throw Error("Uneven number of arguments");for(var s=0;s<n;s+=2)this.set(arguments[s],arguments[s+1])}else if(t)if(t instanceof xe)for(n=t.T(),s=0;s<n.length;s++)this.set(n[s],t.get(n[s]));else for(s in t)this.set(s,t[s])}function Re(t){if(t.i!=t.g.length){for(var e=0,n=0;e<t.g.length;){var s=t.g[e];Le(t.h,s)&&(t.g[n++]=s),e++}t.g.length=n}if(t.i!=t.g.length){var r={};for(n=e=0;e<t.g.length;)Le(r,s=t.g[e])||(t.g[n++]=s,r[s]=1),e++;t.g.length=n}}function Le(t,e){return Object.prototype.hasOwnProperty.call(t,e)}(s=me.prototype).setTimeout=function(t){this.P=t},s.gb=function(t){t=t.target;const e=this.L;e&&3==Ln(t)?e.l():this.Ia(t)},s.Ia=function(t){try{if(t==this.g)t:{const h=Ln(this.g);var e=this.g.Da();const d=this.g.ba();if(!(3>h)&&(3!=h||G||this.g&&(this.h.h||this.g.ga()||Mn(this.g)))){this.I||4!=h||7==e||Zt(8==e||0>=d?3:2),_e(this);var n=this.g.ba();this.N=n;e:if(be(this)){var s=Mn(this.g);t="";var r=s.length,i=4==Ln(this.g);if(!this.h.i){if("undefined"==typeof TextDecoder){De(this),ke(this);var o="";break e}this.h.i=new l.TextDecoder}for(e=0;e<r;e++)this.h.h=!0,t+=this.h.i.decode(s[e],{stream:i&&e==r-1});s.splice(0,r),this.h.g+=t,this.C=0,o=this.h.g}else o=this.g.ga();if(this.i=200==n,function(t,e,n,s,r,i,o){t.info((function(){return"XMLHTTP RESP ("+s+") [ attempt "+r+"]: "+e+"\n"+n+"\n"+i+" "+o}))}(this.j,this.u,this.A,this.m,this.X,h,n),this.i){if(this.$&&!this.J){e:{if(this.g){var a,c=this.g;if((a=c.g?c.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!D(a)){var u=a;break e}}u=null}if(!(n=u)){this.i=!1,this.o=3,ee(12),De(this),ke(this);break t}Qt(this.j,this.m,n,"Initial handshake response via X-HTTP-Initial-Response"),this.J=!0,Ce(this,n)}this.U?(Ie(this,h,o),G&&this.i&&3==h&&(Gt(this.V,this.W,"tick",this.fb),this.W.start())):(Qt(this.j,this.m,o,null),Ce(this,o)),4==h&&De(this),this.i&&!this.I&&(4==h?Xn(this.l,this):(this.i=!1,Se(this)))}else 400==n&&0<o.indexOf("Unknown SID")?(this.o=3,ee(12)):(this.o=0,ee(13)),De(this),ke(this)}}}catch(t){}},s.fb=function(){if(this.g){var t=Ln(this.g),e=this.g.ga();this.C<e.length&&(_e(this),Ie(this,t,e),this.i&&4!=t&&Se(this))}},s.cancel=function(){this.I=!0,De(this)},s.eb=function(){this.B=null;const t=Date.now();0<=t-this.Y?(function(t,e){t.info((function(){return"TIMEOUT: "+e}))}(this.j,this.A),2!=this.K&&(Zt(3),ee(17)),De(this),this.o=2,ke(this)):Ae(this,this.Y-t)},(s=xe.prototype).R=function(){Re(this);for(var t=[],e=0;e<this.g.length;e++)t.push(this.h[this.g[e]]);return t},s.T=function(){return Re(this),this.g.concat()},s.get=function(t,e){return Le(this.h,t)?this.h[t]:e},s.set=function(t,e){Le(this.h,t)||(this.i++,this.g.push(t)),this.h[t]=e},s.forEach=function(t,e){for(var n=this.T(),s=0;s<n.length;s++){var r=n[s],i=this.get(r);t.call(e,i,r,this)}};var Me=/^(?:([^:/?#.]+):)?(?:\/\/(?:([^\\/?#]*)@)?([^\\/?#]*?)(?::([0-9]+))?(?=[\\/?#]|$))?([^?#]+)?(?:\?([^#]*))?(?:#([\s\S]*))?$/;function Pe(t,e){if(this.i=this.s=this.j="",this.m=null,this.o=this.l="",this.g=!1,t instanceof Pe){this.g=void 0!==e?e:t.g,Fe(this,t.j),this.s=t.s,Ve(this,t.i),qe(this,t.m),this.l=t.l,e=t.h;var n=new Xe;n.i=e.i,e.g&&(n.g=new xe(e.g),n.h=e.h),Ue(this,n),this.o=t.o}else t&&(n=String(t).match(Me))?(this.g=!!e,Fe(this,n[1]||"",!0),this.s=Ke(n[2]||""),Ve(this,n[3]||"",!0),qe(this,n[4]),this.l=Ke(n[5]||"",!0),Ue(this,n[6]||"",!0),this.o=Ke(n[7]||"")):(this.g=!!e,this.h=new Xe(null,this.g))}function Oe(t){return new Pe(t)}function Fe(t,e,n){t.j=n?Ke(e,!0):e,t.j&&(t.j=t.j.replace(/:$/,""))}function Ve(t,e,n){t.i=n?Ke(e,!0):e}function qe(t,e){if(e){if(e=Number(e),isNaN(e)||0>e)throw Error("Bad port number "+e);t.m=e}else t.m=null}function Ue(t,e,n){e instanceof Xe?(t.h=e,function(t,e){e&&!t.j&&(Je(t),t.i=null,t.g.forEach((function(t,e){var n=e.toLowerCase();e!=n&&(Ze(this,e),en(this,n,t))}),t)),t.j=e}(t.h,t.g)):(n||(e=$e(e,We)),t.h=new Xe(e,t.g))}function Be(t,e,n){t.h.set(e,n)}function je(t){return Be(t,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),t}function Ke(t,e){return t?e?decodeURI(t.replace(/%25/g,"%2525")):decodeURIComponent(t):""}function $e(t,e,n){return"string"==typeof t?(t=encodeURI(t).replace(e,Ge),n&&(t=t.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),t):null}function Ge(t){return"%"+((t=t.charCodeAt(0))>>4&15).toString(16)+(15&t).toString(16)}Pe.prototype.toString=function(){var t=[],e=this.j;e&&t.push($e(e,ze,!0),":");var n=this.i;return(n||"file"==e)&&(t.push("//"),(e=this.s)&&t.push($e(e,ze,!0),"@"),t.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.m)&&t.push(":",String(n))),(n=this.l)&&(this.i&&"/"!=n.charAt(0)&&t.push("/"),t.push($e(n,"/"==n.charAt(0)?Qe:He,!0))),(n=this.h.toString())&&t.push("?",n),(n=this.o)&&t.push("#",$e(n,Ye)),t.join("")};var ze=/[#\/\?@]/g,He=/[#\?:]/g,Qe=/[#\?]/g,We=/[#\?@]/g,Ye=/#/g;function Xe(t,e){this.h=this.g=null,this.i=t||null,this.j=!!e}function Je(t){t.g||(t.g=new xe,t.h=0,t.i&&function(t,e){if(t){t=t.split("&");for(var n=0;n<t.length;n++){var s=t[n].indexOf("="),r=null;if(0<=s){var i=t[n].substring(0,s);r=t[n].substring(s+1)}else i=t[n];e(i,r?decodeURIComponent(r.replace(/\+/g," ")):"")}}}(t.i,(function(e,n){t.add(decodeURIComponent(e.replace(/\+/g," ")),n)})))}function Ze(t,e){Je(t),e=nn(t,e),Le(t.g.h,e)&&(t.i=null,t.h-=t.g.get(e).length,Le((t=t.g).h,e)&&(delete t.h[e],t.i--,t.g.length>2*t.i&&Re(t)))}function tn(t,e){return Je(t),e=nn(t,e),Le(t.g.h,e)}function en(t,e,n){Ze(t,e),0<n.length&&(t.i=null,t.g.set(nn(t,e),k(n)),t.h+=n.length)}function nn(t,e){return e=String(e),t.j&&(e=e.toLowerCase()),e}function sn(t){this.l=t||rn,t=l.PerformanceNavigationTiming?0<(t=l.performance.getEntriesByType("navigation")).length&&("hq"==t[0].nextHopProtocol||"h2"==t[0].nextHopProtocol):!!(l.g&&l.g.Ea&&l.g.Ea()&&l.g.Ea().Zb),this.j=t?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}(s=Xe.prototype).add=function(t,e){Je(this),this.i=null,t=nn(this,t);var n=this.g.get(t);return n||this.g.set(t,n=[]),n.push(e),this.h+=1,this},s.forEach=function(t,e){Je(this),this.g.forEach((function(n,s){A(n,(function(n){t.call(e,n,s,this)}),this)}),this)},s.T=function(){Je(this);for(var t=this.g.R(),e=this.g.T(),n=[],s=0;s<e.length;s++)for(var r=t[s],i=0;i<r.length;i++)n.push(e[s]);return n},s.R=function(t){Je(this);var e=[];if("string"==typeof t)tn(this,t)&&(e=_(e,this.g.get(nn(this,t))));else{t=this.g.R();for(var n=0;n<t.length;n++)e=_(e,t[n])}return e},s.set=function(t,e){return Je(this),this.i=null,tn(this,t=nn(this,t))&&(this.h-=this.g.get(t).length),this.g.set(t,[e]),this.h+=1,this},s.get=function(t,e){return t&&0<(t=this.R(t)).length?String(t[0]):e},s.toString=function(){if(this.i)return this.i;if(!this.g)return"";for(var t=[],e=this.g.T(),n=0;n<e.length;n++){var s=e[n],r=encodeURIComponent(String(s));s=this.R(s);for(var i=0;i<s.length;i++){var o=r;""!==s[i]&&(o+="="+encodeURIComponent(String(s[i]))),t.push(o)}}return this.i=t.join("&")};var rn=10;function on(t){return!!t.h||!!t.g&&t.g.size>=t.j}function an(t){return t.h?1:t.g?t.g.size:0}function cn(t,e){return t.h?t.h==e:!!t.g&&t.g.has(e)}function un(t,e){t.g?t.g.add(e):t.h=e}function hn(t,e){t.h&&t.h==e?t.h=null:t.g&&t.g.has(e)&&t.g.delete(e)}function ln(t){if(null!=t.h)return t.i.concat(t.h.D);if(null!=t.g&&0!==t.g.size){let e=t.i;for(const n of t.g.values())e=e.concat(n.D);return e}return k(t.i)}function dn(){}function fn(){this.g=new dn}function mn(t,e,n){const s=n||"";try{Ne(t,(function(t,n){let r=t;m(t)&&(r=Dt(t)),e.push(s+n+"="+encodeURIComponent(r))}))}catch(t){throw e.push(s+"type="+encodeURIComponent("_badmap")),t}}function gn(t,e,n,s,r){try{e.onload=null,e.onerror=null,e.onabort=null,e.ontimeout=null,r(s)}catch(t){}}function pn(t){this.l=t.$b||null,this.j=t.ib||!1}function yn(t,e){At.call(this),this.D=t,this.u=e,this.m=void 0,this.readyState=wn,this.status=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.v=new Headers,this.h=null,this.C="GET",this.B="",this.g=!1,this.A=this.j=this.l=null}sn.prototype.cancel=function(){if(this.i=ln(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&0!==this.g.size){for(const t of this.g.values())t.cancel();this.g.clear()}},dn.prototype.stringify=function(t){return l.JSON.stringify(t,void 0)},dn.prototype.parse=function(t){return l.JSON.parse(t,void 0)},b(pn,oe),pn.prototype.g=function(){return new yn(this.l,this.j)},pn.prototype.i=function(t){return function(){return t}}({}),b(yn,At);var wn=0;function vn(t){t.j.read().then(t.Sa.bind(t)).catch(t.ha.bind(t))}function Tn(t){t.readyState=4,t.l=null,t.j=null,t.A=null,bn(t)}function bn(t){t.onreadystatechange&&t.onreadystatechange.call(t)}(s=yn.prototype).open=function(t,e){if(this.readyState!=wn)throw this.abort(),Error("Error reopening a connection");this.C=t,this.B=e,this.readyState=1,bn(this)},s.send=function(t){if(1!=this.readyState)throw this.abort(),Error("need to call open() first. ");this.g=!0;const e={headers:this.v,method:this.C,credentials:this.m,cache:void 0};t&&(e.body=t),(this.D||l).fetch(new Request(this.B,e)).then(this.Va.bind(this),this.ha.bind(this))},s.abort=function(){this.response=this.responseText="",this.v=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted."),1<=this.readyState&&this.g&&4!=this.readyState&&(this.g=!1,Tn(this)),this.readyState=wn},s.Va=function(t){if(this.g&&(this.l=t,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=t.headers,this.readyState=2,bn(this)),this.g&&(this.readyState=3,bn(this),this.g)))if("arraybuffer"===this.responseType)t.arrayBuffer().then(this.Ta.bind(this),this.ha.bind(this));else if(void 0!==l.ReadableStream&&"body"in t){if(this.j=t.body.getReader(),this.u){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.A=new TextDecoder;vn(this)}else t.text().then(this.Ua.bind(this),this.ha.bind(this))},s.Sa=function(t){if(this.g){if(this.u&&t.value)this.response.push(t.value);else if(!this.u){var e=t.value?t.value:new Uint8Array(0);(e=this.A.decode(e,{stream:!t.done}))&&(this.response=this.responseText+=e)}t.done?Tn(this):bn(this),3==this.readyState&&vn(this)}},s.Ua=function(t){this.g&&(this.response=this.responseText=t,Tn(this))},s.Ta=function(t){this.g&&(this.response=t,Tn(this))},s.ha=function(){this.g&&Tn(this)},s.setRequestHeader=function(t,e){this.v.append(t,e)},s.getResponseHeader=function(t){return this.h&&this.h.get(t.toLowerCase())||""},s.getAllResponseHeaders=function(){if(!this.h)return"";const t=[],e=this.h.entries();for(var n=e.next();!n.done;)n=n.value,t.push(n[0]+": "+n[1]),n=e.next();return t.join("\r\n")},Object.defineProperty(yn.prototype,"withCredentials",{get:function(){return"include"===this.m},set:function(t){this.m=t?"include":"same-origin"}});var In=l.JSON.parse;function En(t){At.call(this),this.headers=new xe,this.u=t||null,this.h=!1,this.C=this.g=null,this.H="",this.m=0,this.j="",this.l=this.F=this.v=this.D=!1,this.B=0,this.A=null,this.J=Sn,this.K=this.L=!1}b(En,At);var Sn="",An=/^https?$/i,_n=["POST","PUT"];function kn(t){return"content-type"==t.toLowerCase()}function Dn(t,e){t.h=!1,t.g&&(t.l=!0,t.g.abort(),t.l=!1),t.j=e,t.m=5,Cn(t),xn(t)}function Cn(t){t.D||(t.D=!0,_t(t,"complete"),_t(t,"error"))}function Nn(t){if(t.h&&void 0!==h&&(!t.C[1]||4!=Ln(t)||2!=t.ba()))if(t.v&&4==Ln(t))Ut(t.Fa,0,t);else if(_t(t,"readystatechange"),4==Ln(t)){t.h=!1;try{const a=t.ba();t:switch(a){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var e=!0;break t;default:e=!1}var n;if(!(n=e)){var s;if(s=0===a){var r=String(t.H).match(Me)[1]||null;if(!r&&l.self&&l.self.location){var i=l.self.location.protocol;r=i.substr(0,i.length-1)}s=!An.test(r?r.toLowerCase():"")}n=s}if(n)_t(t,"complete"),_t(t,"success");else{t.m=6;try{var o=2<Ln(t)?t.g.statusText:""}catch(t){o=""}t.j=o+" ["+t.ba()+"]",Cn(t)}}finally{xn(t)}}}function xn(t,e){if(t.g){Rn(t);const n=t.g,s=t.C[0]?d:null;t.g=null,t.C=null,e||_t(t,"ready");try{n.onreadystatechange=s}catch(t){}}}function Rn(t){t.g&&t.K&&(t.g.ontimeout=null),t.A&&(l.clearTimeout(t.A),t.A=null)}function Ln(t){return t.g?t.g.readyState:0}function Mn(t){try{if(!t.g)return null;if("response"in t.g)return t.g.response;switch(t.J){case Sn:case"text":return t.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in t.g)return t.g.mozResponseArrayBuffer}return null}catch(t){return null}}function Pn(t,e,n){t:{for(s in n){var s=!1;break t}s=!0}s||(n=function(t){let e="";return P(t,(function(t,n){e+=n,e+=":",e+=t,e+="\r\n"})),e}(n),"string"==typeof t?null!=n&&encodeURIComponent(String(n)):Be(t,e,n))}function On(t,e,n){return n&&n.internalChannelParams&&n.internalChannelParams[t]||e}function Fn(t){this.za=0,this.l=[],this.h=new Ht,this.la=this.oa=this.F=this.W=this.g=this.sa=this.D=this.aa=this.o=this.P=this.s=null,this.Za=this.V=0,this.Xa=On("failFast",!1,t),this.N=this.v=this.u=this.m=this.j=null,this.X=!0,this.I=this.ta=this.U=-1,this.Y=this.A=this.C=0,this.Pa=On("baseRetryDelayMs",5e3,t),this.$a=On("retryDelaySeedMs",1e4,t),this.Ya=On("forwardChannelMaxRetries",2,t),this.ra=On("forwardChannelRequestTimeoutMs",2e4,t),this.qa=t&&t.xmlHttpFactory||void 0,this.Ba=t&&t.Yb||!1,this.K=void 0,this.H=t&&t.supportsCrossDomainXhr||!1,this.J="",this.i=new sn(t&&t.concurrentRequestLimit),this.Ca=new fn,this.ja=t&&t.fastHandshake||!1,this.Ra=t&&t.Wb||!1,t&&t.Aa&&this.h.Aa(),t&&t.forceLongPolling&&(this.X=!1),this.$=!this.ja&&this.X&&t&&t.detectBufferingProxy||!1,this.ka=void 0,this.O=0,this.L=!1,this.B=null,this.Wa=!t||!1!==t.Xb}function Vn(t){if(Un(t),3==t.G){var e=t.V++,n=Oe(t.F);Be(n,"SID",t.J),Be(n,"RID",e),Be(n,"TYPE","terminate"),$n(t,n),(e=new me(t,t.h,e,void 0)).K=2,e.v=je(Oe(n)),n=!1,l.navigator&&l.navigator.sendBeacon&&(n=l.navigator.sendBeacon(e.v.toString(),"")),!n&&l.Image&&((new Image).src=e.v,n=!0),n||(e.g=ns(e.l,null),e.g.ea(e.v)),e.F=Date.now(),Se(e)}ts(t)}function qn(t){t.g&&(Qn(t),t.g.cancel(),t.g=null)}function Un(t){qn(t),t.u&&(l.clearTimeout(t.u),t.u=null),Yn(t),t.i.cancel(),t.m&&("number"==typeof t.m&&l.clearTimeout(t.m),t.m=null)}function Bn(t,e){t.l.push(new class{constructor(t,e){this.h=t,this.g=e}}(t.Za++,e)),3==t.G&&jn(t)}function jn(t){on(t.i)||t.m||(t.m=!0,Mt(t.Ha,t),t.C=0)}function Kn(t,e){var n;n=e?e.m:t.V++;const s=Oe(t.F);Be(s,"SID",t.J),Be(s,"RID",n),Be(s,"AID",t.U),$n(t,s),t.o&&t.s&&Pn(s,t.o,t.s),n=new me(t,t.h,n,t.C+1),null===t.o&&(n.H=t.s),e&&(t.l=e.D.concat(t.l)),e=Gn(t,n,1e3),n.setTimeout(Math.round(.5*t.ra)+Math.round(.5*t.ra*Math.random())),un(t.i,n),ve(n,s,e)}function $n(t,e){t.j&&Ne({},(function(t,n){Be(e,n,t)}))}function Gn(t,e,n){n=Math.min(t.l.length,n);var s=t.j?v(t.j.Oa,t.j,t):null;t:{var r=t.l;let e=-1;for(;;){const t=["count="+n];-1==e?0<n?(e=r[0].h,t.push("ofs="+e)):e=0:t.push("ofs="+e);let i=!0;for(let o=0;o<n;o++){let n=r[o].h;const a=r[o].g;if(n-=e,0>n)e=Math.max(0,r[o].h-100),i=!1;else try{mn(a,t,"req"+n+"_")}catch(t){s&&s(a)}}if(i){s=t.join("&");break t}}}return t=t.l.splice(0,n),e.D=t,s}function zn(t){t.g||t.u||(t.Y=1,Mt(t.Ga,t),t.A=0)}function Hn(t){return!(t.g||t.u||3<=t.A||(t.Y++,t.u=se(v(t.Ga,t),Jn(t,t.A)),t.A++,0))}function Qn(t){null!=t.B&&(l.clearTimeout(t.B),t.B=null)}function Wn(t){t.g=new me(t,t.h,"rpc",t.Y),null===t.o&&(t.g.H=t.s),t.g.O=0;var e=Oe(t.oa);Be(e,"RID","rpc"),Be(e,"SID",t.J),Be(e,"CI",t.N?"0":"1"),Be(e,"AID",t.U),$n(t,e),Be(e,"TYPE","xmlhttp"),t.o&&t.s&&Pn(e,t.o,t.s),t.K&&t.g.setTimeout(t.K);var n=t.g;t=t.la,n.K=1,n.v=je(Oe(e)),n.s=null,n.U=!0,Te(n,t)}function Yn(t){null!=t.v&&(l.clearTimeout(t.v),t.v=null)}function Xn(t,e){var n=null;if(t.g==e){Yn(t),Qn(t),t.g=null;var s=2}else{if(!cn(t.i,e))return;n=e.D,hn(t.i,e),s=1}if(t.I=e.N,0!=t.G)if(e.i)if(1==s){n=e.s?e.s.length:0,e=Date.now()-e.F;var r=t.C;_t(s=Xt(),new ne(s,n,e,r)),jn(t)}else zn(t);else if(3==(r=e.o)||0==r&&0<t.I||!(1==s&&function(t,e){return!(an(t.i)>=t.i.j-(t.m?1:0)||(t.m?(t.l=e.D.concat(t.l),0):1==t.G||2==t.G||t.C>=(t.Xa?0:t.Ya)||(t.m=se(v(t.Ha,t,e),Jn(t,t.C)),t.C++,0)))}(t,e)||2==s&&Hn(t)))switch(n&&0<n.length&&(e=t.i,e.i=e.i.concat(n)),r){case 1:Zn(t,5);break;case 4:Zn(t,10);break;case 3:Zn(t,6);break;default:Zn(t,2)}}function Jn(t,e){let n=t.Pa+Math.floor(Math.random()*t.$a);return t.j||(n*=2),n*e}function Zn(t,e){if(t.h.info("Error code "+e),2==e){var n=null;t.j&&(n=null);var s=v(t.jb,t);n||(n=new Pe("//www.google.com/images/cleardot.gif"),l.location&&"http"==l.location.protocol||Fe(n,"https"),je(n)),function(t,e){const n=new Ht;if(l.Image){const s=new Image;s.onload=T(gn,n,s,"TestLoadImage: loaded",!0,e),s.onerror=T(gn,n,s,"TestLoadImage: error",!1,e),s.onabort=T(gn,n,s,"TestLoadImage: abort",!1,e),s.ontimeout=T(gn,n,s,"TestLoadImage: timeout",!1,e),l.setTimeout((function(){s.ontimeout&&s.ontimeout()}),1e4),s.src=t}else e(!1)}(n.toString(),s)}else ee(2);t.G=0,t.j&&t.j.va(e),ts(t),Un(t)}function ts(t){t.G=0,t.I=-1,t.j&&(0==ln(t.i).length&&0==t.l.length||(t.i.i.length=0,k(t.l),t.l.length=0),t.j.ua())}function es(t,e,n){let s=function(t){return t instanceof Pe?Oe(t):new Pe(t,void 0)}(n);if(""!=s.i)e&&Ve(s,e+"."+s.i),qe(s,s.m);else{const t=l.location;s=function(t,e,n,s){var r=new Pe(null,void 0);return t&&Fe(r,t),e&&Ve(r,e),n&&qe(r,n),s&&(r.l=s),r}(t.protocol,e?e+"."+t.hostname:t.hostname,+t.port,n)}return t.aa&&P(t.aa,(function(t,e){Be(s,e,t)})),e=t.D,n=t.sa,e&&n&&Be(s,e,n),Be(s,"VER",t.ma),$n(t,s),s}function ns(t,e,n){if(e&&!t.H)throw Error("Can't create secondary domain capable XhrIo object.");return(e=n&&t.Ba&&!t.qa?new En(new pn({ib:!0})):new En(t.qa)).L=t.H,e}function ss(){}function rs(){if(K&&!(10<=Number(et)))throw Error("Environmental error: no available transport.")}function is(t,e){At.call(this),this.g=new Fn(e),this.l=t,this.h=e&&e.messageUrlParams||null,t=e&&e.messageHeaders||null,e&&e.clientProtocolHeaderRequired&&(t?t["X-Client-Protocol"]="webchannel":t={"X-Client-Protocol":"webchannel"}),this.g.s=t,t=e&&e.initMessageHeaders||null,e&&e.messageContentType&&(t?t["X-WebChannel-Content-Type"]=e.messageContentType:t={"X-WebChannel-Content-Type":e.messageContentType}),e&&e.ya&&(t?t["X-WebChannel-Client-Profile"]=e.ya:t={"X-WebChannel-Client-Profile":e.ya}),this.g.P=t,(t=e&&e.httpHeadersOverwriteParam)&&!D(t)&&(this.g.o=t),this.A=e&&e.supportsCrossDomainXhr||!1,this.v=e&&e.sendRawJson||!1,(e=e&&e.httpSessionIdParam)&&!D(e)&&(this.g.D=e,null!==(t=this.h)&&e in t&&e in(t=this.h)&&delete t[e]),this.j=new cs(this)}function os(t){le.call(this);var e=t.__sm__;if(e){t:{for(const n in e){t=n;break t}t=void 0}(this.i=t)&&(t=this.i,e=null!==e&&t in e?e[t]:void 0),this.data=e}else this.data=t}function as(){de.call(this),this.status=1}function cs(t){this.g=t}(s=En.prototype).ea=function(t,e,n,s){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.H+"; newUri="+t);e=e?e.toUpperCase():"GET",this.H=t,this.j="",this.m=0,this.D=!1,this.h=!0,this.g=this.u?this.u.g():ue.g(),this.C=this.u?ae(this.u):ae(ue),this.g.onreadystatechange=v(this.Fa,this);try{this.F=!0,this.g.open(e,String(t),!0),this.F=!1}catch(t){return void Dn(this,t)}t=n||"";const r=new xe(this.headers);s&&Ne(s,(function(t,e){r.set(e,t)})),s=function(t){t:{var e=kn;const n=t.length,s="string"==typeof t?t.split(""):t;for(let r=0;r<n;r++)if(r in s&&e.call(void 0,s[r],r,t)){e=r;break t}e=-1}return 0>e?null:"string"==typeof t?t.charAt(e):t[e]}(r.T()),n=l.FormData&&t instanceof l.FormData,!(0<=S(_n,e))||s||n||r.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8"),r.forEach((function(t,e){this.g.setRequestHeader(e,t)}),this),this.J&&(this.g.responseType=this.J),"withCredentials"in this.g&&this.g.withCredentials!==this.L&&(this.g.withCredentials=this.L);try{Rn(this),0<this.B&&((this.K=function(t){return K&&tt()&&"number"==typeof t.timeout&&void 0!==t.ontimeout}(this.g))?(this.g.timeout=this.B,this.g.ontimeout=v(this.pa,this)):this.A=Ut(this.pa,this.B,this)),this.v=!0,this.g.send(t),this.v=!1}catch(t){Dn(this,t)}},s.pa=function(){void 0!==h&&this.g&&(this.j="Timed out after "+this.B+"ms, aborting",this.m=8,_t(this,"timeout"),this.abort(8))},s.abort=function(t){this.g&&this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1,this.m=t||7,_t(this,"complete"),_t(this,"abort"),xn(this))},s.M=function(){this.g&&(this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1),xn(this,!0)),En.Z.M.call(this)},s.Fa=function(){this.s||(this.F||this.v||this.l?Nn(this):this.cb())},s.cb=function(){Nn(this)},s.ba=function(){try{return 2<Ln(this)?this.g.status:-1}catch(t){return-1}},s.ga=function(){try{return this.g?this.g.responseText:""}catch(t){return""}},s.Qa=function(t){if(this.g){var e=this.g.responseText;return t&&0==e.indexOf(t)&&(e=e.substring(t.length)),In(e)}},s.Da=function(){return this.m},s.La=function(){return"string"==typeof this.j?this.j:String(this.j)},(s=Fn.prototype).ma=8,s.G=1,s.hb=function(t){try{this.h.info("Origin Trials invoked: "+t)}catch(t){}},s.Ha=function(t){if(this.m)if(this.m=null,1==this.G){if(!t){this.V=Math.floor(1e5*Math.random()),t=this.V++;const r=new me(this,this.h,t,void 0);let i=this.s;if(this.P&&(i?(i=O(i),V(i,this.P)):i=this.P),null===this.o&&(r.H=i),this.ja)t:{for(var e=0,n=0;n<this.l.length;n++){var s=this.l[n];if(void 0===(s="__data__"in s.g&&"string"==typeof(s=s.g.__data__)?s.length:void 0))break;if(4096<(e+=s)){e=n;break t}if(4096===e||n===this.l.length-1){e=n+1;break t}}e=1e3}else e=1e3;e=Gn(this,r,e),Be(n=Oe(this.F),"RID",t),Be(n,"CVER",22),this.D&&Be(n,"X-HTTP-Session-Id",this.D),$n(this,n),this.o&&i&&Pn(n,this.o,i),un(this.i,r),this.Ra&&Be(n,"TYPE","init"),this.ja?(Be(n,"$req",e),Be(n,"SID","null"),r.$=!0,ve(r,n,null)):ve(r,n,e),this.G=2}}else 3==this.G&&(t?Kn(this,t):0==this.l.length||on(this.i)||Kn(this))},s.Ga=function(){if(this.u=null,Wn(this),this.$&&!(this.L||null==this.g||0>=this.O)){var t=2*this.O;this.h.info("BP detection timer enabled: "+t),this.B=se(v(this.bb,this),t)}},s.bb=function(){this.B&&(this.B=null,this.h.info("BP detection timeout reached."),this.h.info("Buffering proxy detected and switch to long-polling!"),this.N=!1,this.L=!0,ee(10),qn(this),Wn(this))},s.ab=function(){null!=this.v&&(this.v=null,qn(this),Hn(this),ee(19))},s.jb=function(t){t?(this.h.info("Successfully pinged google.com"),ee(2)):(this.h.info("Failed to ping google.com"),ee(1))},(s=ss.prototype).xa=function(){},s.wa=function(){},s.va=function(){},s.ua=function(){},s.Oa=function(){},rs.prototype.g=function(t,e){return new is(t,e)},b(is,At),is.prototype.m=function(){this.g.j=this.j,this.A&&(this.g.H=!0);var t=this.g,e=this.l,n=this.h||void 0;t.Wa&&(t.h.info("Origin Trials enabled."),Mt(v(t.hb,t,e))),ee(0),t.W=e,t.aa=n||{},t.N=t.X,t.F=es(t,null,t.W),jn(t)},is.prototype.close=function(){Vn(this.g)},is.prototype.u=function(t){if("string"==typeof t){var e={};e.__data__=t,Bn(this.g,e)}else this.v?((e={}).__data__=Dt(t),Bn(this.g,e)):Bn(this.g,t)},is.prototype.M=function(){this.g.j=null,delete this.j,Vn(this.g),delete this.g,is.Z.M.call(this)},b(os,le),b(as,de),b(cs,ss),cs.prototype.xa=function(){_t(this.g,"a")},cs.prototype.wa=function(t){_t(this.g,new os(t))},cs.prototype.va=function(t){_t(this.g,new as(t))},cs.prototype.ua=function(){_t(this.g,"b")},rs.prototype.createWebChannel=rs.prototype.g,is.prototype.send=is.prototype.u,is.prototype.open=is.prototype.m,is.prototype.close=is.prototype.close,re.NO_ERROR=0,re.TIMEOUT=8,re.HTTP_ERROR=6,ie.COMPLETE="complete",ce.EventType=he,he.OPEN="a",he.CLOSE="b",he.ERROR="c",he.MESSAGE="d",At.prototype.listen=At.prototype.N,En.prototype.listenOnce=En.prototype.O,En.prototype.getLastError=En.prototype.La,En.prototype.getLastErrorCode=En.prototype.Da,En.prototype.getStatus=En.prototype.ba,En.prototype.getResponseJson=En.prototype.Qa,En.prototype.getResponseText=En.prototype.ga,En.prototype.send=En.prototype.ea;var us=u.createWebChannelTransport=function(){return new rs},hs=u.getStatEventTarget=function(){return Xt()},ls=u.ErrorCode=re,ds=u.EventType=ie,fs=u.Event=Wt,ms=u.Stat={rb:0,ub:1,vb:2,Ob:3,Tb:4,Qb:5,Rb:6,Pb:7,Nb:8,Sb:9,PROXY:10,NOPROXY:11,Lb:12,Hb:13,Ib:14,Gb:15,Jb:16,Kb:17,nb:18,mb:19,ob:20},gs=u.FetchXmlHttpFactory=pn,ps=u.WebChannel=ce,ys=u.XhrIo=En;const ws="@firebase/firestore";class vs{constructor(t){this.uid=t}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(t){return t.uid===this.uid}}vs.UNAUTHENTICATED=new vs(null),vs.GOOGLE_CREDENTIALS=new vs("google-credentials-uid"),vs.FIRST_PARTY=new vs("first-party-uid"),vs.MOCK_USER=new vs("mock-user");let Ts="9.6.3";const bs=new o.Yd("@firebase/firestore");function Is(){return bs.logLevel}function Es(t){bs.setLogLevel(t)}function Ss(t,...e){if(bs.logLevel<=o.in.DEBUG){const n=e.map(ks);bs.debug(`Firestore (${Ts}): ${t}`,...n)}}function As(t,...e){if(bs.logLevel<=o.in.ERROR){const n=e.map(ks);bs.error(`Firestore (${Ts}): ${t}`,...n)}}function _s(t,...e){if(bs.logLevel<=o.in.WARN){const n=e.map(ks);bs.warn(`Firestore (${Ts}): ${t}`,...n)}}function ks(t){if("string"==typeof t)return t;try{return e=t,JSON.stringify(e)}catch(e){return t}var e}function Ds(t="Unexpected state"){const e=`FIRESTORE (${Ts}) INTERNAL ASSERTION FAILED: `+t;throw As(e),new Error(e)}function Cs(t,e){t||Ds()}function Ns(t,e){t||Ds()}function xs(t,e){return t}const Rs={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class Ls extends a.ZR{constructor(t,e){super(t,e),this.code=t,this.message=e,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class Ms{constructor(){this.promise=new Promise(((t,e)=>{this.resolve=t,this.reject=e}))}}class Ps{constructor(t,e){this.user=e,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${t}`)}}class Os{getToken(){return Promise.resolve(null)}invalidateToken(){}start(t,e){t.enqueueRetryable((()=>e(vs.UNAUTHENTICATED)))}shutdown(){}}class Fs{constructor(t){this.token=t,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(t,e){this.changeListener=e,t.enqueueRetryable((()=>e(this.token.user)))}shutdown(){this.changeListener=null}}class Vs{constructor(t){this.t=t,this.currentUser=vs.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(t,e){let n=this.i;const s=t=>this.i!==n?(n=this.i,e(t)):Promise.resolve();let r=new Ms;this.o=()=>{this.i++,this.currentUser=this.u(),r.resolve(),r=new Ms,t.enqueueRetryable((()=>s(this.currentUser)))};const i=()=>{const e=r;t.enqueueRetryable((async()=>{await e.promise,await s(this.currentUser)}))},o=t=>{Ss("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=t,this.auth.addAuthTokenListener(this.o),i()};this.t.onInit((t=>o(t))),setTimeout((()=>{if(!this.auth){const t=this.t.getImmediate({optional:!0});t?o(t):(Ss("FirebaseAuthCredentialsProvider","Auth not yet detected"),r.resolve(),r=new Ms)}}),0),i()}getToken(){const t=this.i,e=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(e).then((e=>this.i!==t?(Ss("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):e?(Cs("string"==typeof e.accessToken),new Ps(e.accessToken,this.currentUser)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){const t=this.auth&&this.auth.getUid();return Cs(null===t||"string"==typeof t),new vs(t)}}class qs{constructor(t,e,n){this.type="FirstParty",this.user=vs.FIRST_PARTY,this.headers=new Map,this.headers.set("X-Goog-AuthUser",e);const s=t.auth.getAuthHeaderValueForFirstParty([]);s&&this.headers.set("Authorization",s),n&&this.headers.set("X-Goog-Iam-Authorization-Token",n)}}class Us{constructor(t,e,n){this.h=t,this.l=e,this.m=n}getToken(){return Promise.resolve(new qs(this.h,this.l,this.m))}start(t,e){t.enqueueRetryable((()=>e(vs.FIRST_PARTY)))}shutdown(){}invalidateToken(){}}class Bs{constructor(t){this.value=t,this.type="AppCheck",this.headers=new Map,t&&t.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class js{constructor(t){this.g=t,this.forceRefresh=!1,this.appCheck=null}start(t,e){this.o=n=>{t.enqueueRetryable((()=>(t=>(null!=t.error&&Ss("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${t.error.message}`),e(t.token)))(n)))};const n=t=>{Ss("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=t,this.appCheck.addTokenListener(this.o)};this.g.onInit((t=>n(t))),setTimeout((()=>{if(!this.appCheck){const t=this.g.getImmediate({optional:!0});t?n(t):Ss("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}}),0)}getToken(){const t=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(t).then((t=>t?(Cs("string"==typeof t.token),new Bs(t.token)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}class Ks{getToken(){return Promise.resolve(new Bs(""))}invalidateToken(){}start(t,e){}shutdown(){}}class $s{constructor(t,e){this.previousValue=t,e&&(e.sequenceNumberHandler=t=>this.p(t),this.T=t=>e.writeSequenceNumber(t))}p(t){return this.previousValue=Math.max(t,this.previousValue),this.previousValue}next(){const t=++this.previousValue;return this.T&&this.T(t),t}}function Gs(t){const e="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(t);if(e&&"function"==typeof e.getRandomValues)e.getRandomValues(n);else for(let e=0;e<t;e++)n[e]=Math.floor(256*Math.random());return n}$s.I=-1;class zs{static A(){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e=Math.floor(256/t.length)*t.length;let n="";for(;n.length<20;){const s=Gs(40);for(let r=0;r<s.length;++r)n.length<20&&s[r]<e&&(n+=t.charAt(s[r]%t.length))}return n}}function Hs(t,e){return t<e?-1:t>e?1:0}function Qs(t,e,n){return t.length===e.length&&t.every(((t,s)=>n(t,e[s])))}function Ws(t){return t+"\0"}class Ys{constructor(t,e){if(this.seconds=t,this.nanoseconds=e,e<0)throw new Ls(Rs.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(e>=1e9)throw new Ls(Rs.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(t<-62135596800)throw new Ls(Rs.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t);if(t>=253402300800)throw new Ls(Rs.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t)}static now(){return Ys.fromMillis(Date.now())}static fromDate(t){return Ys.fromMillis(t.getTime())}static fromMillis(t){const e=Math.floor(t/1e3),n=Math.floor(1e6*(t-1e3*e));return new Ys(e,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(t){return this.seconds===t.seconds?Hs(this.nanoseconds,t.nanoseconds):Hs(this.seconds,t.seconds)}isEqual(t){return t.seconds===this.seconds&&t.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){const t=this.seconds- -62135596800;return String(t).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class Xs{constructor(t){this.timestamp=t}static fromTimestamp(t){return new Xs(t)}static min(){return new Xs(new Ys(0,0))}compareTo(t){return this.timestamp._compareTo(t.timestamp)}isEqual(t){return this.timestamp.isEqual(t.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}function Js(t){let e=0;for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e++;return e}function Zs(t,e){for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e(n,t[n])}function tr(t){for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e))return!1;return!0}class er{constructor(t,e,n){void 0===e?e=0:e>t.length&&Ds(),void 0===n?n=t.length-e:n>t.length-e&&Ds(),this.segments=t,this.offset=e,this.len=n}get length(){return this.len}isEqual(t){return 0===er.comparator(this,t)}child(t){const e=this.segments.slice(this.offset,this.limit());return t instanceof er?t.forEach((t=>{e.push(t)})):e.push(t),this.construct(e)}limit(){return this.offset+this.length}popFirst(t){return t=void 0===t?1:t,this.construct(this.segments,this.offset+t,this.length-t)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(t){return this.segments[this.offset+t]}isEmpty(){return 0===this.length}isPrefixOf(t){if(t.length<this.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}isImmediateParentOf(t){if(this.length+1!==t.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}forEach(t){for(let e=this.offset,n=this.limit();e<n;e++)t(this.segments[e])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(t,e){const n=Math.min(t.length,e.length);for(let s=0;s<n;s++){const n=t.get(s),r=e.get(s);if(n<r)return-1;if(n>r)return 1}return t.length<e.length?-1:t.length>e.length?1:0}}class nr extends er{construct(t,e,n){return new nr(t,e,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}static fromString(...t){const e=[];for(const n of t){if(n.indexOf("//")>=0)throw new Ls(Rs.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);e.push(...n.split("/").filter((t=>t.length>0)))}return new nr(e)}static emptyPath(){return new nr([])}}const sr=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class rr extends er{construct(t,e,n){return new rr(t,e,n)}static isValidIdentifier(t){return sr.test(t)}canonicalString(){return this.toArray().map((t=>(t=t.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),rr.isValidIdentifier(t)||(t="`"+t+"`"),t))).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new rr(["__name__"])}static fromServerFormat(t){const e=[];let n="",s=0;const r=()=>{if(0===n.length)throw new Ls(Rs.INVALID_ARGUMENT,`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);e.push(n),n=""};let i=!1;for(;s<t.length;){const e=t[s];if("\\"===e){if(s+1===t.length)throw new Ls(Rs.INVALID_ARGUMENT,"Path has trailing escape character: "+t);const e=t[s+1];if("\\"!==e&&"."!==e&&"`"!==e)throw new Ls(Rs.INVALID_ARGUMENT,"Path has invalid escape sequence: "+t);n+=e,s+=2}else"`"===e?(i=!i,s++):"."!==e||i?(n+=e,s++):(r(),s++)}if(r(),i)throw new Ls(Rs.INVALID_ARGUMENT,"Unterminated ` in path: "+t);return new rr(e)}static emptyPath(){return new rr([])}}class ir{constructor(t){this.fields=t,t.sort(rr.comparator)}covers(t){for(const e of this.fields)if(e.isPrefixOf(t))return!0;return!1}isEqual(t){return Qs(this.fields,t.fields,((t,e)=>t.isEqual(e)))}}function or(){return"undefined"!=typeof atob}class ar{constructor(t){this.binaryString=t}static fromBase64String(t){const e=atob(t);return new ar(e)}static fromUint8Array(t){const e=function(t){let e="";for(let n=0;n<t.length;++n)e+=String.fromCharCode(t[n]);return e}(t);return new ar(e)}[Symbol.iterator](){let t=0;return{next:()=>t<this.binaryString.length?{value:this.binaryString.charCodeAt(t++),done:!1}:{value:void 0,done:!0}}}toBase64(){return t=this.binaryString,btoa(t);var t}toUint8Array(){return function(t){const e=new Uint8Array(t.length);for(let n=0;n<t.length;n++)e[n]=t.charCodeAt(n);return e}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(t){return Hs(this.binaryString,t.binaryString)}isEqual(t){return this.binaryString===t.binaryString}}ar.EMPTY_BYTE_STRING=new ar("");const cr=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function ur(t){if(Cs(!!t),"string"==typeof t){let e=0;const n=cr.exec(t);if(Cs(!!n),n[1]){let t=n[1];t=(t+"000000000").substr(0,9),e=Number(t)}const s=new Date(t);return{seconds:Math.floor(s.getTime()/1e3),nanos:e}}return{seconds:hr(t.seconds),nanos:hr(t.nanos)}}function hr(t){return"number"==typeof t?t:"string"==typeof t?Number(t):0}function lr(t){return"string"==typeof t?ar.fromBase64String(t):ar.fromUint8Array(t)}function dr(t){var e,n;return"server_timestamp"===(null===(n=((null===(e=null==t?void 0:t.mapValue)||void 0===e?void 0:e.fields)||{}).__type__)||void 0===n?void 0:n.stringValue)}function fr(t){const e=t.mapValue.fields.__previous_value__;return dr(e)?fr(e):e}function mr(t){const e=ur(t.mapValue.fields.__local_write_time__.timestampValue);return new Ys(e.seconds,e.nanos)}function gr(t){return null==t}function pr(t){return 0===t&&1/t==-1/0}function yr(t){return"number"==typeof t&&Number.isInteger(t)&&!pr(t)&&t<=Number.MAX_SAFE_INTEGER&&t>=Number.MIN_SAFE_INTEGER}class wr{constructor(t){this.path=t}static fromPath(t){return new wr(nr.fromString(t))}static fromName(t){return new wr(nr.fromString(t).popFirst(5))}hasCollectionId(t){return this.path.length>=2&&this.path.get(this.path.length-2)===t}isEqual(t){return null!==t&&0===nr.comparator(this.path,t.path)}toString(){return this.path.toString()}static comparator(t,e){return nr.comparator(t.path,e.path)}static isDocumentKey(t){return t.length%2==0}static fromSegments(t){return new wr(new nr(t.slice()))}}function vr(t){return"nullValue"in t?0:"booleanValue"in t?1:"integerValue"in t||"doubleValue"in t?2:"timestampValue"in t?3:"stringValue"in t?5:"bytesValue"in t?6:"referenceValue"in t?7:"geoPointValue"in t?8:"arrayValue"in t?9:"mapValue"in t?dr(t)?4:10:Ds()}function Tr(t,e){if(t===e)return!0;const n=vr(t);if(n!==vr(e))return!1;switch(n){case 0:return!0;case 1:return t.booleanValue===e.booleanValue;case 4:return mr(t).isEqual(mr(e));case 3:return function(t,e){if("string"==typeof t.timestampValue&&"string"==typeof e.timestampValue&&t.timestampValue.length===e.timestampValue.length)return t.timestampValue===e.timestampValue;const n=ur(t.timestampValue),s=ur(e.timestampValue);return n.seconds===s.seconds&&n.nanos===s.nanos}(t,e);case 5:return t.stringValue===e.stringValue;case 6:return function(t,e){return lr(t.bytesValue).isEqual(lr(e.bytesValue))}(t,e);case 7:return t.referenceValue===e.referenceValue;case 8:return function(t,e){return hr(t.geoPointValue.latitude)===hr(e.geoPointValue.latitude)&&hr(t.geoPointValue.longitude)===hr(e.geoPointValue.longitude)}(t,e);case 2:return function(t,e){if("integerValue"in t&&"integerValue"in e)return hr(t.integerValue)===hr(e.integerValue);if("doubleValue"in t&&"doubleValue"in e){const n=hr(t.doubleValue),s=hr(e.doubleValue);return n===s?pr(n)===pr(s):isNaN(n)&&isNaN(s)}return!1}(t,e);case 9:return Qs(t.arrayValue.values||[],e.arrayValue.values||[],Tr);case 10:return function(t,e){const n=t.mapValue.fields||{},s=e.mapValue.fields||{};if(Js(n)!==Js(s))return!1;for(const t in n)if(n.hasOwnProperty(t)&&(void 0===s[t]||!Tr(n[t],s[t])))return!1;return!0}(t,e);default:return Ds()}}function br(t,e){return void 0!==(t.values||[]).find((t=>Tr(t,e)))}function Ir(t,e){if(t===e)return 0;const n=vr(t),s=vr(e);if(n!==s)return Hs(n,s);switch(n){case 0:return 0;case 1:return Hs(t.booleanValue,e.booleanValue);case 2:return function(t,e){const n=hr(t.integerValue||t.doubleValue),s=hr(e.integerValue||e.doubleValue);return n<s?-1:n>s?1:n===s?0:isNaN(n)?isNaN(s)?0:-1:1}(t,e);case 3:return Er(t.timestampValue,e.timestampValue);case 4:return Er(mr(t),mr(e));case 5:return Hs(t.stringValue,e.stringValue);case 6:return function(t,e){const n=lr(t),s=lr(e);return n.compareTo(s)}(t.bytesValue,e.bytesValue);case 7:return function(t,e){const n=t.split("/"),s=e.split("/");for(let t=0;t<n.length&&t<s.length;t++){const e=Hs(n[t],s[t]);if(0!==e)return e}return Hs(n.length,s.length)}(t.referenceValue,e.referenceValue);case 8:return function(t,e){const n=Hs(hr(t.latitude),hr(e.latitude));return 0!==n?n:Hs(hr(t.longitude),hr(e.longitude))}(t.geoPointValue,e.geoPointValue);case 9:return function(t,e){const n=t.values||[],s=e.values||[];for(let t=0;t<n.length&&t<s.length;++t){const e=Ir(n[t],s[t]);if(e)return e}return Hs(n.length,s.length)}(t.arrayValue,e.arrayValue);case 10:return function(t,e){const n=t.fields||{},s=Object.keys(n),r=e.fields||{},i=Object.keys(r);s.sort(),i.sort();for(let t=0;t<s.length&&t<i.length;++t){const e=Hs(s[t],i[t]);if(0!==e)return e;const o=Ir(n[s[t]],r[i[t]]);if(0!==o)return o}return Hs(s.length,i.length)}(t.mapValue,e.mapValue);default:throw Ds()}}function Er(t,e){if("string"==typeof t&&"string"==typeof e&&t.length===e.length)return Hs(t,e);const n=ur(t),s=ur(e),r=Hs(n.seconds,s.seconds);return 0!==r?r:Hs(n.nanos,s.nanos)}function Sr(t){return Ar(t)}function Ar(t){return"nullValue"in t?"null":"booleanValue"in t?""+t.booleanValue:"integerValue"in t?""+t.integerValue:"doubleValue"in t?""+t.doubleValue:"timestampValue"in t?function(t){const e=ur(t);return`time(${e.seconds},${e.nanos})`}(t.timestampValue):"stringValue"in t?t.stringValue:"bytesValue"in t?lr(t.bytesValue).toBase64():"referenceValue"in t?(n=t.referenceValue,wr.fromName(n).toString()):"geoPointValue"in t?`geo(${(e=t.geoPointValue).latitude},${e.longitude})`:"arrayValue"in t?function(t){let e="[",n=!0;for(const s of t.values||[])n?n=!1:e+=",",e+=Ar(s);return e+"]"}(t.arrayValue):"mapValue"in t?function(t){const e=Object.keys(t.fields||{}).sort();let n="{",s=!0;for(const r of e)s?s=!1:n+=",",n+=`${r}:${Ar(t.fields[r])}`;return n+"}"}(t.mapValue):Ds();var e,n}function _r(t,e){return{referenceValue:`projects/${t.projectId}/databases/${t.database}/documents/${e.path.canonicalString()}`}}function kr(t){return!!t&&"integerValue"in t}function Dr(t){return!!t&&"arrayValue"in t}function Cr(t){return!!t&&"nullValue"in t}function Nr(t){return!!t&&"doubleValue"in t&&isNaN(Number(t.doubleValue))}function xr(t){return!!t&&"mapValue"in t}function Rr(t){if(t.geoPointValue)return{geoPointValue:Object.assign({},t.geoPointValue)};if(t.timestampValue&&"object"==typeof t.timestampValue)return{timestampValue:Object.assign({},t.timestampValue)};if(t.mapValue){const e={mapValue:{fields:{}}};return Zs(t.mapValue.fields,((t,n)=>e.mapValue.fields[t]=Rr(n))),e}if(t.arrayValue){const e={arrayValue:{values:[]}};for(let n=0;n<(t.arrayValue.values||[]).length;++n)e.arrayValue.values[n]=Rr(t.arrayValue.values[n]);return e}return Object.assign({},t)}class Lr{constructor(t){this.value=t}static empty(){return new Lr({mapValue:{}})}field(t){if(t.isEmpty())return this.value;{let e=this.value;for(let n=0;n<t.length-1;++n)if(e=(e.mapValue.fields||{})[t.get(n)],!xr(e))return null;return e=(e.mapValue.fields||{})[t.lastSegment()],e||null}}set(t,e){this.getFieldsMap(t.popLast())[t.lastSegment()]=Rr(e)}setAll(t){let e=rr.emptyPath(),n={},s=[];t.forEach(((t,r)=>{if(!e.isImmediateParentOf(r)){const t=this.getFieldsMap(e);this.applyChanges(t,n,s),n={},s=[],e=r.popLast()}t?n[r.lastSegment()]=Rr(t):s.push(r.lastSegment())}));const r=this.getFieldsMap(e);this.applyChanges(r,n,s)}delete(t){const e=this.field(t.popLast());xr(e)&&e.mapValue.fields&&delete e.mapValue.fields[t.lastSegment()]}isEqual(t){return Tr(this.value,t.value)}getFieldsMap(t){let e=this.value;e.mapValue.fields||(e.mapValue={fields:{}});for(let n=0;n<t.length;++n){let s=e.mapValue.fields[t.get(n)];xr(s)&&s.mapValue.fields||(s={mapValue:{fields:{}}},e.mapValue.fields[t.get(n)]=s),e=s}return e.mapValue.fields}applyChanges(t,e,n){Zs(e,((e,n)=>t[e]=n));for(const e of n)delete t[e]}clone(){return new Lr(Rr(this.value))}}function Mr(t){const e=[];return Zs(t.fields,((t,n)=>{const s=new rr([t]);if(xr(n)){const t=Mr(n.mapValue).fields;if(0===t.length)e.push(s);else for(const n of t)e.push(s.child(n))}else e.push(s)})),new ir(e)}class Pr{constructor(t,e,n,s,r){this.key=t,this.documentType=e,this.version=n,this.data=s,this.documentState=r}static newInvalidDocument(t){return new Pr(t,0,Xs.min(),Lr.empty(),0)}static newFoundDocument(t,e,n){return new Pr(t,1,e,n,0)}static newNoDocument(t,e){return new Pr(t,2,e,Lr.empty(),0)}static newUnknownDocument(t,e){return new Pr(t,3,e,Lr.empty(),2)}convertToFoundDocument(t,e){return this.version=t,this.documentType=1,this.data=e,this.documentState=0,this}convertToNoDocument(t){return this.version=t,this.documentType=2,this.data=Lr.empty(),this.documentState=0,this}convertToUnknownDocument(t){return this.version=t,this.documentType=3,this.data=Lr.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(t){return t instanceof Pr&&this.key.isEqual(t.key)&&this.version.isEqual(t.version)&&this.documentType===t.documentType&&this.documentState===t.documentState&&this.data.isEqual(t.data)}mutableCopy(){return new Pr(this.key,this.documentType,this.version,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class Or{constructor(t,e=null,n=[],s=[],r=null,i=null,o=null){this.path=t,this.collectionGroup=e,this.orderBy=n,this.filters=s,this.limit=r,this.startAt=i,this.endAt=o,this.R=null}}function Fr(t,e=null,n=[],s=[],r=null,i=null,o=null){return new Or(t,e,n,s,r,i,o)}function Vr(t){const e=xs(t);if(null===e.R){let t=e.path.canonicalString();null!==e.collectionGroup&&(t+="|cg:"+e.collectionGroup),t+="|f:",t+=e.filters.map((t=>function(t){return t.field.canonicalString()+t.op.toString()+Sr(t.value)}(t))).join(","),t+="|ob:",t+=e.orderBy.map((t=>function(t){return t.field.canonicalString()+t.dir}(t))).join(","),gr(e.limit)||(t+="|l:",t+=e.limit),e.startAt&&(t+="|lb:",t+=Xr(e.startAt)),e.endAt&&(t+="|ub:",t+=Xr(e.endAt)),e.R=t}return e.R}function qr(t,e){if(t.limit!==e.limit)return!1;if(t.orderBy.length!==e.orderBy.length)return!1;for(let n=0;n<t.orderBy.length;n++)if(!Zr(t.orderBy[n],e.orderBy[n]))return!1;if(t.filters.length!==e.filters.length)return!1;for(let r=0;r<t.filters.length;r++)if(n=t.filters[r],s=e.filters[r],n.op!==s.op||!n.field.isEqual(s.field)||!Tr(n.value,s.value))return!1;var n,s;return t.collectionGroup===e.collectionGroup&&!!t.path.isEqual(e.path)&&!!ei(t.startAt,e.startAt)&&ei(t.endAt,e.endAt)}function Ur(t){return wr.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length}class Br extends class{}{constructor(t,e,n){super(),this.field=t,this.op=e,this.value=n}static create(t,e,n){return t.isKeyField()?"in"===e||"not-in"===e?this.P(t,e,n):new jr(t,e,n):"array-contains"===e?new zr(t,n):"in"===e?new Hr(t,n):"not-in"===e?new Qr(t,n):"array-contains-any"===e?new Wr(t,n):new Br(t,e,n)}static P(t,e,n){return"in"===e?new Kr(t,n):new $r(t,n)}matches(t){const e=t.data.field(this.field);return"!="===this.op?null!==e&&this.v(Ir(e,this.value)):null!==e&&vr(this.value)===vr(e)&&this.v(Ir(e,this.value))}v(t){switch(this.op){case"<":return t<0;case"<=":return t<=0;case"==":return 0===t;case"!=":return 0!==t;case">":return t>0;case">=":return t>=0;default:return Ds()}}V(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}}class jr extends Br{constructor(t,e,n){super(t,e,n),this.key=wr.fromName(n.referenceValue)}matches(t){const e=wr.comparator(t.key,this.key);return this.v(e)}}class Kr extends Br{constructor(t,e){super(t,"in",e),this.keys=Gr(0,e)}matches(t){return this.keys.some((e=>e.isEqual(t.key)))}}class $r extends Br{constructor(t,e){super(t,"not-in",e),this.keys=Gr(0,e)}matches(t){return!this.keys.some((e=>e.isEqual(t.key)))}}function Gr(t,e){var n;return((null===(n=e.arrayValue)||void 0===n?void 0:n.values)||[]).map((t=>wr.fromName(t.referenceValue)))}class zr extends Br{constructor(t,e){super(t,"array-contains",e)}matches(t){const e=t.data.field(this.field);return Dr(e)&&br(e.arrayValue,this.value)}}class Hr extends Br{constructor(t,e){super(t,"in",e)}matches(t){const e=t.data.field(this.field);return null!==e&&br(this.value.arrayValue,e)}}class Qr extends Br{constructor(t,e){super(t,"not-in",e)}matches(t){if(br(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const e=t.data.field(this.field);return null!==e&&!br(this.value.arrayValue,e)}}class Wr extends Br{constructor(t,e){super(t,"array-contains-any",e)}matches(t){const e=t.data.field(this.field);return!(!Dr(e)||!e.arrayValue.values)&&e.arrayValue.values.some((t=>br(this.value.arrayValue,t)))}}class Yr{constructor(t,e){this.position=t,this.before=e}}function Xr(t){return`${t.before?"b":"a"}:${t.position.map((t=>Sr(t))).join(",")}`}class Jr{constructor(t,e="asc"){this.field=t,this.dir=e}}function Zr(t,e){return t.dir===e.dir&&t.field.isEqual(e.field)}function ti(t,e,n){let s=0;for(let r=0;r<t.position.length;r++){const i=e[r],o=t.position[r];if(s=i.field.isKeyField()?wr.comparator(wr.fromName(o.referenceValue),n.key):Ir(o,n.data.field(i.field)),"desc"===i.dir&&(s*=-1),0!==s)break}return t.before?s<=0:s<0}function ei(t,e){if(null===t)return null===e;if(null===e)return!1;if(t.before!==e.before||t.position.length!==e.position.length)return!1;for(let n=0;n<t.position.length;n++)if(!Tr(t.position[n],e.position[n]))return!1;return!0}class ni{constructor(t,e=null,n=[],s=[],r=null,i="F",o=null,a=null){this.path=t,this.collectionGroup=e,this.explicitOrderBy=n,this.filters=s,this.limit=r,this.limitType=i,this.startAt=o,this.endAt=a,this.S=null,this.D=null,this.startAt,this.endAt}}function si(t,e,n,s,r,i,o,a){return new ni(t,e,n,s,r,i,o,a)}function ri(t){return new ni(t)}function ii(t){return!gr(t.limit)&&"F"===t.limitType}function oi(t){return!gr(t.limit)&&"L"===t.limitType}function ai(t){return t.explicitOrderBy.length>0?t.explicitOrderBy[0].field:null}function ci(t){for(const e of t.filters)if(e.V())return e.field;return null}function ui(t){return null!==t.collectionGroup}function hi(t){const e=xs(t);if(null===e.S){e.S=[];const t=ci(e),n=ai(e);if(null!==t&&null===n)t.isKeyField()||e.S.push(new Jr(t)),e.S.push(new Jr(rr.keyField(),"asc"));else{let t=!1;for(const n of e.explicitOrderBy)e.S.push(n),n.field.isKeyField()&&(t=!0);if(!t){const t=e.explicitOrderBy.length>0?e.explicitOrderBy[e.explicitOrderBy.length-1].dir:"asc";e.S.push(new Jr(rr.keyField(),t))}}}return e.S}function li(t){const e=xs(t);if(!e.D)if("F"===e.limitType)e.D=Fr(e.path,e.collectionGroup,hi(e),e.filters,e.limit,e.startAt,e.endAt);else{const t=[];for(const n of hi(e)){const e="desc"===n.dir?"asc":"desc";t.push(new Jr(n.field,e))}const n=e.endAt?new Yr(e.endAt.position,!e.endAt.before):null,s=e.startAt?new Yr(e.startAt.position,!e.startAt.before):null;e.D=Fr(e.path,e.collectionGroup,t,e.filters,e.limit,n,s)}return e.D}function di(t,e,n){return new ni(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),e,n,t.startAt,t.endAt)}function fi(t,e){return qr(li(t),li(e))&&t.limitType===e.limitType}function mi(t){return`${Vr(li(t))}|lt:${t.limitType}`}function gi(t){return`Query(target=${function(t){let e=t.path.canonicalString();return null!==t.collectionGroup&&(e+=" collectionGroup="+t.collectionGroup),t.filters.length>0&&(e+=`, filters: [${t.filters.map((t=>{return`${(e=t).field.canonicalString()} ${e.op} ${Sr(e.value)}`;var e})).join(", ")}]`),gr(t.limit)||(e+=", limit: "+t.limit),t.orderBy.length>0&&(e+=`, orderBy: [${t.orderBy.map((t=>function(t){return`${t.field.canonicalString()} (${t.dir})`}(t))).join(", ")}]`),t.startAt&&(e+=", startAt: "+Xr(t.startAt)),t.endAt&&(e+=", endAt: "+Xr(t.endAt)),`Target(${e})`}(li(t))}; limitType=${t.limitType})`}function pi(t,e){return e.isFoundDocument()&&function(t,e){const n=e.key.path;return null!==t.collectionGroup?e.key.hasCollectionId(t.collectionGroup)&&t.path.isPrefixOf(n):wr.isDocumentKey(t.path)?t.path.isEqual(n):t.path.isImmediateParentOf(n)}(t,e)&&function(t,e){for(const n of t.explicitOrderBy)if(!n.field.isKeyField()&&null===e.data.field(n.field))return!1;return!0}(t,e)&&function(t,e){for(const n of t.filters)if(!n.matches(e))return!1;return!0}(t,e)&&function(t,e){return!(t.startAt&&!ti(t.startAt,hi(t),e)||t.endAt&&ti(t.endAt,hi(t),e))}(t,e)}function yi(t){return(e,n)=>{let s=!1;for(const r of hi(t)){const t=wi(r,e,n);if(0!==t)return t;s=s||r.field.isKeyField()}return 0}}function wi(t,e,n){const s=t.field.isKeyField()?wr.comparator(e.key,n.key):function(t,e,n){const s=e.data.field(t),r=n.data.field(t);return null!==s&&null!==r?Ir(s,r):Ds()}(t.field,e,n);switch(t.dir){case"asc":return s;case"desc":return-1*s;default:return Ds()}}function vi(t,e){if(t.C){if(isNaN(e))return{doubleValue:"NaN"};if(e===1/0)return{doubleValue:"Infinity"};if(e===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:pr(e)?"-0":e}}function Ti(t){return{integerValue:""+t}}function bi(t,e){return yr(e)?Ti(e):vi(t,e)}class Ii{constructor(){this._=void 0}}function Ei(t,e,n){return t instanceof _i?function(t,e){const n={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:t.seconds,nanos:t.nanoseconds}}}};return e&&(n.fields.__previous_value__=e),{mapValue:n}}(n,e):t instanceof ki?Di(t,e):t instanceof Ci?Ni(t,e):function(t,e){const n=Ai(t,e),s=Ri(n)+Ri(t.N);return kr(n)&&kr(t.N)?Ti(s):vi(t.k,s)}(t,e)}function Si(t,e,n){return t instanceof ki?Di(t,e):t instanceof Ci?Ni(t,e):n}function Ai(t,e){return t instanceof xi?kr(n=e)||function(t){return!!t&&"doubleValue"in t}(n)?e:{integerValue:0}:null;var n}class _i extends Ii{}class ki extends Ii{constructor(t){super(),this.elements=t}}function Di(t,e){const n=Li(e);for(const e of t.elements)n.some((t=>Tr(t,e)))||n.push(e);return{arrayValue:{values:n}}}class Ci extends Ii{constructor(t){super(),this.elements=t}}function Ni(t,e){let n=Li(e);for(const e of t.elements)n=n.filter((t=>!Tr(t,e)));return{arrayValue:{values:n}}}class xi extends Ii{constructor(t,e){super(),this.k=t,this.N=e}}function Ri(t){return hr(t.integerValue||t.doubleValue)}function Li(t){return Dr(t)&&t.arrayValue.values?t.arrayValue.values.slice():[]}class Mi{constructor(t,e){this.field=t,this.transform=e}}class Pi{constructor(t,e){this.version=t,this.transformResults=e}}class Oi{constructor(t,e){this.updateTime=t,this.exists=e}static none(){return new Oi}static exists(t){return new Oi(void 0,t)}static updateTime(t){return new Oi(t)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(t){return this.exists===t.exists&&(this.updateTime?!!t.updateTime&&this.updateTime.isEqual(t.updateTime):!t.updateTime)}}function Fi(t,e){return void 0!==t.updateTime?e.isFoundDocument()&&e.version.isEqual(t.updateTime):void 0===t.exists||t.exists===e.isFoundDocument()}class Vi{}function qi(t,e,n){t instanceof $i?function(t,e,n){const s=t.value.clone(),r=Hi(t.fieldTransforms,e,n.transformResults);s.setAll(r),e.convertToFoundDocument(n.version,s).setHasCommittedMutations()}(t,e,n):t instanceof Gi?function(t,e,n){if(!Fi(t.precondition,e))return void e.convertToUnknownDocument(n.version);const s=Hi(t.fieldTransforms,e,n.transformResults),r=e.data;r.setAll(zi(t)),r.setAll(s),e.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(t,e,n):function(t,e,n){e.convertToNoDocument(n.version).setHasCommittedMutations()}(0,e,n)}function Ui(t,e,n){t instanceof $i?function(t,e,n){if(!Fi(t.precondition,e))return;const s=t.value.clone(),r=Qi(t.fieldTransforms,n,e);s.setAll(r),e.convertToFoundDocument(Ki(e),s).setHasLocalMutations()}(t,e,n):t instanceof Gi?function(t,e,n){if(!Fi(t.precondition,e))return;const s=Qi(t.fieldTransforms,n,e),r=e.data;r.setAll(zi(t)),r.setAll(s),e.convertToFoundDocument(Ki(e),r).setHasLocalMutations()}(t,e,n):function(t,e){Fi(t.precondition,e)&&e.convertToNoDocument(Xs.min())}(t,e)}function Bi(t,e){let n=null;for(const s of t.fieldTransforms){const t=e.data.field(s.field),r=Ai(s.transform,t||null);null!=r&&(null==n&&(n=Lr.empty()),n.set(s.field,r))}return n||null}function ji(t,e){return t.type===e.type&&!!t.key.isEqual(e.key)&&!!t.precondition.isEqual(e.precondition)&&!!function(t,e){return void 0===t&&void 0===e||!(!t||!e)&&Qs(t,e,((t,e)=>function(t,e){return t.field.isEqual(e.field)&&function(t,e){return t instanceof ki&&e instanceof ki||t instanceof Ci&&e instanceof Ci?Qs(t.elements,e.elements,Tr):t instanceof xi&&e instanceof xi?Tr(t.N,e.N):t instanceof _i&&e instanceof _i}(t.transform,e.transform)}(t,e)))}(t.fieldTransforms,e.fieldTransforms)&&(0===t.type?t.value.isEqual(e.value):1!==t.type||t.data.isEqual(e.data)&&t.fieldMask.isEqual(e.fieldMask))}function Ki(t){return t.isFoundDocument()?t.version:Xs.min()}class $i extends Vi{constructor(t,e,n,s=[]){super(),this.key=t,this.value=e,this.precondition=n,this.fieldTransforms=s,this.type=0}}class Gi extends Vi{constructor(t,e,n,s,r=[]){super(),this.key=t,this.data=e,this.fieldMask=n,this.precondition=s,this.fieldTransforms=r,this.type=1}}function zi(t){const e=new Map;return t.fieldMask.fields.forEach((n=>{if(!n.isEmpty()){const s=t.data.field(n);e.set(n,s)}})),e}function Hi(t,e,n){const s=new Map;Cs(t.length===n.length);for(let r=0;r<n.length;r++){const i=t[r],o=i.transform,a=e.data.field(i.field);s.set(i.field,Si(o,a,n[r]))}return s}function Qi(t,e,n){const s=new Map;for(const r of t){const t=r.transform,i=n.data.field(r.field);s.set(r.field,Ei(t,i,e))}return s}class Wi extends Vi{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=2,this.fieldTransforms=[]}}class Yi extends Vi{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=3,this.fieldTransforms=[]}}class Xi{constructor(t){this.count=t}}var Ji,Zi;function to(t){switch(t){default:return Ds();case Rs.CANCELLED:case Rs.UNKNOWN:case Rs.DEADLINE_EXCEEDED:case Rs.RESOURCE_EXHAUSTED:case Rs.INTERNAL:case Rs.UNAVAILABLE:case Rs.UNAUTHENTICATED:return!1;case Rs.INVALID_ARGUMENT:case Rs.NOT_FOUND:case Rs.ALREADY_EXISTS:case Rs.PERMISSION_DENIED:case Rs.FAILED_PRECONDITION:case Rs.ABORTED:case Rs.OUT_OF_RANGE:case Rs.UNIMPLEMENTED:case Rs.DATA_LOSS:return!0}}function eo(t){if(void 0===t)return As("GRPC error has no .code"),Rs.UNKNOWN;switch(t){case Ji.OK:return Rs.OK;case Ji.CANCELLED:return Rs.CANCELLED;case Ji.UNKNOWN:return Rs.UNKNOWN;case Ji.DEADLINE_EXCEEDED:return Rs.DEADLINE_EXCEEDED;case Ji.RESOURCE_EXHAUSTED:return Rs.RESOURCE_EXHAUSTED;case Ji.INTERNAL:return Rs.INTERNAL;case Ji.UNAVAILABLE:return Rs.UNAVAILABLE;case Ji.UNAUTHENTICATED:return Rs.UNAUTHENTICATED;case Ji.INVALID_ARGUMENT:return Rs.INVALID_ARGUMENT;case Ji.NOT_FOUND:return Rs.NOT_FOUND;case Ji.ALREADY_EXISTS:return Rs.ALREADY_EXISTS;case Ji.PERMISSION_DENIED:return Rs.PERMISSION_DENIED;case Ji.FAILED_PRECONDITION:return Rs.FAILED_PRECONDITION;case Ji.ABORTED:return Rs.ABORTED;case Ji.OUT_OF_RANGE:return Rs.OUT_OF_RANGE;case Ji.UNIMPLEMENTED:return Rs.UNIMPLEMENTED;case Ji.DATA_LOSS:return Rs.DATA_LOSS;default:return Ds()}}(Zi=Ji||(Ji={}))[Zi.OK=0]="OK",Zi[Zi.CANCELLED=1]="CANCELLED",Zi[Zi.UNKNOWN=2]="UNKNOWN",Zi[Zi.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",Zi[Zi.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",Zi[Zi.NOT_FOUND=5]="NOT_FOUND",Zi[Zi.ALREADY_EXISTS=6]="ALREADY_EXISTS",Zi[Zi.PERMISSION_DENIED=7]="PERMISSION_DENIED",Zi[Zi.UNAUTHENTICATED=16]="UNAUTHENTICATED",Zi[Zi.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",Zi[Zi.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",Zi[Zi.ABORTED=10]="ABORTED",Zi[Zi.OUT_OF_RANGE=11]="OUT_OF_RANGE",Zi[Zi.UNIMPLEMENTED=12]="UNIMPLEMENTED",Zi[Zi.INTERNAL=13]="INTERNAL",Zi[Zi.UNAVAILABLE=14]="UNAVAILABLE",Zi[Zi.DATA_LOSS=15]="DATA_LOSS";class no{constructor(t,e){this.comparator=t,this.root=e||ro.EMPTY}insert(t,e){return new no(this.comparator,this.root.insert(t,e,this.comparator).copy(null,null,ro.BLACK,null,null))}remove(t){return new no(this.comparator,this.root.remove(t,this.comparator).copy(null,null,ro.BLACK,null,null))}get(t){let e=this.root;for(;!e.isEmpty();){const n=this.comparator(t,e.key);if(0===n)return e.value;n<0?e=e.left:n>0&&(e=e.right)}return null}indexOf(t){let e=0,n=this.root;for(;!n.isEmpty();){const s=this.comparator(t,n.key);if(0===s)return e+n.left.size;s<0?n=n.left:(e+=n.left.size+1,n=n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(t){return this.root.inorderTraversal(t)}forEach(t){this.inorderTraversal(((e,n)=>(t(e,n),!1)))}toString(){const t=[];return this.inorderTraversal(((e,n)=>(t.push(`${e}:${n}`),!1))),`{${t.join(", ")}}`}reverseTraversal(t){return this.root.reverseTraversal(t)}getIterator(){return new so(this.root,null,this.comparator,!1)}getIteratorFrom(t){return new so(this.root,t,this.comparator,!1)}getReverseIterator(){return new so(this.root,null,this.comparator,!0)}getReverseIteratorFrom(t){return new so(this.root,t,this.comparator,!0)}}class so{constructor(t,e,n,s){this.isReverse=s,this.nodeStack=[];let r=1;for(;!t.isEmpty();)if(r=e?n(t.key,e):1,s&&(r*=-1),r<0)t=this.isReverse?t.left:t.right;else{if(0===r){this.nodeStack.push(t);break}this.nodeStack.push(t),t=this.isReverse?t.right:t.left}}getNext(){let t=this.nodeStack.pop();const e={key:t.key,value:t.value};if(this.isReverse)for(t=t.left;!t.isEmpty();)this.nodeStack.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack.push(t),t=t.left;return e}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;const t=this.nodeStack[this.nodeStack.length-1];return{key:t.key,value:t.value}}}class ro{constructor(t,e,n,s,r){this.key=t,this.value=e,this.color=null!=n?n:ro.RED,this.left=null!=s?s:ro.EMPTY,this.right=null!=r?r:ro.EMPTY,this.size=this.left.size+1+this.right.size}copy(t,e,n,s,r){return new ro(null!=t?t:this.key,null!=e?e:this.value,null!=n?n:this.color,null!=s?s:this.left,null!=r?r:this.right)}isEmpty(){return!1}inorderTraversal(t){return this.left.inorderTraversal(t)||t(this.key,this.value)||this.right.inorderTraversal(t)}reverseTraversal(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(t,e,n){let s=this;const r=n(t,s.key);return s=r<0?s.copy(null,null,null,s.left.insert(t,e,n),null):0===r?s.copy(null,e,null,null,null):s.copy(null,null,null,null,s.right.insert(t,e,n)),s.fixUp()}removeMin(){if(this.left.isEmpty())return ro.EMPTY;let t=this;return t.left.isRed()||t.left.left.isRed()||(t=t.moveRedLeft()),t=t.copy(null,null,null,t.left.removeMin(),null),t.fixUp()}remove(t,e){let n,s=this;if(e(t,s.key)<0)s.left.isEmpty()||s.left.isRed()||s.left.left.isRed()||(s=s.moveRedLeft()),s=s.copy(null,null,null,s.left.remove(t,e),null);else{if(s.left.isRed()&&(s=s.rotateRight()),s.right.isEmpty()||s.right.isRed()||s.right.left.isRed()||(s=s.moveRedRight()),0===e(t,s.key)){if(s.right.isEmpty())return ro.EMPTY;n=s.right.min(),s=s.copy(n.key,n.value,null,null,s.right.removeMin())}s=s.copy(null,null,null,null,s.right.remove(t,e))}return s.fixUp()}isRed(){return this.color}fixUp(){let t=this;return t.right.isRed()&&!t.left.isRed()&&(t=t.rotateLeft()),t.left.isRed()&&t.left.left.isRed()&&(t=t.rotateRight()),t.left.isRed()&&t.right.isRed()&&(t=t.colorFlip()),t}moveRedLeft(){let t=this.colorFlip();return t.right.left.isRed()&&(t=t.copy(null,null,null,null,t.right.rotateRight()),t=t.rotateLeft(),t=t.colorFlip()),t}moveRedRight(){let t=this.colorFlip();return t.left.left.isRed()&&(t=t.rotateRight(),t=t.colorFlip()),t}rotateLeft(){const t=this.copy(null,null,ro.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}rotateRight(){const t=this.copy(null,null,ro.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}colorFlip(){const t=this.left.copy(null,null,!this.left.color,null,null),e=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,e)}checkMaxDepth(){const t=this.check();return Math.pow(2,t)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw Ds();if(this.right.isRed())throw Ds();const t=this.left.check();if(t!==this.right.check())throw Ds();return t+(this.isRed()?0:1)}}ro.EMPTY=null,ro.RED=!0,ro.BLACK=!1,ro.EMPTY=new class{constructor(){this.size=0}get key(){throw Ds()}get value(){throw Ds()}get color(){throw Ds()}get left(){throw Ds()}get right(){throw Ds()}copy(t,e,n,s,r){return this}insert(t,e,n){return new ro(t,e)}remove(t,e){return this}isEmpty(){return!0}inorderTraversal(t){return!1}reverseTraversal(t){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class io{constructor(t){this.comparator=t,this.data=new no(this.comparator)}has(t){return null!==this.data.get(t)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(t){return this.data.indexOf(t)}forEach(t){this.data.inorderTraversal(((e,n)=>(t(e),!1)))}forEachInRange(t,e){const n=this.data.getIteratorFrom(t[0]);for(;n.hasNext();){const s=n.getNext();if(this.comparator(s.key,t[1])>=0)return;e(s.key)}}forEachWhile(t,e){let n;for(n=void 0!==e?this.data.getIteratorFrom(e):this.data.getIterator();n.hasNext();)if(!t(n.getNext().key))return}firstAfterOrEqual(t){const e=this.data.getIteratorFrom(t);return e.hasNext()?e.getNext().key:null}getIterator(){return new oo(this.data.getIterator())}getIteratorFrom(t){return new oo(this.data.getIteratorFrom(t))}add(t){return this.copy(this.data.remove(t).insert(t,!0))}delete(t){return this.has(t)?this.copy(this.data.remove(t)):this}isEmpty(){return this.data.isEmpty()}unionWith(t){let e=this;return e.size<t.size&&(e=t,t=this),t.forEach((t=>{e=e.add(t)})),e}isEqual(t){if(!(t instanceof io))return!1;if(this.size!==t.size)return!1;const e=this.data.getIterator(),n=t.data.getIterator();for(;e.hasNext();){const t=e.getNext().key,s=n.getNext().key;if(0!==this.comparator(t,s))return!1}return!0}toArray(){const t=[];return this.forEach((e=>{t.push(e)})),t}toString(){const t=[];return this.forEach((e=>t.push(e))),"SortedSet("+t.toString()+")"}copy(t){const e=new io(this.comparator);return e.data=t,e}}class oo{constructor(t){this.iter=t}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}const ao=new no(wr.comparator);function co(){return ao}const uo=new no(wr.comparator);function ho(){return uo}const lo=new no(wr.comparator);function fo(){return lo}const mo=new io(wr.comparator);function go(...t){let e=mo;for(const n of t)e=e.add(n);return e}const po=new io(Hs);function yo(){return po}class wo{constructor(t,e,n,s,r){this.snapshotVersion=t,this.targetChanges=e,this.targetMismatches=n,this.documentUpdates=s,this.resolvedLimboDocuments=r}static createSynthesizedRemoteEventForCurrentChange(t,e){const n=new Map;return n.set(t,vo.createSynthesizedTargetChangeForCurrentChange(t,e)),new wo(Xs.min(),n,yo(),co(),go())}}class vo{constructor(t,e,n,s,r){this.resumeToken=t,this.current=e,this.addedDocuments=n,this.modifiedDocuments=s,this.removedDocuments=r}static createSynthesizedTargetChangeForCurrentChange(t,e){return new vo(ar.EMPTY_BYTE_STRING,e,go(),go(),go())}}class To{constructor(t,e,n,s){this.$=t,this.removedTargetIds=e,this.key=n,this.O=s}}class bo{constructor(t,e){this.targetId=t,this.M=e}}class Io{constructor(t,e,n=ar.EMPTY_BYTE_STRING,s=null){this.state=t,this.targetIds=e,this.resumeToken=n,this.cause=s}}class Eo{constructor(){this.F=0,this.L=_o(),this.B=ar.EMPTY_BYTE_STRING,this.U=!1,this.q=!0}get current(){return this.U}get resumeToken(){return this.B}get K(){return 0!==this.F}get j(){return this.q}W(t){t.approximateByteSize()>0&&(this.q=!0,this.B=t)}G(){let t=go(),e=go(),n=go();return this.L.forEach(((s,r)=>{switch(r){case 0:t=t.add(s);break;case 2:e=e.add(s);break;case 1:n=n.add(s);break;default:Ds()}})),new vo(this.B,this.U,t,e,n)}H(){this.q=!1,this.L=_o()}J(t,e){this.q=!0,this.L=this.L.insert(t,e)}Y(t){this.q=!0,this.L=this.L.remove(t)}X(){this.F+=1}Z(){this.F-=1}tt(){this.q=!0,this.U=!0}}class So{constructor(t){this.et=t,this.nt=new Map,this.st=co(),this.it=Ao(),this.rt=new io(Hs)}ot(t){for(const e of t.$)t.O&&t.O.isFoundDocument()?this.ct(e,t.O):this.at(e,t.key,t.O);for(const e of t.removedTargetIds)this.at(e,t.key,t.O)}ut(t){this.forEachTarget(t,(e=>{const n=this.ht(e);switch(t.state){case 0:this.lt(e)&&n.W(t.resumeToken);break;case 1:n.Z(),n.K||n.H(),n.W(t.resumeToken);break;case 2:n.Z(),n.K||this.removeTarget(e);break;case 3:this.lt(e)&&(n.tt(),n.W(t.resumeToken));break;case 4:this.lt(e)&&(this.ft(e),n.W(t.resumeToken));break;default:Ds()}}))}forEachTarget(t,e){t.targetIds.length>0?t.targetIds.forEach(e):this.nt.forEach(((t,n)=>{this.lt(n)&&e(n)}))}dt(t){const e=t.targetId,n=t.M.count,s=this.wt(e);if(s){const t=s.target;if(Ur(t))if(0===n){const n=new wr(t.path);this.at(e,n,Pr.newNoDocument(n,Xs.min()))}else Cs(1===n);else this._t(e)!==n&&(this.ft(e),this.rt=this.rt.add(e))}}gt(t){const e=new Map;this.nt.forEach(((n,s)=>{const r=this.wt(s);if(r){if(n.current&&Ur(r.target)){const e=new wr(r.target.path);null!==this.st.get(e)||this.yt(s,e)||this.at(s,e,Pr.newNoDocument(e,t))}n.j&&(e.set(s,n.G()),n.H())}}));let n=go();this.it.forEach(((t,e)=>{let s=!0;e.forEachWhile((t=>{const e=this.wt(t);return!e||2===e.purpose||(s=!1,!1)})),s&&(n=n.add(t))}));const s=new wo(t,e,this.rt,this.st,n);return this.st=co(),this.it=Ao(),this.rt=new io(Hs),s}ct(t,e){if(!this.lt(t))return;const n=this.yt(t,e.key)?2:0;this.ht(t).J(e.key,n),this.st=this.st.insert(e.key,e),this.it=this.it.insert(e.key,this.Tt(e.key).add(t))}at(t,e,n){if(!this.lt(t))return;const s=this.ht(t);this.yt(t,e)?s.J(e,1):s.Y(e),this.it=this.it.insert(e,this.Tt(e).delete(t)),n&&(this.st=this.st.insert(e,n))}removeTarget(t){this.nt.delete(t)}_t(t){const e=this.ht(t).G();return this.et.getRemoteKeysForTarget(t).size+e.addedDocuments.size-e.removedDocuments.size}X(t){this.ht(t).X()}ht(t){let e=this.nt.get(t);return e||(e=new Eo,this.nt.set(t,e)),e}Tt(t){let e=this.it.get(t);return e||(e=new io(Hs),this.it=this.it.insert(t,e)),e}lt(t){const e=null!==this.wt(t);return e||Ss("WatchChangeAggregator","Detected inactive target",t),e}wt(t){const e=this.nt.get(t);return e&&e.K?null:this.et.Et(t)}ft(t){this.nt.set(t,new Eo),this.et.getRemoteKeysForTarget(t).forEach((e=>{this.at(t,e,null)}))}yt(t,e){return this.et.getRemoteKeysForTarget(t).has(e)}}function Ao(){return new no(wr.comparator)}function _o(){return new no(wr.comparator)}const ko={asc:"ASCENDING",desc:"DESCENDING"},Do={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"};class Co{constructor(t,e){this.databaseId=t,this.C=e}}function No(t,e){return t.C?`${new Date(1e3*e.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+e.nanoseconds).slice(-9)}Z`:{seconds:""+e.seconds,nanos:e.nanoseconds}}function xo(t,e){return t.C?e.toBase64():e.toUint8Array()}function Ro(t,e){return No(t,e.toTimestamp())}function Lo(t){return Cs(!!t),Xs.fromTimestamp(function(t){const e=ur(t);return new Ys(e.seconds,e.nanos)}(t))}function Mo(t,e){return function(t){return new nr(["projects",t.projectId,"databases",t.database])}(t).child("documents").child(e).canonicalString()}function Po(t){const e=nr.fromString(t);return Cs(ia(e)),e}function Oo(t,e){return Mo(t.databaseId,e.path)}function Fo(t,e){const n=Po(e);if(n.get(1)!==t.databaseId.projectId)throw new Ls(Rs.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+t.databaseId.projectId);if(n.get(3)!==t.databaseId.database)throw new Ls(Rs.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+t.databaseId.database);return new wr(Bo(n))}function Vo(t,e){return Mo(t.databaseId,e)}function qo(t){const e=Po(t);return 4===e.length?nr.emptyPath():Bo(e)}function Uo(t){return new nr(["projects",t.databaseId.projectId,"databases",t.databaseId.database]).canonicalString()}function Bo(t){return Cs(t.length>4&&"documents"===t.get(4)),t.popFirst(5)}function jo(t,e,n){return{name:Oo(t,e),fields:n.value.mapValue.fields}}function Ko(t,e,n){const s=Fo(t,e.name),r=Lo(e.updateTime),i=new Lr({mapValue:{fields:e.fields}}),o=Pr.newFoundDocument(s,r,i);return n&&o.setHasCommittedMutations(),n?o.setHasCommittedMutations():o}function $o(t,e){let n;if(e instanceof $i)n={update:jo(t,e.key,e.value)};else if(e instanceof Wi)n={delete:Oo(t,e.key)};else if(e instanceof Gi)n={update:jo(t,e.key,e.data),updateMask:ra(e.fieldMask)};else{if(!(e instanceof Yi))return Ds();n={verify:Oo(t,e.key)}}return e.fieldTransforms.length>0&&(n.updateTransforms=e.fieldTransforms.map((t=>function(t,e){const n=e.transform;if(n instanceof _i)return{fieldPath:e.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof ki)return{fieldPath:e.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof Ci)return{fieldPath:e.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof xi)return{fieldPath:e.field.canonicalString(),increment:n.N};throw Ds()}(0,t)))),e.precondition.isNone||(n.currentDocument=function(t,e){return void 0!==e.updateTime?{updateTime:Ro(t,e.updateTime)}:void 0!==e.exists?{exists:e.exists}:Ds()}(t,e.precondition)),n}function Go(t,e){const n=e.currentDocument?function(t){return void 0!==t.updateTime?Oi.updateTime(Lo(t.updateTime)):void 0!==t.exists?Oi.exists(t.exists):Oi.none()}(e.currentDocument):Oi.none(),s=e.updateTransforms?e.updateTransforms.map((e=>function(t,e){let n=null;if("setToServerValue"in e)Cs("REQUEST_TIME"===e.setToServerValue),n=new _i;else if("appendMissingElements"in e){const t=e.appendMissingElements.values||[];n=new ki(t)}else if("removeAllFromArray"in e){const t=e.removeAllFromArray.values||[];n=new Ci(t)}else"increment"in e?n=new xi(t,e.increment):Ds();const s=rr.fromServerFormat(e.fieldPath);return new Mi(s,n)}(t,e))):[];if(e.update){e.update.name;const r=Fo(t,e.update.name),i=new Lr({mapValue:{fields:e.update.fields}});if(e.updateMask){const t=function(t){const e=t.fieldPaths||[];return new ir(e.map((t=>rr.fromServerFormat(t))))}(e.updateMask);return new Gi(r,i,t,n,s)}return new $i(r,i,n,s)}if(e.delete){const s=Fo(t,e.delete);return new Wi(s,n)}if(e.verify){const s=Fo(t,e.verify);return new Yi(s,n)}return Ds()}function zo(t,e){return{documents:[Vo(t,e.path)]}}function Ho(t,e){const n={structuredQuery:{}},s=e.path;null!==e.collectionGroup?(n.parent=Vo(t,s),n.structuredQuery.from=[{collectionId:e.collectionGroup,allDescendants:!0}]):(n.parent=Vo(t,s.popLast()),n.structuredQuery.from=[{collectionId:s.lastSegment()}]);const r=function(t){if(0===t.length)return;const e=t.map((t=>function(t){if("=="===t.op){if(Nr(t.value))return{unaryFilter:{field:ta(t.field),op:"IS_NAN"}};if(Cr(t.value))return{unaryFilter:{field:ta(t.field),op:"IS_NULL"}}}else if("!="===t.op){if(Nr(t.value))return{unaryFilter:{field:ta(t.field),op:"IS_NOT_NAN"}};if(Cr(t.value))return{unaryFilter:{field:ta(t.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:ta(t.field),op:Zo(t.op),value:t.value}}}(t)));return 1===e.length?e[0]:{compositeFilter:{op:"AND",filters:e}}}(e.filters);r&&(n.structuredQuery.where=r);const i=function(t){if(0!==t.length)return t.map((t=>function(t){return{field:ta(t.field),direction:Jo(t.dir)}}(t)))}(e.orderBy);i&&(n.structuredQuery.orderBy=i);const o=function(t,e){return t.C||gr(e)?e:{value:e}}(t,e.limit);return null!==o&&(n.structuredQuery.limit=o),e.startAt&&(n.structuredQuery.startAt=Yo(e.startAt)),e.endAt&&(n.structuredQuery.endAt=Yo(e.endAt)),n}function Qo(t){let e=qo(t.parent);const n=t.structuredQuery,s=n.from?n.from.length:0;let r=null;if(s>0){Cs(1===s);const t=n.from[0];t.allDescendants?r=t.collectionId:e=e.child(t.collectionId)}let i=[];n.where&&(i=Wo(n.where));let o=[];n.orderBy&&(o=n.orderBy.map((t=>function(t){return new Jr(ea(t.field),function(t){switch(t){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(t.direction))}(t))));let a=null;n.limit&&(a=function(t){let e;return e="object"==typeof t?t.value:t,gr(e)?null:e}(n.limit));let c=null;n.startAt&&(c=Xo(n.startAt));let u=null;return n.endAt&&(u=Xo(n.endAt)),si(e,r,o,i,a,"F",c,u)}function Wo(t){return t?void 0!==t.unaryFilter?[sa(t)]:void 0!==t.fieldFilter?[na(t)]:void 0!==t.compositeFilter?t.compositeFilter.filters.map((t=>Wo(t))).reduce(((t,e)=>t.concat(e))):Ds():[]}function Yo(t){return{before:t.before,values:t.position}}function Xo(t){const e=!!t.before,n=t.values||[];return new Yr(n,e)}function Jo(t){return ko[t]}function Zo(t){return Do[t]}function ta(t){return{fieldPath:t.canonicalString()}}function ea(t){return rr.fromServerFormat(t.fieldPath)}function na(t){return Br.create(ea(t.fieldFilter.field),function(t){switch(t){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return Ds()}}(t.fieldFilter.op),t.fieldFilter.value)}function sa(t){switch(t.unaryFilter.op){case"IS_NAN":const e=ea(t.unaryFilter.field);return Br.create(e,"==",{doubleValue:NaN});case"IS_NULL":const n=ea(t.unaryFilter.field);return Br.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const s=ea(t.unaryFilter.field);return Br.create(s,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const r=ea(t.unaryFilter.field);return Br.create(r,"!=",{nullValue:"NULL_VALUE"});default:return Ds()}}function ra(t){const e=[];return t.fields.forEach((t=>e.push(t.canonicalString()))),{fieldPaths:e}}function ia(t){return t.length>=4&&"projects"===t.get(0)&&"databases"===t.get(2)}function oa(t){let e="";for(let n=0;n<t.length;n++)e.length>0&&(e=ca(e)),e=aa(t.get(n),e);return ca(e)}function aa(t,e){let n=e;const s=t.length;for(let e=0;e<s;e++){const s=t.charAt(e);switch(s){case"\0":n+="";break;case"":n+="";break;default:n+=s}}return n}function ca(t){return t+""}function ua(t){const e=t.length;if(Cs(e>=2),2===e)return Cs(""===t.charAt(0)&&""===t.charAt(1)),nr.emptyPath();const n=e-2,s=[];let r="";for(let i=0;i<e;){const e=t.indexOf("",i);switch((e<0||e>n)&&Ds(),t.charAt(e+1)){case"":const n=t.substring(i,e);let o;0===r.length?o=n:(r+=n,o=r,r=""),s.push(o);break;case"":r+=t.substring(i,e),r+="\0";break;case"":r+=t.substring(i,e+1);break;default:Ds()}i=e+2}return new nr(s)}class ha{constructor(t,e){this.seconds=t,this.nanoseconds=e}}class la{constructor(t,e,n){this.ownerId=t,this.allowTabSynchronization=e,this.leaseTimestampMs=n}}la.store="owner",la.key="owner";class da{constructor(t,e,n){this.userId=t,this.lastAcknowledgedBatchId=e,this.lastStreamToken=n}}da.store="mutationQueues",da.keyPath="userId";class fa{constructor(t,e,n,s,r){this.userId=t,this.batchId=e,this.localWriteTimeMs=n,this.baseMutations=s,this.mutations=r}}fa.store="mutations",fa.keyPath="batchId",fa.userMutationsIndex="userMutationsIndex",fa.userMutationsKeyPath=["userId","batchId"];class ma{constructor(){}static prefixForUser(t){return[t]}static prefixForPath(t,e){return[t,oa(e)]}static key(t,e,n){return[t,oa(e),n]}}ma.store="documentMutations",ma.PLACEHOLDER=new ma;class ga{constructor(t,e){this.path=t,this.readTime=e}}class pa{constructor(t,e){this.path=t,this.version=e}}class ya{constructor(t,e,n,s,r,i){this.unknownDocument=t,this.noDocument=e,this.document=n,this.hasCommittedMutations=s,this.readTime=r,this.parentPath=i}}ya.store="remoteDocuments",ya.readTimeIndex="readTimeIndex",ya.readTimeIndexPath="readTime",ya.collectionReadTimeIndex="collectionReadTimeIndex",ya.collectionReadTimeIndexPath=["parentPath","readTime"];class wa{constructor(t){this.byteSize=t}}wa.store="remoteDocumentGlobal",wa.key="remoteDocumentGlobalKey";class va{constructor(t,e,n,s,r,i,o){this.targetId=t,this.canonicalId=e,this.readTime=n,this.resumeToken=s,this.lastListenSequenceNumber=r,this.lastLimboFreeSnapshotVersion=i,this.query=o}}va.store="targets",va.keyPath="targetId",va.queryTargetsIndexName="queryTargetsIndex",va.queryTargetsKeyPath=["canonicalId","targetId"];class Ta{constructor(t,e,n){this.targetId=t,this.path=e,this.sequenceNumber=n}}Ta.store="targetDocuments",Ta.keyPath=["targetId","path"],Ta.documentTargetsIndex="documentTargetsIndex",Ta.documentTargetsKeyPath=["path","targetId"];class ba{constructor(t,e,n,s){this.highestTargetId=t,this.highestListenSequenceNumber=e,this.lastRemoteSnapshotVersion=n,this.targetCount=s}}ba.key="targetGlobalKey",ba.store="targetGlobal";class Ia{constructor(t,e){this.collectionId=t,this.parent=e}}Ia.store="collectionParents",Ia.keyPath=["collectionId","parent"];class Ea{constructor(t,e,n,s){this.clientId=t,this.updateTimeMs=e,this.networkEnabled=n,this.inForeground=s}}Ea.store="clientMetadata",Ea.keyPath="clientId";class Sa{constructor(t,e,n){this.bundleId=t,this.createTime=e,this.version=n}}Sa.store="bundles",Sa.keyPath="bundleId";class Aa{constructor(t,e,n){this.name=t,this.readTime=e,this.bundledQuery=n}}Aa.store="namedQueries",Aa.keyPath="name";const _a=[da.store,fa.store,ma.store,ya.store,va.store,la.store,ba.store,Ta.store,Ea.store,wa.store,Ia.store,Sa.store,Aa.store],ka="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class Da{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(t){this.onCommittedListeners.push(t)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach((t=>t()))}}class Ca{constructor(t){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,t((t=>{this.isDone=!0,this.result=t,this.nextCallback&&this.nextCallback(t)}),(t=>{this.isDone=!0,this.error=t,this.catchCallback&&this.catchCallback(t)}))}catch(t){return this.next(void 0,t)}next(t,e){return this.callbackAttached&&Ds(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(e,this.error):this.wrapSuccess(t,this.result):new Ca(((n,s)=>{this.nextCallback=e=>{this.wrapSuccess(t,e).next(n,s)},this.catchCallback=t=>{this.wrapFailure(e,t).next(n,s)}}))}toPromise(){return new Promise(((t,e)=>{this.next(t,e)}))}wrapUserFunction(t){try{const e=t();return e instanceof Ca?e:Ca.resolve(e)}catch(t){return Ca.reject(t)}}wrapSuccess(t,e){return t?this.wrapUserFunction((()=>t(e))):Ca.resolve(e)}wrapFailure(t,e){return t?this.wrapUserFunction((()=>t(e))):Ca.reject(e)}static resolve(t){return new Ca(((e,n)=>{e(t)}))}static reject(t){return new Ca(((e,n)=>{n(t)}))}static waitFor(t){return new Ca(((e,n)=>{let s=0,r=0,i=!1;t.forEach((t=>{++s,t.next((()=>{++r,i&&r===s&&e()}),(t=>n(t)))})),i=!0,r===s&&e()}))}static or(t){let e=Ca.resolve(!1);for(const n of t)e=e.next((t=>t?Ca.resolve(t):n()));return e}static forEach(t,e){const n=[];return t.forEach(((t,s)=>{n.push(e.call(this,t,s))})),this.waitFor(n)}}class Na{constructor(t,e){this.action=t,this.transaction=e,this.aborted=!1,this.It=new Ms,this.transaction.oncomplete=()=>{this.It.resolve()},this.transaction.onabort=()=>{e.error?this.It.reject(new La(t,e.error)):this.It.resolve()},this.transaction.onerror=e=>{const n=Va(e.target.error);this.It.reject(new La(t,n))}}static open(t,e,n,s){try{return new Na(e,t.transaction(s,n))}catch(t){throw new La(e,t)}}get At(){return this.It.promise}abort(t){t&&this.It.reject(t),this.aborted||(Ss("SimpleDb","Aborting transaction:",t?t.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}store(t){const e=this.transaction.objectStore(t);return new Pa(e)}}class xa{constructor(t,e,n){this.name=t,this.version=e,this.Rt=n,12.2===xa.bt((0,a.z$)())&&As("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(t){return Ss("SimpleDb","Removing database:",t),Oa(window.indexedDB.deleteDatabase(t)).toPromise()}static Pt(){if(!(0,a.hl)())return!1;if(xa.vt())return!0;const t=(0,a.z$)(),e=xa.bt(t),n=0<e&&e<10,s=xa.Vt(t),r=0<s&&s<4.5;return!(t.indexOf("MSIE ")>0||t.indexOf("Trident/")>0||t.indexOf("Edge/")>0||n||r)}static vt(){var t;return"undefined"!=typeof process&&"YES"===(null===(t=process.env)||void 0===t?void 0:t.St)}static Dt(t,e){return t.store(e)}static bt(t){const e=t.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=e?e[1].split("_").slice(0,2).join("."):"-1";return Number(n)}static Vt(t){const e=t.match(/Android ([\d.]+)/i),n=e?e[1].split(".").slice(0,2).join("."):"-1";return Number(n)}async Ct(t){return this.db||(Ss("SimpleDb","Opening database:",this.name),this.db=await new Promise(((e,n)=>{const s=indexedDB.open(this.name,this.version);s.onsuccess=t=>{const n=t.target.result;e(n)},s.onblocked=()=>{n(new La(t,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},s.onerror=e=>{const s=e.target.error;"VersionError"===s.name?n(new Ls(Rs.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===s.name?n(new Ls(Rs.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+s)):n(new La(t,s))},s.onupgradeneeded=t=>{Ss("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',t.oldVersion);const e=t.target.result;this.Rt.Nt(e,s.transaction,t.oldVersion,this.version).next((()=>{Ss("SimpleDb","Database upgrade to version "+this.version+" complete")}))}}))),this.kt&&(this.db.onversionchange=t=>this.kt(t)),this.db}xt(t){this.kt=t,this.db&&(this.db.onversionchange=e=>t(e))}async runTransaction(t,e,n,s){const r="readonly"===e;let i=0;for(;;){++i;try{this.db=await this.Ct(t);const e=Na.open(this.db,t,r?"readonly":"readwrite",n),i=s(e).catch((t=>(e.abort(t),Ca.reject(t)))).toPromise();return i.catch((()=>{})),await e.At,i}catch(t){const e="FirebaseError"!==t.name&&i<3;if(Ss("SimpleDb","Transaction failed with error:",t.message,"Retrying:",e),this.close(),!e)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}class Ra{constructor(t){this.$t=t,this.Ot=!1,this.Mt=null}get isDone(){return this.Ot}get Ft(){return this.Mt}set cursor(t){this.$t=t}done(){this.Ot=!0}Lt(t){this.Mt=t}delete(){return Oa(this.$t.delete())}}class La extends Ls{constructor(t,e){super(Rs.UNAVAILABLE,`IndexedDB transaction '${t}' failed: ${e}`),this.name="IndexedDbTransactionError"}}function Ma(t){return"IndexedDbTransactionError"===t.name}class Pa{constructor(t){this.store=t}put(t,e){let n;return void 0!==e?(Ss("SimpleDb","PUT",this.store.name,t,e),n=this.store.put(e,t)):(Ss("SimpleDb","PUT",this.store.name,"<auto-key>",t),n=this.store.put(t)),Oa(n)}add(t){return Ss("SimpleDb","ADD",this.store.name,t,t),Oa(this.store.add(t))}get(t){return Oa(this.store.get(t)).next((e=>(void 0===e&&(e=null),Ss("SimpleDb","GET",this.store.name,t,e),e)))}delete(t){return Ss("SimpleDb","DELETE",this.store.name,t),Oa(this.store.delete(t))}count(){return Ss("SimpleDb","COUNT",this.store.name),Oa(this.store.count())}Bt(t,e){const n=this.cursor(this.options(t,e)),s=[];return this.Ut(n,((t,e)=>{s.push(e)})).next((()=>s))}qt(t,e){Ss("SimpleDb","DELETE ALL",this.store.name);const n=this.options(t,e);n.Kt=!1;const s=this.cursor(n);return this.Ut(s,((t,e,n)=>n.delete()))}jt(t,e){let n;e?n=t:(n={},e=t);const s=this.cursor(n);return this.Ut(s,e)}Qt(t){const e=this.cursor({});return new Ca(((n,s)=>{e.onerror=t=>{const e=Va(t.target.error);s(e)},e.onsuccess=e=>{const s=e.target.result;s?t(s.primaryKey,s.value).next((t=>{t?s.continue():n()})):n()}}))}Ut(t,e){const n=[];return new Ca(((s,r)=>{t.onerror=t=>{r(t.target.error)},t.onsuccess=t=>{const r=t.target.result;if(!r)return void s();const i=new Ra(r),o=e(r.primaryKey,r.value,i);if(o instanceof Ca){const t=o.catch((t=>(i.done(),Ca.reject(t))));n.push(t)}i.isDone?s():null===i.Ft?r.continue():r.continue(i.Ft)}})).next((()=>Ca.waitFor(n)))}options(t,e){let n;return void 0!==t&&("string"==typeof t?n=t:e=t),{index:n,range:e}}cursor(t){let e="next";if(t.reverse&&(e="prev"),t.index){const n=this.store.index(t.index);return t.Kt?n.openKeyCursor(t.range,e):n.openCursor(t.range,e)}return this.store.openCursor(t.range,e)}}function Oa(t){return new Ca(((e,n)=>{t.onsuccess=t=>{const n=t.target.result;e(n)},t.onerror=t=>{const e=Va(t.target.error);n(e)}}))}let Fa=!1;function Va(t){const e=xa.bt((0,a.z$)());if(e>=12.2&&e<13){const e="An internal error was encountered in the Indexed Database server";if(t.message.indexOf(e)>=0){const t=new Ls("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${e}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return Fa||(Fa=!0,setTimeout((()=>{throw t}),0)),t}}return t}class qa extends Da{constructor(t,e){super(),this.Wt=t,this.currentSequenceNumber=e}}function Ua(t,e){const n=xs(t);return xa.Dt(n.Wt,e)}class Ba{constructor(t,e,n,s){this.batchId=t,this.localWriteTime=e,this.baseMutations=n,this.mutations=s}applyToRemoteDocument(t,e){const n=e.mutationResults;for(let e=0;e<this.mutations.length;e++){const s=this.mutations[e];s.key.isEqual(t.key)&&qi(s,t,n[e])}}applyToLocalView(t){for(const e of this.baseMutations)e.key.isEqual(t.key)&&Ui(e,t,this.localWriteTime);for(const e of this.mutations)e.key.isEqual(t.key)&&Ui(e,t,this.localWriteTime)}applyToLocalDocumentSet(t){this.mutations.forEach((e=>{const n=t.get(e.key),s=n;this.applyToLocalView(s),n.isValidDocument()||s.convertToNoDocument(Xs.min())}))}keys(){return this.mutations.reduce(((t,e)=>t.add(e.key)),go())}isEqual(t){return this.batchId===t.batchId&&Qs(this.mutations,t.mutations,((t,e)=>ji(t,e)))&&Qs(this.baseMutations,t.baseMutations,((t,e)=>ji(t,e)))}}class ja{constructor(t,e,n,s){this.batch=t,this.commitVersion=e,this.mutationResults=n,this.docVersions=s}static from(t,e,n){Cs(t.mutations.length===n.length);let s=fo();const r=t.mutations;for(let t=0;t<r.length;t++)s=s.insert(r[t].key,n[t].version);return new ja(t,e,n,s)}}class Ka{constructor(t,e,n,s,r=Xs.min(),i=Xs.min(),o=ar.EMPTY_BYTE_STRING){this.target=t,this.targetId=e,this.purpose=n,this.sequenceNumber=s,this.snapshotVersion=r,this.lastLimboFreeSnapshotVersion=i,this.resumeToken=o}withSequenceNumber(t){return new Ka(this.target,this.targetId,this.purpose,t,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken)}withResumeToken(t,e){return new Ka(this.target,this.targetId,this.purpose,this.sequenceNumber,e,this.lastLimboFreeSnapshotVersion,t)}withLastLimboFreeSnapshotVersion(t){return new Ka(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,t,this.resumeToken)}}class $a{constructor(t){this.Gt=t}}function Ga(t,e){if(e.document)return Ko(t.Gt,e.document,!!e.hasCommittedMutations);if(e.noDocument){const t=wr.fromSegments(e.noDocument.path),n=Ya(e.noDocument.readTime),s=Pr.newNoDocument(t,n);return e.hasCommittedMutations?s.setHasCommittedMutations():s}if(e.unknownDocument){const t=wr.fromSegments(e.unknownDocument.path),n=Ya(e.unknownDocument.version);return Pr.newUnknownDocument(t,n)}return Ds()}function za(t,e,n){const s=Ha(n),r=e.key.path.popLast().toArray();if(e.isFoundDocument()){const n=function(t,e){return{name:Oo(t,e.key),fields:e.data.value.mapValue.fields,updateTime:No(t,e.version.toTimestamp())}}(t.Gt,e),i=e.hasCommittedMutations;return new ya(null,null,n,i,s,r)}if(e.isNoDocument()){const t=e.key.path.toArray(),n=Wa(e.version),i=e.hasCommittedMutations;return new ya(null,new ga(t,n),null,i,s,r)}if(e.isUnknownDocument()){const t=e.key.path.toArray(),n=Wa(e.version);return new ya(new pa(t,n),null,null,!0,s,r)}return Ds()}function Ha(t){const e=t.toTimestamp();return[e.seconds,e.nanoseconds]}function Qa(t){const e=new Ys(t[0],t[1]);return Xs.fromTimestamp(e)}function Wa(t){const e=t.toTimestamp();return new ha(e.seconds,e.nanoseconds)}function Ya(t){const e=new Ys(t.seconds,t.nanoseconds);return Xs.fromTimestamp(e)}function Xa(t,e){const n=(e.baseMutations||[]).map((e=>Go(t.Gt,e)));for(let t=0;t<e.mutations.length-1;++t){const n=e.mutations[t];if(t+1<e.mutations.length&&void 0!==e.mutations[t+1].transform){const s=e.mutations[t+1];n.updateTransforms=s.transform.fieldTransforms,e.mutations.splice(t+1,1),++t}}const s=e.mutations.map((e=>Go(t.Gt,e))),r=Ys.fromMillis(e.localWriteTimeMs);return new Ba(e.batchId,r,n,s)}function Ja(t){const e=Ya(t.readTime),n=void 0!==t.lastLimboFreeSnapshotVersion?Ya(t.lastLimboFreeSnapshotVersion):Xs.min();let s;var r;return void 0!==t.query.documents?(Cs(1===(r=t.query).documents.length),s=li(ri(qo(r.documents[0])))):s=function(t){return li(Qo(t))}(t.query),new Ka(s,t.targetId,0,t.lastListenSequenceNumber,e,n,ar.fromBase64String(t.resumeToken))}function Za(t,e){const n=Wa(e.snapshotVersion),s=Wa(e.lastLimboFreeSnapshotVersion);let r;r=Ur(e.target)?zo(t.Gt,e.target):Ho(t.Gt,e.target);const i=e.resumeToken.toBase64();return new va(e.targetId,Vr(e.target),n,i,e.sequenceNumber,s,r)}function tc(t){const e=Qo({parent:t.parent,structuredQuery:t.structuredQuery});return"LAST"===t.limitType?di(e,e.limit,"L"):e}class ec{getBundleMetadata(t,e){return nc(t).get(e).next((t=>{if(t)return{id:(e=t).bundleId,createTime:Ya(e.createTime),version:e.version};var e}))}saveBundleMetadata(t,e){return nc(t).put({bundleId:(n=e).id,createTime:Wa(Lo(n.createTime)),version:n.version});var n}getNamedQuery(t,e){return sc(t).get(e).next((t=>{if(t)return{name:(e=t).name,query:tc(e.bundledQuery),readTime:Ya(e.readTime)};var e}))}saveNamedQuery(t,e){return sc(t).put(function(t){return{name:t.name,readTime:Wa(Lo(t.readTime)),bundledQuery:t.bundledQuery}}(e))}}function nc(t){return Ua(t,Sa.store)}function sc(t){return Ua(t,Aa.store)}class rc{constructor(){this.zt=new ic}addToCollectionParentIndex(t,e){return this.zt.add(e),Ca.resolve()}getCollectionParents(t,e){return Ca.resolve(this.zt.getEntries(e))}}class ic{constructor(){this.index={}}add(t){const e=t.lastSegment(),n=t.popLast(),s=this.index[e]||new io(nr.comparator),r=!s.has(n);return this.index[e]=s.add(n),r}has(t){const e=t.lastSegment(),n=t.popLast(),s=this.index[e];return s&&s.has(n)}getEntries(t){return(this.index[t]||new io(nr.comparator)).toArray()}}class oc{constructor(){this.Ht=new ic}addToCollectionParentIndex(t,e){if(!this.Ht.has(e)){const n=e.lastSegment(),s=e.popLast();t.addOnCommittedListener((()=>{this.Ht.add(e)}));const r={collectionId:n,parent:oa(s)};return ac(t).put(r)}return Ca.resolve()}getCollectionParents(t,e){const n=[],s=IDBKeyRange.bound([e,""],[Ws(e),""],!1,!0);return ac(t).Bt(s).next((t=>{for(const s of t){if(s.collectionId!==e)break;n.push(ua(s.parent))}return n}))}}function ac(t){return Ua(t,Ia.store)}const cc={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class uc{constructor(t,e,n){this.cacheSizeCollectionThreshold=t,this.percentileToCollect=e,this.maximumSequenceNumbersToCollect=n}static withCacheSize(t){return new uc(t,uc.DEFAULT_COLLECTION_PERCENTILE,uc.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function hc(t,e,n){const s=t.store(fa.store),r=t.store(ma.store),i=[],o=IDBKeyRange.only(n.batchId);let a=0;const c=s.jt({range:o},((t,e,n)=>(a++,n.delete())));i.push(c.next((()=>{Cs(1===a)})));const u=[];for(const t of n.mutations){const s=ma.key(e,t.key.path,n.batchId);i.push(r.delete(s)),u.push(t.key)}return Ca.waitFor(i).next((()=>u))}function lc(t){if(!t)return 0;let e;if(t.document)e=t.document;else if(t.unknownDocument)e=t.unknownDocument;else{if(!t.noDocument)throw Ds();e=t.noDocument}return JSON.stringify(e).length}uc.DEFAULT_COLLECTION_PERCENTILE=10,uc.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,uc.DEFAULT=new uc(41943040,uc.DEFAULT_COLLECTION_PERCENTILE,uc.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),uc.DISABLED=new uc(-1,0,0);class dc{constructor(t,e,n,s){this.userId=t,this.k=e,this.Jt=n,this.referenceDelegate=s,this.Yt={}}static Xt(t,e,n,s){Cs(""!==t.uid);const r=t.isAuthenticated()?t.uid:"";return new dc(r,e,n,s)}checkEmpty(t){let e=!0;const n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return mc(t).jt({index:fa.userMutationsIndex,range:n},((t,n,s)=>{e=!1,s.done()})).next((()=>e))}addMutationBatch(t,e,n,s){const r=gc(t),i=mc(t);return i.add({}).next((o=>{Cs("number"==typeof o);const a=new Ba(o,e,n,s),c=function(t,e,n){const s=n.baseMutations.map((e=>$o(t.Gt,e))),r=n.mutations.map((e=>$o(t.Gt,e)));return new fa(e,n.batchId,n.localWriteTime.toMillis(),s,r)}(this.k,this.userId,a),u=[];let h=new io(((t,e)=>Hs(t.canonicalString(),e.canonicalString())));for(const t of s){const e=ma.key(this.userId,t.key.path,o);h=h.add(t.key.path.popLast()),u.push(i.put(c)),u.push(r.put(e,ma.PLACEHOLDER))}return h.forEach((e=>{u.push(this.Jt.addToCollectionParentIndex(t,e))})),t.addOnCommittedListener((()=>{this.Yt[o]=a.keys()})),Ca.waitFor(u).next((()=>a))}))}lookupMutationBatch(t,e){return mc(t).get(e).next((t=>t?(Cs(t.userId===this.userId),Xa(this.k,t)):null))}Zt(t,e){return this.Yt[e]?Ca.resolve(this.Yt[e]):this.lookupMutationBatch(t,e).next((t=>{if(t){const n=t.keys();return this.Yt[e]=n,n}return null}))}getNextMutationBatchAfterBatchId(t,e){const n=e+1,s=IDBKeyRange.lowerBound([this.userId,n]);let r=null;return mc(t).jt({index:fa.userMutationsIndex,range:s},((t,e,s)=>{e.userId===this.userId&&(Cs(e.batchId>=n),r=Xa(this.k,e)),s.done()})).next((()=>r))}getHighestUnacknowledgedBatchId(t){const e=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let n=-1;return mc(t).jt({index:fa.userMutationsIndex,range:e,reverse:!0},((t,e,s)=>{n=e.batchId,s.done()})).next((()=>n))}getAllMutationBatches(t){const e=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return mc(t).Bt(fa.userMutationsIndex,e).next((t=>t.map((t=>Xa(this.k,t)))))}getAllMutationBatchesAffectingDocumentKey(t,e){const n=ma.prefixForPath(this.userId,e.path),s=IDBKeyRange.lowerBound(n),r=[];return gc(t).jt({range:s},((n,s,i)=>{const[o,a,c]=n,u=ua(a);if(o===this.userId&&e.path.isEqual(u))return mc(t).get(c).next((t=>{if(!t)throw Ds();Cs(t.userId===this.userId),r.push(Xa(this.k,t))}));i.done()})).next((()=>r))}getAllMutationBatchesAffectingDocumentKeys(t,e){let n=new io(Hs);const s=[];return e.forEach((e=>{const r=ma.prefixForPath(this.userId,e.path),i=IDBKeyRange.lowerBound(r),o=gc(t).jt({range:i},((t,s,r)=>{const[i,o,a]=t,c=ua(o);i===this.userId&&e.path.isEqual(c)?n=n.add(a):r.done()}));s.push(o)})),Ca.waitFor(s).next((()=>this.te(t,n)))}getAllMutationBatchesAffectingQuery(t,e){const n=e.path,s=n.length+1,r=ma.prefixForPath(this.userId,n),i=IDBKeyRange.lowerBound(r);let o=new io(Hs);return gc(t).jt({range:i},((t,e,r)=>{const[i,a,c]=t,u=ua(a);i===this.userId&&n.isPrefixOf(u)?u.length===s&&(o=o.add(c)):r.done()})).next((()=>this.te(t,o)))}te(t,e){const n=[],s=[];return e.forEach((e=>{s.push(mc(t).get(e).next((t=>{if(null===t)throw Ds();Cs(t.userId===this.userId),n.push(Xa(this.k,t))})))})),Ca.waitFor(s).next((()=>n))}removeMutationBatch(t,e){return hc(t.Wt,this.userId,e).next((n=>(t.addOnCommittedListener((()=>{this.ee(e.batchId)})),Ca.forEach(n,(e=>this.referenceDelegate.markPotentiallyOrphaned(t,e))))))}ee(t){delete this.Yt[t]}performConsistencyCheck(t){return this.checkEmpty(t).next((e=>{if(!e)return Ca.resolve();const n=IDBKeyRange.lowerBound(ma.prefixForUser(this.userId)),s=[];return gc(t).jt({range:n},((t,e,n)=>{if(t[0]===this.userId){const e=ua(t[1]);s.push(e)}else n.done()})).next((()=>{Cs(0===s.length)}))}))}containsKey(t,e){return fc(t,this.userId,e)}ne(t){return pc(t).get(this.userId).next((t=>t||new da(this.userId,-1,"")))}}function fc(t,e,n){const s=ma.prefixForPath(e,n.path),r=s[1],i=IDBKeyRange.lowerBound(s);let o=!1;return gc(t).jt({range:i,Kt:!0},((t,n,s)=>{const[i,a,c]=t;i===e&&a===r&&(o=!0),s.done()})).next((()=>o))}function mc(t){return Ua(t,fa.store)}function gc(t){return Ua(t,ma.store)}function pc(t){return Ua(t,da.store)}class yc{constructor(t){this.se=t}next(){return this.se+=2,this.se}static ie(){return new yc(0)}static re(){return new yc(-1)}}class wc{constructor(t,e){this.referenceDelegate=t,this.k=e}allocateTargetId(t){return this.oe(t).next((e=>{const n=new yc(e.highestTargetId);return e.highestTargetId=n.next(),this.ce(t,e).next((()=>e.highestTargetId))}))}getLastRemoteSnapshotVersion(t){return this.oe(t).next((t=>Xs.fromTimestamp(new Ys(t.lastRemoteSnapshotVersion.seconds,t.lastRemoteSnapshotVersion.nanoseconds))))}getHighestSequenceNumber(t){return this.oe(t).next((t=>t.highestListenSequenceNumber))}setTargetsMetadata(t,e,n){return this.oe(t).next((s=>(s.highestListenSequenceNumber=e,n&&(s.lastRemoteSnapshotVersion=n.toTimestamp()),e>s.highestListenSequenceNumber&&(s.highestListenSequenceNumber=e),this.ce(t,s))))}addTargetData(t,e){return this.ae(t,e).next((()=>this.oe(t).next((n=>(n.targetCount+=1,this.ue(e,n),this.ce(t,n))))))}updateTargetData(t,e){return this.ae(t,e)}removeTargetData(t,e){return this.removeMatchingKeysForTargetId(t,e.targetId).next((()=>vc(t).delete(e.targetId))).next((()=>this.oe(t))).next((e=>(Cs(e.targetCount>0),e.targetCount-=1,this.ce(t,e))))}removeTargets(t,e,n){let s=0;const r=[];return vc(t).jt(((i,o)=>{const a=Ja(o);a.sequenceNumber<=e&&null===n.get(a.targetId)&&(s++,r.push(this.removeTargetData(t,a)))})).next((()=>Ca.waitFor(r))).next((()=>s))}forEachTarget(t,e){return vc(t).jt(((t,n)=>{const s=Ja(n);e(s)}))}oe(t){return Tc(t).get(ba.key).next((t=>(Cs(null!==t),t)))}ce(t,e){return Tc(t).put(ba.key,e)}ae(t,e){return vc(t).put(Za(this.k,e))}ue(t,e){let n=!1;return t.targetId>e.highestTargetId&&(e.highestTargetId=t.targetId,n=!0),t.sequenceNumber>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=t.sequenceNumber,n=!0),n}getTargetCount(t){return this.oe(t).next((t=>t.targetCount))}getTargetData(t,e){const n=Vr(e),s=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]);let r=null;return vc(t).jt({range:s,index:va.queryTargetsIndexName},((t,n,s)=>{const i=Ja(n);qr(e,i.target)&&(r=i,s.done())})).next((()=>r))}addMatchingKeys(t,e,n){const s=[],r=bc(t);return e.forEach((e=>{const i=oa(e.path);s.push(r.put(new Ta(n,i))),s.push(this.referenceDelegate.addReference(t,n,e))})),Ca.waitFor(s)}removeMatchingKeys(t,e,n){const s=bc(t);return Ca.forEach(e,(e=>{const r=oa(e.path);return Ca.waitFor([s.delete([n,r]),this.referenceDelegate.removeReference(t,n,e)])}))}removeMatchingKeysForTargetId(t,e){const n=bc(t),s=IDBKeyRange.bound([e],[e+1],!1,!0);return n.delete(s)}getMatchingKeysForTargetId(t,e){const n=IDBKeyRange.bound([e],[e+1],!1,!0),s=bc(t);let r=go();return s.jt({range:n,Kt:!0},((t,e,n)=>{const s=ua(t[1]),i=new wr(s);r=r.add(i)})).next((()=>r))}containsKey(t,e){const n=oa(e.path),s=IDBKeyRange.bound([n],[Ws(n)],!1,!0);let r=0;return bc(t).jt({index:Ta.documentTargetsIndex,Kt:!0,range:s},(([t,e],n,s)=>{0!==t&&(r++,s.done())})).next((()=>r>0))}Et(t,e){return vc(t).get(e).next((t=>t?Ja(t):null))}}function vc(t){return Ua(t,va.store)}function Tc(t){return Ua(t,ba.store)}function bc(t){return Ua(t,Ta.store)}async function Ic(t){if(t.code!==Rs.FAILED_PRECONDITION||t.message!==ka)throw t;Ss("LocalStore","Unexpectedly lost primary lease")}function Ec([t,e],[n,s]){const r=Hs(t,n);return 0===r?Hs(e,s):r}class Sc{constructor(t){this.he=t,this.buffer=new io(Ec),this.le=0}fe(){return++this.le}de(t){const e=[t,this.fe()];if(this.buffer.size<this.he)this.buffer=this.buffer.add(e);else{const t=this.buffer.last();Ec(e,t)<0&&(this.buffer=this.buffer.delete(t).add(e))}}get maxValue(){return this.buffer.last()[0]}}class Ac{constructor(t,e){this.garbageCollector=t,this.asyncQueue=e,this.we=!1,this._e=null}start(t){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.me(t)}stop(){this._e&&(this._e.cancel(),this._e=null)}get started(){return null!==this._e}me(t){const e=this.we?3e5:6e4;Ss("LruGarbageCollector",`Garbage collection scheduled in ${e}ms`),this._e=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,(async()=>{this._e=null,this.we=!0;try{await t.collectGarbage(this.garbageCollector)}catch(t){Ma(t)?Ss("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",t):await Ic(t)}await this.me(t)}))}}class _c{constructor(t,e){this.ge=t,this.params=e}calculateTargetCount(t,e){return this.ge.ye(t).next((t=>Math.floor(e/100*t)))}nthSequenceNumber(t,e){if(0===e)return Ca.resolve($s.I);const n=new Sc(e);return this.ge.forEachTarget(t,(t=>n.de(t.sequenceNumber))).next((()=>this.ge.pe(t,(t=>n.de(t))))).next((()=>n.maxValue))}removeTargets(t,e,n){return this.ge.removeTargets(t,e,n)}removeOrphanedDocuments(t,e){return this.ge.removeOrphanedDocuments(t,e)}collect(t,e){return-1===this.params.cacheSizeCollectionThreshold?(Ss("LruGarbageCollector","Garbage collection skipped; disabled"),Ca.resolve(cc)):this.getCacheSize(t).next((n=>n<this.params.cacheSizeCollectionThreshold?(Ss("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),cc):this.Te(t,e)))}getCacheSize(t){return this.ge.getCacheSize(t)}Te(t,e){let n,s,r,i,a,c,u;const h=Date.now();return this.calculateTargetCount(t,this.params.percentileToCollect).next((e=>(e>this.params.maximumSequenceNumbersToCollect?(Ss("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${e}`),s=this.params.maximumSequenceNumbersToCollect):s=e,i=Date.now(),this.nthSequenceNumber(t,s)))).next((s=>(n=s,a=Date.now(),this.removeTargets(t,n,e)))).next((e=>(r=e,c=Date.now(),this.removeOrphanedDocuments(t,n)))).next((t=>(u=Date.now(),Is()<=o.in.DEBUG&&Ss("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${i-h}ms\n\tDetermined least recently used ${s} in `+(a-i)+"ms\n"+`\tRemoved ${r} targets in `+(c-a)+"ms\n"+`\tRemoved ${t} documents in `+(u-c)+"ms\n"+`Total Duration: ${u-h}ms`),Ca.resolve({didRun:!0,sequenceNumbersCollected:s,targetsRemoved:r,documentsRemoved:t}))))}}class kc{constructor(t,e){this.db=t,this.garbageCollector=function(t,e){return new _c(t,e)}(this,e)}ye(t){const e=this.Ee(t);return this.db.getTargetCache().getTargetCount(t).next((t=>e.next((e=>t+e))))}Ee(t){let e=0;return this.pe(t,(t=>{e++})).next((()=>e))}forEachTarget(t,e){return this.db.getTargetCache().forEachTarget(t,e)}pe(t,e){return this.Ie(t,((t,n)=>e(n)))}addReference(t,e,n){return Dc(t,n)}removeReference(t,e,n){return Dc(t,n)}removeTargets(t,e,n){return this.db.getTargetCache().removeTargets(t,e,n)}markPotentiallyOrphaned(t,e){return Dc(t,e)}Ae(t,e){return function(t,e){let n=!1;return pc(t).Qt((s=>fc(t,s,e).next((t=>(t&&(n=!0),Ca.resolve(!t)))))).next((()=>n))}(t,e)}removeOrphanedDocuments(t,e){const n=this.db.getRemoteDocumentCache().newChangeBuffer(),s=[];let r=0;return this.Ie(t,((i,o)=>{if(o<=e){const e=this.Ae(t,i).next((e=>{if(!e)return r++,n.getEntry(t,i).next((()=>(n.removeEntry(i),bc(t).delete([0,oa(i.path)]))))}));s.push(e)}})).next((()=>Ca.waitFor(s))).next((()=>n.apply(t))).next((()=>r))}removeTarget(t,e){const n=e.withSequenceNumber(t.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(t,n)}updateLimboDocument(t,e){return Dc(t,e)}Ie(t,e){const n=bc(t);let s,r=$s.I;return n.jt({index:Ta.documentTargetsIndex},(([t,n],{path:i,sequenceNumber:o})=>{0===t?(r!==$s.I&&e(new wr(ua(s)),r),r=o,s=i):r=$s.I})).next((()=>{r!==$s.I&&e(new wr(ua(s)),r)}))}getCacheSize(t){return this.db.getRemoteDocumentCache().getSize(t)}}function Dc(t,e){return bc(t).put(function(t,e){return new Ta(0,oa(t.path),e)}(e,t.currentSequenceNumber))}class Cc{constructor(t,e){this.mapKeyFn=t,this.equalsFn=e,this.inner={}}get(t){const e=this.mapKeyFn(t),n=this.inner[e];if(void 0!==n)for(const[e,s]of n)if(this.equalsFn(e,t))return s}has(t){return void 0!==this.get(t)}set(t,e){const n=this.mapKeyFn(t),s=this.inner[n];if(void 0!==s){for(let n=0;n<s.length;n++)if(this.equalsFn(s[n][0],t))return void(s[n]=[t,e]);s.push([t,e])}else this.inner[n]=[[t,e]]}delete(t){const e=this.mapKeyFn(t),n=this.inner[e];if(void 0===n)return!1;for(let s=0;s<n.length;s++)if(this.equalsFn(n[s][0],t))return 1===n.length?delete this.inner[e]:n.splice(s,1),!0;return!1}forEach(t){Zs(this.inner,((e,n)=>{for(const[e,s]of n)t(e,s)}))}isEmpty(){return tr(this.inner)}}class Nc{constructor(){this.changes=new Cc((t=>t.toString()),((t,e)=>t.isEqual(e))),this.changesApplied=!1}getReadTime(t){const e=this.changes.get(t);return e?e.readTime:Xs.min()}addEntry(t,e){this.assertNotApplied(),this.changes.set(t.key,{document:t,readTime:e})}removeEntry(t,e=null){this.assertNotApplied(),this.changes.set(t,{document:Pr.newInvalidDocument(t),readTime:e})}getEntry(t,e){this.assertNotApplied();const n=this.changes.get(e);return void 0!==n?Ca.resolve(n.document):this.getFromCache(t,e)}getEntries(t,e){return this.getAllFromCache(t,e)}apply(t){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(t)}assertNotApplied(){}}class xc{constructor(t,e){this.k=t,this.Jt=e}addEntry(t,e,n){return Mc(t).put(Pc(e),n)}removeEntry(t,e){const n=Mc(t),s=Pc(e);return n.delete(s)}updateMetadata(t,e){return this.getMetadata(t).next((n=>(n.byteSize+=e,this.Re(t,n))))}getEntry(t,e){return Mc(t).get(Pc(e)).next((t=>this.be(e,t)))}Pe(t,e){return Mc(t).get(Pc(e)).next((t=>({document:this.be(e,t),size:lc(t)})))}getEntries(t,e){let n=co();return this.ve(t,e,((t,e)=>{const s=this.be(t,e);n=n.insert(t,s)})).next((()=>n))}Ve(t,e){let n=co(),s=new no(wr.comparator);return this.ve(t,e,((t,e)=>{const r=this.be(t,e);n=n.insert(t,r),s=s.insert(t,lc(e))})).next((()=>({documents:n,Se:s})))}ve(t,e,n){if(e.isEmpty())return Ca.resolve();const s=IDBKeyRange.bound(e.first().path.toArray(),e.last().path.toArray()),r=e.getIterator();let i=r.getNext();return Mc(t).jt({range:s},((t,e,s)=>{const o=wr.fromSegments(t);for(;i&&wr.comparator(i,o)<0;)n(i,null),i=r.getNext();i&&i.isEqual(o)&&(n(i,e),i=r.hasNext()?r.getNext():null),i?s.Lt(i.path.toArray()):s.done()})).next((()=>{for(;i;)n(i,null),i=r.hasNext()?r.getNext():null}))}getDocumentsMatchingQuery(t,e,n){let s=co();const r=e.path.length+1,i={};if(n.isEqual(Xs.min())){const t=e.path.toArray();i.range=IDBKeyRange.lowerBound(t)}else{const t=e.path.toArray(),s=Ha(n);i.range=IDBKeyRange.lowerBound([t,s],!0),i.index=ya.collectionReadTimeIndex}return Mc(t).jt(i,((t,n,i)=>{if(t.length!==r)return;const o=Ga(this.k,n);e.path.isPrefixOf(o.key.path)?pi(e,o)&&(s=s.insert(o.key,o)):i.done()})).next((()=>s))}newChangeBuffer(t){return new Rc(this,!!t&&t.trackRemovals)}getSize(t){return this.getMetadata(t).next((t=>t.byteSize))}getMetadata(t){return Lc(t).get(wa.key).next((t=>(Cs(!!t),t)))}Re(t,e){return Lc(t).put(wa.key,e)}be(t,e){if(e){const t=Ga(this.k,e);if(!t.isNoDocument()||!t.version.isEqual(Xs.min()))return t}return Pr.newInvalidDocument(t)}}class Rc extends Nc{constructor(t,e){super(),this.De=t,this.trackRemovals=e,this.Ce=new Cc((t=>t.toString()),((t,e)=>t.isEqual(e)))}applyChanges(t){const e=[];let n=0,s=new io(((t,e)=>Hs(t.canonicalString(),e.canonicalString())));return this.changes.forEach(((r,i)=>{const o=this.Ce.get(r);if(i.document.isValidDocument()){const a=za(this.De.k,i.document,this.getReadTime(r));s=s.add(r.path.popLast());const c=lc(a);n+=c-o,e.push(this.De.addEntry(t,r,a))}else if(n-=o,this.trackRemovals){const n=za(this.De.k,Pr.newNoDocument(r,Xs.min()),this.getReadTime(r));e.push(this.De.addEntry(t,r,n))}else e.push(this.De.removeEntry(t,r))})),s.forEach((n=>{e.push(this.De.Jt.addToCollectionParentIndex(t,n))})),e.push(this.De.updateMetadata(t,n)),Ca.waitFor(e)}getFromCache(t,e){return this.De.Pe(t,e).next((t=>(this.Ce.set(e,t.size),t.document)))}getAllFromCache(t,e){return this.De.Ve(t,e).next((({documents:t,Se:e})=>(e.forEach(((t,e)=>{this.Ce.set(t,e)})),t)))}}function Lc(t){return Ua(t,wa.store)}function Mc(t){return Ua(t,ya.store)}function Pc(t){return t.path.toArray()}class Oc{constructor(t){this.k=t}Nt(t,e,n,s){Cs(n<s&&n>=0&&s<=11);const r=new Na("createOrUpgrade",e);n<1&&s>=1&&(function(t){t.createObjectStore(la.store)}(t),function(t){t.createObjectStore(da.store,{keyPath:da.keyPath}),t.createObjectStore(fa.store,{keyPath:fa.keyPath,autoIncrement:!0}).createIndex(fa.userMutationsIndex,fa.userMutationsKeyPath,{unique:!0}),t.createObjectStore(ma.store)}(t),Fc(t),function(t){t.createObjectStore(ya.store)}(t));let i=Ca.resolve();return n<3&&s>=3&&(0!==n&&(function(t){t.deleteObjectStore(Ta.store),t.deleteObjectStore(va.store),t.deleteObjectStore(ba.store)}(t),Fc(t)),i=i.next((()=>function(t){const e=t.store(ba.store),n=new ba(0,0,Xs.min().toTimestamp(),0);return e.put(ba.key,n)}(r)))),n<4&&s>=4&&(0!==n&&(i=i.next((()=>function(t,e){return e.store(fa.store).Bt().next((n=>{t.deleteObjectStore(fa.store),t.createObjectStore(fa.store,{keyPath:fa.keyPath,autoIncrement:!0}).createIndex(fa.userMutationsIndex,fa.userMutationsKeyPath,{unique:!0});const s=e.store(fa.store),r=n.map((t=>s.put(t)));return Ca.waitFor(r)}))}(t,r)))),i=i.next((()=>{!function(t){t.createObjectStore(Ea.store,{keyPath:Ea.keyPath})}(t)}))),n<5&&s>=5&&(i=i.next((()=>this.Ne(r)))),n<6&&s>=6&&(i=i.next((()=>(function(t){t.createObjectStore(wa.store)}(t),this.ke(r))))),n<7&&s>=7&&(i=i.next((()=>this.xe(r)))),n<8&&s>=8&&(i=i.next((()=>this.$e(t,r)))),n<9&&s>=9&&(i=i.next((()=>{!function(t){t.objectStoreNames.contains("remoteDocumentChanges")&&t.deleteObjectStore("remoteDocumentChanges")}(t),function(t){const e=t.objectStore(ya.store);e.createIndex(ya.readTimeIndex,ya.readTimeIndexPath,{unique:!1}),e.createIndex(ya.collectionReadTimeIndex,ya.collectionReadTimeIndexPath,{unique:!1})}(e)}))),n<10&&s>=10&&(i=i.next((()=>this.Oe(r)))),n<11&&s>=11&&(i=i.next((()=>{!function(t){t.createObjectStore(Sa.store,{keyPath:Sa.keyPath})}(t),function(t){t.createObjectStore(Aa.store,{keyPath:Aa.keyPath})}(t)}))),i}ke(t){let e=0;return t.store(ya.store).jt(((t,n)=>{e+=lc(n)})).next((()=>{const n=new wa(e);return t.store(wa.store).put(wa.key,n)}))}Ne(t){const e=t.store(da.store),n=t.store(fa.store);return e.Bt().next((e=>Ca.forEach(e,(e=>{const s=IDBKeyRange.bound([e.userId,-1],[e.userId,e.lastAcknowledgedBatchId]);return n.Bt(fa.userMutationsIndex,s).next((n=>Ca.forEach(n,(n=>{Cs(n.userId===e.userId);const s=Xa(this.k,n);return hc(t,e.userId,s).next((()=>{}))}))))}))))}xe(t){const e=t.store(Ta.store),n=t.store(ya.store);return t.store(ba.store).get(ba.key).next((t=>{const s=[];return n.jt(((n,r)=>{const i=new nr(n),o=function(t){return[0,oa(t)]}(i);s.push(e.get(o).next((n=>n?Ca.resolve():(n=>e.put(new Ta(0,oa(n),t.highestListenSequenceNumber)))(i))))})).next((()=>Ca.waitFor(s)))}))}$e(t,e){t.createObjectStore(Ia.store,{keyPath:Ia.keyPath});const n=e.store(Ia.store),s=new ic,r=t=>{if(s.add(t)){const e=t.lastSegment(),s=t.popLast();return n.put({collectionId:e,parent:oa(s)})}};return e.store(ya.store).jt({Kt:!0},((t,e)=>{const n=new nr(t);return r(n.popLast())})).next((()=>e.store(ma.store).jt({Kt:!0},(([t,e,n],s)=>{const i=ua(e);return r(i.popLast())}))))}Oe(t){const e=t.store(va.store);return e.jt(((t,n)=>{const s=Ja(n),r=Za(this.k,s);return e.put(r)}))}}function Fc(t){t.createObjectStore(Ta.store,{keyPath:Ta.keyPath}).createIndex(Ta.documentTargetsIndex,Ta.documentTargetsKeyPath,{unique:!0}),t.createObjectStore(va.store,{keyPath:va.keyPath}).createIndex(va.queryTargetsIndexName,va.queryTargetsKeyPath,{unique:!0}),t.createObjectStore(ba.store)}const Vc="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class qc{constructor(t,e,n,s,r,i,o,a,c,u){if(this.allowTabSynchronization=t,this.persistenceKey=e,this.clientId=n,this.Me=r,this.window=i,this.document=o,this.Fe=c,this.Le=u,this.Be=null,this.Ue=!1,this.isPrimary=!1,this.networkEnabled=!0,this.qe=null,this.inForeground=!1,this.Ke=null,this.je=null,this.Qe=Number.NEGATIVE_INFINITY,this.We=t=>Promise.resolve(),!qc.Pt())throw new Ls(Rs.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new kc(this,s),this.Ge=e+"main",this.k=new $a(a),this.ze=new xa(this.Ge,11,new Oc(this.k)),this.He=new wc(this.referenceDelegate,this.k),this.Jt=new oc,this.Je=function(t,e){return new xc(t,e)}(this.k,this.Jt),this.Ye=new ec,this.window&&this.window.localStorage?this.Xe=this.window.localStorage:(this.Xe=null,!1===u&&As("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.Ze().then((()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new Ls(Rs.FAILED_PRECONDITION,Vc);return this.tn(),this.en(),this.nn(),this.runTransaction("getHighestListenSequenceNumber","readonly",(t=>this.He.getHighestSequenceNumber(t)))})).then((t=>{this.Be=new $s(t,this.Fe)})).then((()=>{this.Ue=!0})).catch((t=>(this.ze&&this.ze.close(),Promise.reject(t))))}sn(t){return this.We=async e=>{if(this.started)return t(e)},t(this.isPrimary)}setDatabaseDeletedListener(t){this.ze.xt((async e=>{null===e.newVersion&&await t()}))}setNetworkEnabled(t){this.networkEnabled!==t&&(this.networkEnabled=t,this.Me.enqueueAndForget((async()=>{this.started&&await this.Ze()})))}Ze(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",(t=>Bc(t).put(new Ea(this.clientId,Date.now(),this.networkEnabled,this.inForeground)).next((()=>{if(this.isPrimary)return this.rn(t).next((t=>{t||(this.isPrimary=!1,this.Me.enqueueRetryable((()=>this.We(!1))))}))})).next((()=>this.on(t))).next((e=>this.isPrimary&&!e?this.cn(t).next((()=>!1)):!!e&&this.an(t).next((()=>!0)))))).catch((t=>{if(Ma(t))return Ss("IndexedDbPersistence","Failed to extend owner lease: ",t),this.isPrimary;if(!this.allowTabSynchronization)throw t;return Ss("IndexedDbPersistence","Releasing owner lease after error during lease refresh",t),!1})).then((t=>{this.isPrimary!==t&&this.Me.enqueueRetryable((()=>this.We(t))),this.isPrimary=t}))}rn(t){return Uc(t).get(la.key).next((t=>Ca.resolve(this.un(t))))}hn(t){return Bc(t).delete(this.clientId)}async ln(){if(this.isPrimary&&!this.fn(this.Qe,18e5)){this.Qe=Date.now();const t=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",(t=>{const e=Ua(t,Ea.store);return e.Bt().next((t=>{const n=this.dn(t,18e5),s=t.filter((t=>-1===n.indexOf(t)));return Ca.forEach(s,(t=>e.delete(t.clientId))).next((()=>s))}))})).catch((()=>[]));if(this.Xe)for(const e of t)this.Xe.removeItem(this.wn(e.clientId))}}nn(){this.je=this.Me.enqueueAfterDelay("client_metadata_refresh",4e3,(()=>this.Ze().then((()=>this.ln())).then((()=>this.nn()))))}un(t){return!!t&&t.ownerId===this.clientId}on(t){return this.Le?Ca.resolve(!0):Uc(t).get(la.key).next((e=>{if(null!==e&&this.fn(e.leaseTimestampMs,5e3)&&!this._n(e.ownerId)){if(this.un(e)&&this.networkEnabled)return!0;if(!this.un(e)){if(!e.allowTabSynchronization)throw new Ls(Rs.FAILED_PRECONDITION,Vc);return!1}}return!(!this.networkEnabled||!this.inForeground)||Bc(t).Bt().next((t=>void 0===this.dn(t,5e3).find((t=>{if(this.clientId!==t.clientId){const e=!this.networkEnabled&&t.networkEnabled,n=!this.inForeground&&t.inForeground,s=this.networkEnabled===t.networkEnabled;if(e||n&&s)return!0}return!1}))))})).next((t=>(this.isPrimary!==t&&Ss("IndexedDbPersistence",`Client ${t?"is":"is not"} eligible for a primary lease.`),t)))}async shutdown(){this.Ue=!1,this.mn(),this.je&&(this.je.cancel(),this.je=null),this.gn(),this.yn(),await this.ze.runTransaction("shutdown","readwrite",[la.store,Ea.store],(t=>{const e=new qa(t,$s.I);return this.cn(e).next((()=>this.hn(e)))})),this.ze.close(),this.pn()}dn(t,e){return t.filter((t=>this.fn(t.updateTimeMs,e)&&!this._n(t.clientId)))}Tn(){return this.runTransaction("getActiveClients","readonly",(t=>Bc(t).Bt().next((t=>this.dn(t,18e5).map((t=>t.clientId))))))}get started(){return this.Ue}getMutationQueue(t){return dc.Xt(t,this.k,this.Jt,this.referenceDelegate)}getTargetCache(){return this.He}getRemoteDocumentCache(){return this.Je}getIndexManager(){return this.Jt}getBundleCache(){return this.Ye}runTransaction(t,e,n){Ss("IndexedDbPersistence","Starting transaction:",t);const s="readonly"===e?"readonly":"readwrite";let r;return this.ze.runTransaction(t,s,_a,(s=>(r=new qa(s,this.Be?this.Be.next():$s.I),"readwrite-primary"===e?this.rn(r).next((t=>!!t||this.on(r))).next((e=>{if(!e)throw As(`Failed to obtain primary lease for action '${t}'.`),this.isPrimary=!1,this.Me.enqueueRetryable((()=>this.We(!1))),new Ls(Rs.FAILED_PRECONDITION,ka);return n(r)})).next((t=>this.an(r).next((()=>t)))):this.En(r).next((()=>n(r)))))).then((t=>(r.raiseOnCommittedEvent(),t)))}En(t){return Uc(t).get(la.key).next((t=>{if(null!==t&&this.fn(t.leaseTimestampMs,5e3)&&!this._n(t.ownerId)&&!this.un(t)&&!(this.Le||this.allowTabSynchronization&&t.allowTabSynchronization))throw new Ls(Rs.FAILED_PRECONDITION,Vc)}))}an(t){const e=new la(this.clientId,this.allowTabSynchronization,Date.now());return Uc(t).put(la.key,e)}static Pt(){return xa.Pt()}cn(t){const e=Uc(t);return e.get(la.key).next((t=>this.un(t)?(Ss("IndexedDbPersistence","Releasing primary lease."),e.delete(la.key)):Ca.resolve()))}fn(t,e){const n=Date.now();return!(t<n-e||t>n&&(As(`Detected an update time that is in the future: ${t} > ${n}`),1))}tn(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.Ke=()=>{this.Me.enqueueAndForget((()=>(this.inForeground="visible"===this.document.visibilityState,this.Ze())))},this.document.addEventListener("visibilitychange",this.Ke),this.inForeground="visible"===this.document.visibilityState)}gn(){this.Ke&&(this.document.removeEventListener("visibilitychange",this.Ke),this.Ke=null)}en(){var t;"function"==typeof(null===(t=this.window)||void 0===t?void 0:t.addEventListener)&&(this.qe=()=>{this.mn(),(0,a.G6)()&&navigator.appVersion.match(/Version\/1[45]/)&&this.Me.enterRestrictedMode(!0),this.Me.enqueueAndForget((()=>this.shutdown()))},this.window.addEventListener("pagehide",this.qe))}yn(){this.qe&&(this.window.removeEventListener("pagehide",this.qe),this.qe=null)}_n(t){var e;try{const n=null!==(null===(e=this.Xe)||void 0===e?void 0:e.getItem(this.wn(t)));return Ss("IndexedDbPersistence",`Client '${t}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(t){return As("IndexedDbPersistence","Failed to get zombied client id.",t),!1}}mn(){if(this.Xe)try{this.Xe.setItem(this.wn(this.clientId),String(Date.now()))}catch(t){As("Failed to set zombie client id.",t)}}pn(){if(this.Xe)try{this.Xe.removeItem(this.wn(this.clientId))}catch(t){}}wn(t){return`firestore_zombie_${this.persistenceKey}_${t}`}}function Uc(t){return Ua(t,la.store)}function Bc(t){return Ua(t,Ea.store)}function jc(t,e){let n=t.projectId;return t.isDefaultDatabase||(n+="."+t.database),"firestore/"+e+"/"+n+"/"}class Kc{constructor(t,e){this.progress=t,this.In=e}}class $c{constructor(t,e,n){this.Je=t,this.An=e,this.Jt=n}Rn(t,e){return this.An.getAllMutationBatchesAffectingDocumentKey(t,e).next((n=>this.bn(t,e,n)))}bn(t,e,n){return this.Je.getEntry(t,e).next((t=>{for(const e of n)e.applyToLocalView(t);return t}))}Pn(t,e){t.forEach(((t,n)=>{for(const t of e)t.applyToLocalView(n)}))}vn(t,e){return this.Je.getEntries(t,e).next((e=>this.Vn(t,e).next((()=>e))))}Vn(t,e){return this.An.getAllMutationBatchesAffectingDocumentKeys(t,e).next((t=>this.Pn(e,t)))}getDocumentsMatchingQuery(t,e,n){return function(t){return wr.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length}(e)?this.Sn(t,e.path):ui(e)?this.Dn(t,e,n):this.Cn(t,e,n)}Sn(t,e){return this.Rn(t,new wr(e)).next((t=>{let e=ho();return t.isFoundDocument()&&(e=e.insert(t.key,t)),e}))}Dn(t,e,n){const s=e.collectionGroup;let r=ho();return this.Jt.getCollectionParents(t,s).next((i=>Ca.forEach(i,(i=>{const o=function(t,e){return new ni(e,null,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt)}(e,i.child(s));return this.Cn(t,o,n).next((t=>{t.forEach(((t,e)=>{r=r.insert(t,e)}))}))})).next((()=>r))))}Cn(t,e,n){let s,r;return this.Je.getDocumentsMatchingQuery(t,e,n).next((n=>(s=n,this.An.getAllMutationBatchesAffectingQuery(t,e)))).next((e=>(r=e,this.Nn(t,r,s).next((t=>{s=t;for(const t of r)for(const e of t.mutations){const n=e.key;let r=s.get(n);null==r&&(r=Pr.newInvalidDocument(n),s=s.insert(n,r)),Ui(e,r,t.localWriteTime),r.isFoundDocument()||(s=s.remove(n))}}))))).next((()=>(s.forEach(((t,n)=>{pi(e,n)||(s=s.remove(t))})),s)))}Nn(t,e,n){let s=go();for(const t of e)for(const e of t.mutations)e instanceof Gi&&null===n.get(e.key)&&(s=s.add(e.key));let r=n;return this.Je.getEntries(t,s).next((t=>(t.forEach(((t,e)=>{e.isFoundDocument()&&(r=r.insert(t,e))})),r)))}}class Gc{constructor(t,e,n,s){this.targetId=t,this.fromCache=e,this.kn=n,this.xn=s}static $n(t,e){let n=go(),s=go();for(const t of e.docChanges)switch(t.type){case 0:n=n.add(t.doc.key);break;case 1:s=s.add(t.doc.key)}return new Gc(t,e.fromCache,n,s)}}class zc{On(t){this.Mn=t}getDocumentsMatchingQuery(t,e,n,s){return function(t){return 0===t.filters.length&&null===t.limit&&null==t.startAt&&null==t.endAt&&(0===t.explicitOrderBy.length||1===t.explicitOrderBy.length&&t.explicitOrderBy[0].field.isKeyField())}(e)||n.isEqual(Xs.min())?this.Fn(t,e):this.Mn.vn(t,s).next((r=>{const i=this.Ln(e,r);return(ii(e)||oi(e))&&this.Bn(e.limitType,i,s,n)?this.Fn(t,e):(Is()<=o.in.DEBUG&&Ss("QueryEngine","Re-using previous result from %s to execute query: %s",n.toString(),gi(e)),this.Mn.getDocumentsMatchingQuery(t,e,n).next((t=>(i.forEach((e=>{t=t.insert(e.key,e)})),t))))}))}Ln(t,e){let n=new io(yi(t));return e.forEach(((e,s)=>{pi(t,s)&&(n=n.add(s))})),n}Bn(t,e,n,s){if(n.size!==e.size)return!0;const r="F"===t?e.last():e.first();return!!r&&(r.hasPendingWrites||r.version.compareTo(s)>0)}Fn(t,e){return Is()<=o.in.DEBUG&&Ss("QueryEngine","Using full collection scan to execute query:",gi(e)),this.Mn.getDocumentsMatchingQuery(t,e,Xs.min())}}class Hc{constructor(t,e,n,s){this.persistence=t,this.Un=e,this.k=s,this.qn=new no(Hs),this.Kn=new Cc((t=>Vr(t)),qr),this.jn=Xs.min(),this.An=t.getMutationQueue(n),this.Qn=t.getRemoteDocumentCache(),this.He=t.getTargetCache(),this.Wn=new $c(this.Qn,this.An,this.persistence.getIndexManager()),this.Ye=t.getBundleCache(),this.Un.On(this.Wn)}collectGarbage(t){return this.persistence.runTransaction("Collect garbage","readwrite-primary",(e=>t.collect(e,this.qn)))}}function Qc(t,e,n,s){return new Hc(t,e,n,s)}async function Wc(t,e){const n=xs(t);let s=n.An,r=n.Wn;const i=await n.persistence.runTransaction("Handle user change","readonly",(t=>{let i;return n.An.getAllMutationBatches(t).next((o=>(i=o,s=n.persistence.getMutationQueue(e),r=new $c(n.Qn,s,n.persistence.getIndexManager()),s.getAllMutationBatches(t)))).next((e=>{const n=[],s=[];let o=go();for(const t of i){n.push(t.batchId);for(const e of t.mutations)o=o.add(e.key)}for(const t of e){s.push(t.batchId);for(const e of t.mutations)o=o.add(e.key)}return r.vn(t,o).next((t=>({Gn:t,removedBatchIds:n,addedBatchIds:s})))}))}));return n.An=s,n.Wn=r,n.Un.On(n.Wn),i}function Yc(t){const e=xs(t);return e.persistence.runTransaction("Get last remote snapshot version","readonly",(t=>e.He.getLastRemoteSnapshotVersion(t)))}function Xc(t,e,n,s,r){let i=go();return n.forEach((t=>i=i.add(t))),e.getEntries(t,i).next((t=>{let i=co();return n.forEach(((n,o)=>{const a=t.get(n),c=(null==r?void 0:r.get(n))||s;o.isNoDocument()&&o.version.isEqual(Xs.min())?(e.removeEntry(n,c),i=i.insert(n,o)):!a.isValidDocument()||o.version.compareTo(a.version)>0||0===o.version.compareTo(a.version)&&a.hasPendingWrites?(e.addEntry(o,c),i=i.insert(n,o)):Ss("LocalStore","Ignoring outdated watch update for ",n,". Current version:",a.version," Watch version:",o.version)})),i}))}function Jc(t,e){const n=xs(t);return n.persistence.runTransaction("Get next mutation batch","readonly",(t=>(void 0===e&&(e=-1),n.An.getNextMutationBatchAfterBatchId(t,e))))}function Zc(t,e){const n=xs(t);return n.persistence.runTransaction("Allocate target","readwrite",(t=>{let s;return n.He.getTargetData(t,e).next((r=>r?(s=r,Ca.resolve(s)):n.He.allocateTargetId(t).next((r=>(s=new Ka(e,r,0,t.currentSequenceNumber),n.He.addTargetData(t,s).next((()=>s)))))))})).then((t=>{const s=n.qn.get(t.targetId);return(null===s||t.snapshotVersion.compareTo(s.snapshotVersion)>0)&&(n.qn=n.qn.insert(t.targetId,t),n.Kn.set(e,t.targetId)),t}))}async function tu(t,e,n){const s=xs(t),r=s.qn.get(e),i=n?"readwrite":"readwrite-primary";try{n||await s.persistence.runTransaction("Release target",i,(t=>s.persistence.referenceDelegate.removeTarget(t,r)))}catch(t){if(!Ma(t))throw t;Ss("LocalStore",`Failed to update sequence numbers for target ${e}: ${t}`)}s.qn=s.qn.remove(e),s.Kn.delete(r.target)}function eu(t,e,n){const s=xs(t);let r=Xs.min(),i=go();return s.persistence.runTransaction("Execute query","readonly",(t=>function(t,e,n){const s=xs(t),r=s.Kn.get(n);return void 0!==r?Ca.resolve(s.qn.get(r)):s.He.getTargetData(e,n)}(s,t,li(e)).next((e=>{if(e)return r=e.lastLimboFreeSnapshotVersion,s.He.getMatchingKeysForTargetId(t,e.targetId).next((t=>{i=t}))})).next((()=>s.Un.getDocumentsMatchingQuery(t,e,n?r:Xs.min(),n?i:go()))).next((t=>({documents:t,zn:i})))))}function nu(t,e){const n=xs(t),s=xs(n.He),r=n.qn.get(e);return r?Promise.resolve(r.target):n.persistence.runTransaction("Get target data","readonly",(t=>s.Et(t,e).next((t=>t?t.target:null))))}function su(t){const e=xs(t);return e.persistence.runTransaction("Get new document changes","readonly",(t=>function(t,e,n){const s=xs(t);let r=co(),i=Ha(n);const o=Mc(e),a=IDBKeyRange.lowerBound(i,!0);return o.jt({index:ya.readTimeIndex,range:a},((t,e)=>{const n=Ga(s.k,e);r=r.insert(n.key,n),i=e.readTime})).next((()=>({In:r,readTime:Qa(i)})))}(e.Qn,t,e.jn))).then((({In:t,readTime:n})=>(e.jn=n,t)))}async function ru(t,e,n=go()){const s=await Zc(t,li(tc(e.bundledQuery))),r=xs(t);return r.persistence.runTransaction("Save named query","readwrite",(t=>{const i=Lo(e.readTime);if(s.snapshotVersion.compareTo(i)>=0)return r.Ye.saveNamedQuery(t,e);const o=s.withResumeToken(ar.EMPTY_BYTE_STRING,i);return r.qn=r.qn.insert(o.targetId,o),r.He.updateTargetData(t,o).next((()=>r.He.removeMatchingKeysForTargetId(t,s.targetId))).next((()=>r.He.addMatchingKeys(t,n,s.targetId))).next((()=>r.Ye.saveNamedQuery(t,e)))}))}class iu{constructor(t){this.k=t,this.Xn=new Map,this.Zn=new Map}getBundleMetadata(t,e){return Ca.resolve(this.Xn.get(e))}saveBundleMetadata(t,e){var n;return this.Xn.set(e.id,{id:(n=e).id,version:n.version,createTime:Lo(n.createTime)}),Ca.resolve()}getNamedQuery(t,e){return Ca.resolve(this.Zn.get(e))}saveNamedQuery(t,e){return this.Zn.set(e.name,function(t){return{name:t.name,query:tc(t.bundledQuery),readTime:Lo(t.readTime)}}(e)),Ca.resolve()}}class ou{constructor(){this.ts=new io(au.es),this.ns=new io(au.ss)}isEmpty(){return this.ts.isEmpty()}addReference(t,e){const n=new au(t,e);this.ts=this.ts.add(n),this.ns=this.ns.add(n)}rs(t,e){t.forEach((t=>this.addReference(t,e)))}removeReference(t,e){this.os(new au(t,e))}cs(t,e){t.forEach((t=>this.removeReference(t,e)))}us(t){const e=new wr(new nr([])),n=new au(e,t),s=new au(e,t+1),r=[];return this.ns.forEachInRange([n,s],(t=>{this.os(t),r.push(t.key)})),r}hs(){this.ts.forEach((t=>this.os(t)))}os(t){this.ts=this.ts.delete(t),this.ns=this.ns.delete(t)}ls(t){const e=new wr(new nr([])),n=new au(e,t),s=new au(e,t+1);let r=go();return this.ns.forEachInRange([n,s],(t=>{r=r.add(t.key)})),r}containsKey(t){const e=new au(t,0),n=this.ts.firstAfterOrEqual(e);return null!==n&&t.isEqual(n.key)}}class au{constructor(t,e){this.key=t,this.fs=e}static es(t,e){return wr.comparator(t.key,e.key)||Hs(t.fs,e.fs)}static ss(t,e){return Hs(t.fs,e.fs)||wr.comparator(t.key,e.key)}}class cu{constructor(t,e){this.Jt=t,this.referenceDelegate=e,this.An=[],this.ds=1,this.ws=new io(au.es)}checkEmpty(t){return Ca.resolve(0===this.An.length)}addMutationBatch(t,e,n,s){const r=this.ds;this.ds++,this.An.length>0&&this.An[this.An.length-1];const i=new Ba(r,e,n,s);this.An.push(i);for(const e of s)this.ws=this.ws.add(new au(e.key,r)),this.Jt.addToCollectionParentIndex(t,e.key.path.popLast());return Ca.resolve(i)}lookupMutationBatch(t,e){return Ca.resolve(this._s(e))}getNextMutationBatchAfterBatchId(t,e){const n=e+1,s=this.gs(n),r=s<0?0:s;return Ca.resolve(this.An.length>r?this.An[r]:null)}getHighestUnacknowledgedBatchId(){return Ca.resolve(0===this.An.length?-1:this.ds-1)}getAllMutationBatches(t){return Ca.resolve(this.An.slice())}getAllMutationBatchesAffectingDocumentKey(t,e){const n=new au(e,0),s=new au(e,Number.POSITIVE_INFINITY),r=[];return this.ws.forEachInRange([n,s],(t=>{const e=this._s(t.fs);r.push(e)})),Ca.resolve(r)}getAllMutationBatchesAffectingDocumentKeys(t,e){let n=new io(Hs);return e.forEach((t=>{const e=new au(t,0),s=new au(t,Number.POSITIVE_INFINITY);this.ws.forEachInRange([e,s],(t=>{n=n.add(t.fs)}))})),Ca.resolve(this.ys(n))}getAllMutationBatchesAffectingQuery(t,e){const n=e.path,s=n.length+1;let r=n;wr.isDocumentKey(r)||(r=r.child(""));const i=new au(new wr(r),0);let o=new io(Hs);return this.ws.forEachWhile((t=>{const e=t.key.path;return!!n.isPrefixOf(e)&&(e.length===s&&(o=o.add(t.fs)),!0)}),i),Ca.resolve(this.ys(o))}ys(t){const e=[];return t.forEach((t=>{const n=this._s(t);null!==n&&e.push(n)})),e}removeMutationBatch(t,e){Cs(0===this.ps(e.batchId,"removed")),this.An.shift();let n=this.ws;return Ca.forEach(e.mutations,(s=>{const r=new au(s.key,e.batchId);return n=n.delete(r),this.referenceDelegate.markPotentiallyOrphaned(t,s.key)})).next((()=>{this.ws=n}))}ee(t){}containsKey(t,e){const n=new au(e,0),s=this.ws.firstAfterOrEqual(n);return Ca.resolve(e.isEqual(s&&s.key))}performConsistencyCheck(t){return this.An.length,Ca.resolve()}ps(t,e){return this.gs(t)}gs(t){return 0===this.An.length?0:t-this.An[0].batchId}_s(t){const e=this.gs(t);return e<0||e>=this.An.length?null:this.An[e]}}class uu{constructor(t,e){this.Jt=t,this.Ts=e,this.docs=new no(wr.comparator),this.size=0}addEntry(t,e,n){const s=e.key,r=this.docs.get(s),i=r?r.size:0,o=this.Ts(e);return this.docs=this.docs.insert(s,{document:e.mutableCopy(),size:o,readTime:n}),this.size+=o-i,this.Jt.addToCollectionParentIndex(t,s.path.popLast())}removeEntry(t){const e=this.docs.get(t);e&&(this.docs=this.docs.remove(t),this.size-=e.size)}getEntry(t,e){const n=this.docs.get(e);return Ca.resolve(n?n.document.mutableCopy():Pr.newInvalidDocument(e))}getEntries(t,e){let n=co();return e.forEach((t=>{const e=this.docs.get(t);n=n.insert(t,e?e.document.mutableCopy():Pr.newInvalidDocument(t))})),Ca.resolve(n)}getDocumentsMatchingQuery(t,e,n){let s=co();const r=new wr(e.path.child("")),i=this.docs.getIteratorFrom(r);for(;i.hasNext();){const{key:t,value:{document:r,readTime:o}}=i.getNext();if(!e.path.isPrefixOf(t.path))break;o.compareTo(n)<=0||pi(e,r)&&(s=s.insert(r.key,r.mutableCopy()))}return Ca.resolve(s)}Es(t,e){return Ca.forEach(this.docs,(t=>e(t)))}newChangeBuffer(t){return new hu(this)}getSize(t){return Ca.resolve(this.size)}}class hu extends Nc{constructor(t){super(),this.De=t}applyChanges(t){const e=[];return this.changes.forEach(((n,s)=>{s.document.isValidDocument()?e.push(this.De.addEntry(t,s.document,this.getReadTime(n))):this.De.removeEntry(n)})),Ca.waitFor(e)}getFromCache(t,e){return this.De.getEntry(t,e)}getAllFromCache(t,e){return this.De.getEntries(t,e)}}class lu{constructor(t){this.persistence=t,this.Is=new Cc((t=>Vr(t)),qr),this.lastRemoteSnapshotVersion=Xs.min(),this.highestTargetId=0,this.As=0,this.Rs=new ou,this.targetCount=0,this.bs=yc.ie()}forEachTarget(t,e){return this.Is.forEach(((t,n)=>e(n))),Ca.resolve()}getLastRemoteSnapshotVersion(t){return Ca.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(t){return Ca.resolve(this.As)}allocateTargetId(t){return this.highestTargetId=this.bs.next(),Ca.resolve(this.highestTargetId)}setTargetsMetadata(t,e,n){return n&&(this.lastRemoteSnapshotVersion=n),e>this.As&&(this.As=e),Ca.resolve()}ae(t){this.Is.set(t.target,t);const e=t.targetId;e>this.highestTargetId&&(this.bs=new yc(e),this.highestTargetId=e),t.sequenceNumber>this.As&&(this.As=t.sequenceNumber)}addTargetData(t,e){return this.ae(e),this.targetCount+=1,Ca.resolve()}updateTargetData(t,e){return this.ae(e),Ca.resolve()}removeTargetData(t,e){return this.Is.delete(e.target),this.Rs.us(e.targetId),this.targetCount-=1,Ca.resolve()}removeTargets(t,e,n){let s=0;const r=[];return this.Is.forEach(((i,o)=>{o.sequenceNumber<=e&&null===n.get(o.targetId)&&(this.Is.delete(i),r.push(this.removeMatchingKeysForTargetId(t,o.targetId)),s++)})),Ca.waitFor(r).next((()=>s))}getTargetCount(t){return Ca.resolve(this.targetCount)}getTargetData(t,e){const n=this.Is.get(e)||null;return Ca.resolve(n)}addMatchingKeys(t,e,n){return this.Rs.rs(e,n),Ca.resolve()}removeMatchingKeys(t,e,n){this.Rs.cs(e,n);const s=this.persistence.referenceDelegate,r=[];return s&&e.forEach((e=>{r.push(s.markPotentiallyOrphaned(t,e))})),Ca.waitFor(r)}removeMatchingKeysForTargetId(t,e){return this.Rs.us(e),Ca.resolve()}getMatchingKeysForTargetId(t,e){const n=this.Rs.ls(e);return Ca.resolve(n)}containsKey(t,e){return Ca.resolve(this.Rs.containsKey(e))}}class du{constructor(t,e){this.Ps={},this.Be=new $s(0),this.Ue=!1,this.Ue=!0,this.referenceDelegate=t(this),this.He=new lu(this),this.Jt=new rc,this.Je=function(t,e){return new uu(t,e)}(this.Jt,(t=>this.referenceDelegate.vs(t))),this.k=new $a(e),this.Ye=new iu(this.k)}start(){return Promise.resolve()}shutdown(){return this.Ue=!1,Promise.resolve()}get started(){return this.Ue}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(){return this.Jt}getMutationQueue(t){let e=this.Ps[t.toKey()];return e||(e=new cu(this.Jt,this.referenceDelegate),this.Ps[t.toKey()]=e),e}getTargetCache(){return this.He}getRemoteDocumentCache(){return this.Je}getBundleCache(){return this.Ye}runTransaction(t,e,n){Ss("MemoryPersistence","Starting transaction:",t);const s=new fu(this.Be.next());return this.referenceDelegate.Vs(),n(s).next((t=>this.referenceDelegate.Ss(s).next((()=>t)))).toPromise().then((t=>(s.raiseOnCommittedEvent(),t)))}Ds(t,e){return Ca.or(Object.values(this.Ps).map((n=>()=>n.containsKey(t,e))))}}class fu extends Da{constructor(t){super(),this.currentSequenceNumber=t}}class mu{constructor(t){this.persistence=t,this.Cs=new ou,this.Ns=null}static ks(t){return new mu(t)}get xs(){if(this.Ns)return this.Ns;throw Ds()}addReference(t,e,n){return this.Cs.addReference(n,e),this.xs.delete(n.toString()),Ca.resolve()}removeReference(t,e,n){return this.Cs.removeReference(n,e),this.xs.add(n.toString()),Ca.resolve()}markPotentiallyOrphaned(t,e){return this.xs.add(e.toString()),Ca.resolve()}removeTarget(t,e){this.Cs.us(e.targetId).forEach((t=>this.xs.add(t.toString())));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(t,e.targetId).next((t=>{t.forEach((t=>this.xs.add(t.toString())))})).next((()=>n.removeTargetData(t,e)))}Vs(){this.Ns=new Set}Ss(t){const e=this.persistence.getRemoteDocumentCache().newChangeBuffer();return Ca.forEach(this.xs,(n=>{const s=wr.fromPath(n);return this.$s(t,s).next((t=>{t||e.removeEntry(s)}))})).next((()=>(this.Ns=null,e.apply(t))))}updateLimboDocument(t,e){return this.$s(t,e).next((t=>{t?this.xs.delete(e.toString()):this.xs.add(e.toString())}))}vs(t){return 0}$s(t,e){return Ca.or([()=>Ca.resolve(this.Cs.containsKey(e)),()=>this.persistence.getTargetCache().containsKey(t,e),()=>this.persistence.Ds(t,e)])}}function gu(t,e){return`firestore_clients_${t}_${e}`}function pu(t,e,n){let s=`firestore_mutations_${t}_${n}`;return e.isAuthenticated()&&(s+=`_${e.uid}`),s}function yu(t,e){return`firestore_targets_${t}_${e}`}class wu{constructor(t,e,n,s){this.user=t,this.batchId=e,this.state=n,this.error=s}static Os(t,e,n){const s=JSON.parse(n);let r,i="object"==typeof s&&-1!==["pending","acknowledged","rejected"].indexOf(s.state)&&(void 0===s.error||"object"==typeof s.error);return i&&s.error&&(i="string"==typeof s.error.message&&"string"==typeof s.error.code,i&&(r=new Ls(s.error.code,s.error.message))),i?new wu(t,e,s.state,r):(As("SharedClientState",`Failed to parse mutation state for ID '${e}': ${n}`),null)}Ms(){const t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}}class vu{constructor(t,e,n){this.targetId=t,this.state=e,this.error=n}static Os(t,e){const n=JSON.parse(e);let s,r="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return r&&n.error&&(r="string"==typeof n.error.message&&"string"==typeof n.error.code,r&&(s=new Ls(n.error.code,n.error.message))),r?new vu(t,n.state,s):(As("SharedClientState",`Failed to parse target state for ID '${t}': ${e}`),null)}Ms(){const t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}}class Tu{constructor(t,e){this.clientId=t,this.activeTargetIds=e}static Os(t,e){const n=JSON.parse(e);let s="object"==typeof n&&n.activeTargetIds instanceof Array,r=yo();for(let t=0;s&&t<n.activeTargetIds.length;++t)s=yr(n.activeTargetIds[t]),r=r.add(n.activeTargetIds[t]);return s?new Tu(t,r):(As("SharedClientState",`Failed to parse client data for instance '${t}': ${e}`),null)}}class bu{constructor(t,e){this.clientId=t,this.onlineState=e}static Os(t){const e=JSON.parse(t);return"object"==typeof e&&-1!==["Unknown","Online","Offline"].indexOf(e.onlineState)&&"string"==typeof e.clientId?new bu(e.clientId,e.onlineState):(As("SharedClientState",`Failed to parse online state: ${t}`),null)}}class Iu{constructor(){this.activeTargetIds=yo()}Fs(t){this.activeTargetIds=this.activeTargetIds.add(t)}Ls(t){this.activeTargetIds=this.activeTargetIds.delete(t)}Ms(){const t={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(t)}}class Eu{constructor(t,e,n,s,r){this.window=t,this.Me=e,this.persistenceKey=n,this.Bs=s,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.Us=this.qs.bind(this),this.Ks=new no(Hs),this.started=!1,this.js=[];const i=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=r,this.Qs=gu(this.persistenceKey,this.Bs),this.Ws=function(t){return`firestore_sequence_number_${t}`}(this.persistenceKey),this.Ks=this.Ks.insert(this.Bs,new Iu),this.Gs=new RegExp(`^firestore_clients_${i}_([^_]*)$`),this.zs=new RegExp(`^firestore_mutations_${i}_(\\d+)(?:_(.*))?$`),this.Hs=new RegExp(`^firestore_targets_${i}_(\\d+)$`),this.Js=function(t){return`firestore_online_state_${t}`}(this.persistenceKey),this.Ys=function(t){return`firestore_bundle_loaded_${t}`}(this.persistenceKey),this.window.addEventListener("storage",this.Us)}static Pt(t){return!(!t||!t.localStorage)}async start(){const t=await this.syncEngine.Tn();for(const e of t){if(e===this.Bs)continue;const t=this.getItem(gu(this.persistenceKey,e));if(t){const n=Tu.Os(e,t);n&&(this.Ks=this.Ks.insert(n.clientId,n))}}this.Xs();const e=this.storage.getItem(this.Js);if(e){const t=this.Zs(e);t&&this.ti(t)}for(const t of this.js)this.qs(t);this.js=[],this.window.addEventListener("pagehide",(()=>this.shutdown())),this.started=!0}writeSequenceNumber(t){this.setItem(this.Ws,JSON.stringify(t))}getAllActiveQueryTargets(){return this.ei(this.Ks)}isActiveQueryTarget(t){let e=!1;return this.Ks.forEach(((n,s)=>{s.activeTargetIds.has(t)&&(e=!0)})),e}addPendingMutation(t){this.ni(t,"pending")}updateMutationState(t,e,n){this.ni(t,e,n),this.si(t)}addLocalQueryTarget(t){let e="not-current";if(this.isActiveQueryTarget(t)){const n=this.storage.getItem(yu(this.persistenceKey,t));if(n){const s=vu.Os(t,n);s&&(e=s.state)}}return this.ii.Fs(t),this.Xs(),e}removeLocalQueryTarget(t){this.ii.Ls(t),this.Xs()}isLocalQueryTarget(t){return this.ii.activeTargetIds.has(t)}clearQueryState(t){this.removeItem(yu(this.persistenceKey,t))}updateQueryState(t,e,n){this.ri(t,e,n)}handleUserChange(t,e,n){e.forEach((t=>{this.si(t)})),this.currentUser=t,n.forEach((t=>{this.addPendingMutation(t)}))}setOnlineState(t){this.oi(t)}notifyBundleLoaded(){this.ci()}shutdown(){this.started&&(this.window.removeEventListener("storage",this.Us),this.removeItem(this.Qs),this.started=!1)}getItem(t){const e=this.storage.getItem(t);return Ss("SharedClientState","READ",t,e),e}setItem(t,e){Ss("SharedClientState","SET",t,e),this.storage.setItem(t,e)}removeItem(t){Ss("SharedClientState","REMOVE",t),this.storage.removeItem(t)}qs(t){const e=t;if(e.storageArea===this.storage){if(Ss("SharedClientState","EVENT",e.key,e.newValue),e.key===this.Qs)return void As("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.Me.enqueueRetryable((async()=>{if(this.started){if(null!==e.key)if(this.Gs.test(e.key)){if(null==e.newValue){const t=this.ai(e.key);return this.ui(t,null)}{const t=this.hi(e.key,e.newValue);if(t)return this.ui(t.clientId,t)}}else if(this.zs.test(e.key)){if(null!==e.newValue){const t=this.li(e.key,e.newValue);if(t)return this.fi(t)}}else if(this.Hs.test(e.key)){if(null!==e.newValue){const t=this.di(e.key,e.newValue);if(t)return this.wi(t)}}else if(e.key===this.Js){if(null!==e.newValue){const t=this.Zs(e.newValue);if(t)return this.ti(t)}}else if(e.key===this.Ws){const t=function(t){let e=$s.I;if(null!=t)try{const n=JSON.parse(t);Cs("number"==typeof n),e=n}catch(t){As("SharedClientState","Failed to read sequence number from WebStorage",t)}return e}(e.newValue);t!==$s.I&&this.sequenceNumberHandler(t)}else if(e.key===this.Ys)return this.syncEngine._i()}else this.js.push(e)}))}}get ii(){return this.Ks.get(this.Bs)}Xs(){this.setItem(this.Qs,this.ii.Ms())}ni(t,e,n){const s=new wu(this.currentUser,t,e,n),r=pu(this.persistenceKey,this.currentUser,t);this.setItem(r,s.Ms())}si(t){const e=pu(this.persistenceKey,this.currentUser,t);this.removeItem(e)}oi(t){const e={clientId:this.Bs,onlineState:t};this.storage.setItem(this.Js,JSON.stringify(e))}ri(t,e,n){const s=yu(this.persistenceKey,t),r=new vu(t,e,n);this.setItem(s,r.Ms())}ci(){this.setItem(this.Ys,"value-not-used")}ai(t){const e=this.Gs.exec(t);return e?e[1]:null}hi(t,e){const n=this.ai(t);return Tu.Os(n,e)}li(t,e){const n=this.zs.exec(t),s=Number(n[1]),r=void 0!==n[2]?n[2]:null;return wu.Os(new vs(r),s,e)}di(t,e){const n=this.Hs.exec(t),s=Number(n[1]);return vu.Os(s,e)}Zs(t){return bu.Os(t)}async fi(t){if(t.user.uid===this.currentUser.uid)return this.syncEngine.mi(t.batchId,t.state,t.error);Ss("SharedClientState",`Ignoring mutation for non-active user ${t.user.uid}`)}wi(t){return this.syncEngine.gi(t.targetId,t.state,t.error)}ui(t,e){const n=e?this.Ks.insert(t,e):this.Ks.remove(t),s=this.ei(this.Ks),r=this.ei(n),i=[],o=[];return r.forEach((t=>{s.has(t)||i.push(t)})),s.forEach((t=>{r.has(t)||o.push(t)})),this.syncEngine.yi(i,o).then((()=>{this.Ks=n}))}ti(t){this.Ks.get(t.clientId)&&this.onlineStateHandler(t.onlineState)}ei(t){let e=yo();return t.forEach(((t,n)=>{e=e.unionWith(n.activeTargetIds)})),e}}class Su{constructor(){this.pi=new Iu,this.Ti={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(t){}updateMutationState(t,e,n){}addLocalQueryTarget(t){return this.pi.Fs(t),this.Ti[t]||"not-current"}updateQueryState(t,e,n){this.Ti[t]=e}removeLocalQueryTarget(t){this.pi.Ls(t)}isLocalQueryTarget(t){return this.pi.activeTargetIds.has(t)}clearQueryState(t){delete this.Ti[t]}getAllActiveQueryTargets(){return this.pi.activeTargetIds}isActiveQueryTarget(t){return this.pi.activeTargetIds.has(t)}start(){return this.pi=new Iu,Promise.resolve()}handleUserChange(t,e,n){}setOnlineState(t){}shutdown(){}writeSequenceNumber(t){}notifyBundleLoaded(){}}class Au{Ei(t){}shutdown(){}}class _u{constructor(){this.Ii=()=>this.Ai(),this.Ri=()=>this.bi(),this.Pi=[],this.vi()}Ei(t){this.Pi.push(t)}shutdown(){window.removeEventListener("online",this.Ii),window.removeEventListener("offline",this.Ri)}vi(){window.addEventListener("online",this.Ii),window.addEventListener("offline",this.Ri)}Ai(){Ss("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const t of this.Pi)t(0)}bi(){Ss("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const t of this.Pi)t(1)}static Pt(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}const ku={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery"};class Du{constructor(t){this.Vi=t.Vi,this.Si=t.Si}Di(t){this.Ci=t}Ni(t){this.ki=t}onMessage(t){this.xi=t}close(){this.Si()}send(t){this.Vi(t)}$i(){this.Ci()}Oi(t){this.ki(t)}Mi(t){this.xi(t)}}class Cu extends class{constructor(t){this.databaseInfo=t,this.databaseId=t.databaseId;const e=t.ssl?"https":"http";this.Fi=e+"://"+t.host,this.Li="projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database+"/documents"}Bi(t,e,n,s,r){const i=this.Ui(t,e);Ss("RestConnection","Sending: ",i,n);const o={};return this.qi(o,s,r),this.Ki(t,i,o,n).then((t=>(Ss("RestConnection","Received: ",t),t)),(e=>{throw _s("RestConnection",`${t} failed with error: `,e,"url: ",i,"request:",n),e}))}ji(t,e,n,s,r){return this.Bi(t,e,n,s,r)}qi(t,e,n){t["X-Goog-Api-Client"]="gl-js/ fire/"+Ts,t["Content-Type"]="text/plain",this.databaseInfo.appId&&(t["X-Firebase-GMPID"]=this.databaseInfo.appId),e&&e.headers.forEach(((e,n)=>t[n]=e)),n&&n.headers.forEach(((e,n)=>t[n]=e))}Ui(t,e){const n=ku[t];return`${this.Fi}/v1/${e}:${n}`}}{constructor(t){super(t),this.forceLongPolling=t.forceLongPolling,this.autoDetectLongPolling=t.autoDetectLongPolling,this.useFetchStreams=t.useFetchStreams}Ki(t,e,n,s){return new Promise(((r,i)=>{const o=new ys;o.listenOnce(ds.COMPLETE,(()=>{try{switch(o.getLastErrorCode()){case ls.NO_ERROR:const e=o.getResponseJson();Ss("Connection","XHR received:",JSON.stringify(e)),r(e);break;case ls.TIMEOUT:Ss("Connection",'RPC "'+t+'" timed out'),i(new Ls(Rs.DEADLINE_EXCEEDED,"Request time out"));break;case ls.HTTP_ERROR:const n=o.getStatus();if(Ss("Connection",'RPC "'+t+'" failed with status:',n,"response text:",o.getResponseText()),n>0){const t=o.getResponseJson().error;if(t&&t.status&&t.message){const e=function(t){const e=t.toLowerCase().replace(/_/g,"-");return Object.values(Rs).indexOf(e)>=0?e:Rs.UNKNOWN}(t.status);i(new Ls(e,t.message))}else i(new Ls(Rs.UNKNOWN,"Server responded with status "+o.getStatus()))}else i(new Ls(Rs.UNAVAILABLE,"Connection failed."));break;default:Ds()}}finally{Ss("Connection",'RPC "'+t+'" completed.')}}));const a=JSON.stringify(s);o.send(e,"POST",a,n,15)}))}Qi(t,e,n){const s=[this.Fi,"/","google.firestore.v1.Firestore","/",t,"/channel"],r=us(),i=hs(),o={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling};this.useFetchStreams&&(o.xmlHttpFactory=new gs({})),this.qi(o.initMessageHeaders,e,n),(0,a.uI)()||(0,a.b$)()||(0,a.d)()||(0,a.w1)()||(0,a.Mn)()||(0,a.ru)()||(o.httpHeadersOverwriteParam="$httpHeaders");const c=s.join("");Ss("Connection","Creating WebChannel: "+c,o);const u=r.createWebChannel(c,o);let h=!1,l=!1;const d=new Du({Vi:t=>{l?Ss("Connection","Not sending because WebChannel is closed:",t):(h||(Ss("Connection","Opening WebChannel transport."),u.open(),h=!0),Ss("Connection","WebChannel sending:",t),u.send(t))},Si:()=>u.close()}),f=(t,e,n)=>{t.listen(e,(t=>{try{n(t)}catch(t){setTimeout((()=>{throw t}),0)}}))};return f(u,ps.EventType.OPEN,(()=>{l||Ss("Connection","WebChannel transport opened.")})),f(u,ps.EventType.CLOSE,(()=>{l||(l=!0,Ss("Connection","WebChannel transport closed"),d.Oi())})),f(u,ps.EventType.ERROR,(t=>{l||(l=!0,_s("Connection","WebChannel transport errored:",t),d.Oi(new Ls(Rs.UNAVAILABLE,"The operation could not be completed")))})),f(u,ps.EventType.MESSAGE,(t=>{var e;if(!l){const n=t.data[0];Cs(!!n);const s=n,r=s.error||(null===(e=s[0])||void 0===e?void 0:e.error);if(r){Ss("Connection","WebChannel received error:",r);const t=r.status;let e=function(t){const e=Ji[t];if(void 0!==e)return eo(e)}(t),n=r.message;void 0===e&&(e=Rs.INTERNAL,n="Unknown error status: "+t+" with message "+r.message),l=!0,d.Oi(new Ls(e,n)),u.close()}else Ss("Connection","WebChannel received:",n),d.Mi(n)}})),f(i,fs.STAT_EVENT,(t=>{t.stat===ms.PROXY?Ss("Connection","Detected buffering proxy"):t.stat===ms.NOPROXY&&Ss("Connection","Detected no buffering proxy")})),setTimeout((()=>{d.$i()}),0),d}}function Nu(){return"undefined"!=typeof window?window:null}function xu(){return"undefined"!=typeof document?document:null}function Ru(t){return new Co(t,!0)}class Lu{constructor(t,e,n=1e3,s=1.5,r=6e4){this.Me=t,this.timerId=e,this.Wi=n,this.Gi=s,this.zi=r,this.Hi=0,this.Ji=null,this.Yi=Date.now(),this.reset()}reset(){this.Hi=0}Xi(){this.Hi=this.zi}Zi(t){this.cancel();const e=Math.floor(this.Hi+this.tr()),n=Math.max(0,Date.now()-this.Yi),s=Math.max(0,e-n);s>0&&Ss("ExponentialBackoff",`Backing off for ${s} ms (base delay: ${this.Hi} ms, delay with jitter: ${e} ms, last attempt: ${n} ms ago)`),this.Ji=this.Me.enqueueAfterDelay(this.timerId,s,(()=>(this.Yi=Date.now(),t()))),this.Hi*=this.Gi,this.Hi<this.Wi&&(this.Hi=this.Wi),this.Hi>this.zi&&(this.Hi=this.zi)}er(){null!==this.Ji&&(this.Ji.skipDelay(),this.Ji=null)}cancel(){null!==this.Ji&&(this.Ji.cancel(),this.Ji=null)}tr(){return(Math.random()-.5)*this.Hi}}class Mu{constructor(t,e,n,s,r,i,o,a){this.Me=t,this.nr=n,this.sr=s,this.ir=r,this.authCredentialsProvider=i,this.appCheckCredentialsProvider=o,this.listener=a,this.state=0,this.rr=0,this.cr=null,this.ar=null,this.stream=null,this.ur=new Lu(t,e)}hr(){return 1===this.state||5===this.state||this.lr()}lr(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.dr()}async stop(){this.hr()&&await this.close(0)}wr(){this.state=0,this.ur.reset()}_r(){this.lr()&&null===this.cr&&(this.cr=this.Me.enqueueAfterDelay(this.nr,6e4,(()=>this.mr())))}gr(t){this.yr(),this.stream.send(t)}async mr(){if(this.lr())return this.close(0)}yr(){this.cr&&(this.cr.cancel(),this.cr=null)}pr(){this.ar&&(this.ar.cancel(),this.ar=null)}async close(t,e){this.yr(),this.pr(),this.ur.cancel(),this.rr++,4!==t?this.ur.reset():e&&e.code===Rs.RESOURCE_EXHAUSTED?(As(e.toString()),As("Using maximum backoff delay to prevent overloading the backend."),this.ur.Xi()):e&&e.code===Rs.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.Tr(),this.stream.close(),this.stream=null),this.state=t,await this.listener.Ni(e)}Tr(){}auth(){this.state=1;const t=this.Er(this.rr),e=this.rr;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then((([t,n])=>{this.rr===e&&this.Ir(t,n)}),(e=>{t((()=>{const t=new Ls(Rs.UNKNOWN,"Fetching auth token failed: "+e.message);return this.Ar(t)}))}))}Ir(t,e){const n=this.Er(this.rr);this.stream=this.Rr(t,e),this.stream.Di((()=>{n((()=>(this.state=2,this.ar=this.Me.enqueueAfterDelay(this.sr,1e4,(()=>(this.lr()&&(this.state=3),Promise.resolve()))),this.listener.Di())))})),this.stream.Ni((t=>{n((()=>this.Ar(t)))})),this.stream.onMessage((t=>{n((()=>this.onMessage(t)))}))}dr(){this.state=5,this.ur.Zi((async()=>{this.state=0,this.start()}))}Ar(t){return Ss("PersistentStream",`close with error: ${t}`),this.stream=null,this.close(4,t)}Er(t){return e=>{this.Me.enqueueAndForget((()=>this.rr===t?e():(Ss("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())))}}}class Pu extends Mu{constructor(t,e,n,s,r,i){super(t,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",e,n,s,i),this.k=r}Rr(t,e){return this.ir.Qi("Listen",t,e)}onMessage(t){this.ur.reset();const e=function(t,e){let n;if("targetChange"in e){e.targetChange;const s=function(t){return"NO_CHANGE"===t?0:"ADD"===t?1:"REMOVE"===t?2:"CURRENT"===t?3:"RESET"===t?4:Ds()}(e.targetChange.targetChangeType||"NO_CHANGE"),r=e.targetChange.targetIds||[],i=function(t,e){return t.C?(Cs(void 0===e||"string"==typeof e),ar.fromBase64String(e||"")):(Cs(void 0===e||e instanceof Uint8Array),ar.fromUint8Array(e||new Uint8Array))}(t,e.targetChange.resumeToken),o=e.targetChange.cause,a=o&&function(t){const e=void 0===t.code?Rs.UNKNOWN:eo(t.code);return new Ls(e,t.message||"")}(o);n=new Io(s,r,i,a||null)}else if("documentChange"in e){e.documentChange;const s=e.documentChange;s.document,s.document.name,s.document.updateTime;const r=Fo(t,s.document.name),i=Lo(s.document.updateTime),o=new Lr({mapValue:{fields:s.document.fields}}),a=Pr.newFoundDocument(r,i,o),c=s.targetIds||[],u=s.removedTargetIds||[];n=new To(c,u,a.key,a)}else if("documentDelete"in e){e.documentDelete;const s=e.documentDelete;s.document;const r=Fo(t,s.document),i=s.readTime?Lo(s.readTime):Xs.min(),o=Pr.newNoDocument(r,i),a=s.removedTargetIds||[];n=new To([],a,o.key,o)}else if("documentRemove"in e){e.documentRemove;const s=e.documentRemove;s.document;const r=Fo(t,s.document),i=s.removedTargetIds||[];n=new To([],i,r,null)}else{if(!("filter"in e))return Ds();{e.filter;const t=e.filter;t.targetId;const s=t.count||0,r=new Xi(s),i=t.targetId;n=new bo(i,r)}}return n}(this.k,t),n=function(t){if(!("targetChange"in t))return Xs.min();const e=t.targetChange;return e.targetIds&&e.targetIds.length?Xs.min():e.readTime?Lo(e.readTime):Xs.min()}(t);return this.listener.br(e,n)}Pr(t){const e={};e.database=Uo(this.k),e.addTarget=function(t,e){let n;const s=e.target;return n=Ur(s)?{documents:zo(t,s)}:{query:Ho(t,s)},n.targetId=e.targetId,e.resumeToken.approximateByteSize()>0?n.resumeToken=xo(t,e.resumeToken):e.snapshotVersion.compareTo(Xs.min())>0&&(n.readTime=No(t,e.snapshotVersion.toTimestamp())),n}(this.k,t);const n=function(t,e){const n=function(t,e){switch(e){case 0:return null;case 1:return"existence-filter-mismatch";case 2:return"limbo-document";default:return Ds()}}(0,e.purpose);return null==n?null:{"goog-listen-tags":n}}(this.k,t);n&&(e.labels=n),this.gr(e)}vr(t){const e={};e.database=Uo(this.k),e.removeTarget=t,this.gr(e)}}class Ou extends Mu{constructor(t,e,n,s,r,i){super(t,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",e,n,s,i),this.k=r,this.Vr=!1}get Sr(){return this.Vr}start(){this.Vr=!1,this.lastStreamToken=void 0,super.start()}Tr(){this.Vr&&this.Dr([])}Rr(t,e){return this.ir.Qi("Write",t,e)}onMessage(t){if(Cs(!!t.streamToken),this.lastStreamToken=t.streamToken,this.Vr){this.ur.reset();const e=function(t,e){return t&&t.length>0?(Cs(void 0!==e),t.map((t=>function(t,e){let n=t.updateTime?Lo(t.updateTime):Lo(e);return n.isEqual(Xs.min())&&(n=Lo(e)),new Pi(n,t.transformResults||[])}(t,e)))):[]}(t.writeResults,t.commitTime),n=Lo(t.commitTime);return this.listener.Cr(n,e)}return Cs(!t.writeResults||0===t.writeResults.length),this.Vr=!0,this.listener.Nr()}kr(){const t={};t.database=Uo(this.k),this.gr(t)}Dr(t){const e={streamToken:this.lastStreamToken,writes:t.map((t=>$o(this.k,t)))};this.gr(e)}}class Fu extends class{}{constructor(t,e,n,s){super(),this.authCredentials=t,this.appCheckCredentials=e,this.ir=n,this.k=s,this.$r=!1}Or(){if(this.$r)throw new Ls(Rs.FAILED_PRECONDITION,"The client has already been terminated.")}Bi(t,e,n){return this.Or(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([s,r])=>this.ir.Bi(t,e,n,s,r))).catch((t=>{throw"FirebaseError"===t.name?(t.code===Rs.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),t):new Ls(Rs.UNKNOWN,t.toString())}))}ji(t,e,n){return this.Or(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([s,r])=>this.ir.ji(t,e,n,s,r))).catch((t=>{throw"FirebaseError"===t.name?(t.code===Rs.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),t):new Ls(Rs.UNKNOWN,t.toString())}))}terminate(){this.$r=!0}}class Vu{constructor(t,e){this.asyncQueue=t,this.onlineStateHandler=e,this.state="Unknown",this.Mr=0,this.Fr=null,this.Lr=!0}Br(){0===this.Mr&&(this.Ur("Unknown"),this.Fr=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,(()=>(this.Fr=null,this.qr("Backend didn't respond within 10 seconds."),this.Ur("Offline"),Promise.resolve()))))}Kr(t){"Online"===this.state?this.Ur("Unknown"):(this.Mr++,this.Mr>=1&&(this.jr(),this.qr(`Connection failed 1 times. Most recent error: ${t.toString()}`),this.Ur("Offline")))}set(t){this.jr(),this.Mr=0,"Online"===t&&(this.Lr=!1),this.Ur(t)}Ur(t){t!==this.state&&(this.state=t,this.onlineStateHandler(t))}qr(t){const e=`Could not reach Cloud Firestore backend. ${t}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.Lr?(As(e),this.Lr=!1):Ss("OnlineStateTracker",e)}jr(){null!==this.Fr&&(this.Fr.cancel(),this.Fr=null)}}class qu{constructor(t,e,n,s,r){this.localStore=t,this.datastore=e,this.asyncQueue=n,this.remoteSyncer={},this.Qr=[],this.Wr=new Map,this.Gr=new Set,this.zr=[],this.Hr=r,this.Hr.Ei((t=>{n.enqueueAndForget((async()=>{Qu(this)&&(Ss("RemoteStore","Restarting streams for network reachability change."),await async function(t){const e=xs(t);e.Gr.add(4),await Bu(e),e.Jr.set("Unknown"),e.Gr.delete(4),await Uu(e)}(this))}))})),this.Jr=new Vu(n,s)}}async function Uu(t){if(Qu(t))for(const e of t.zr)await e(!0)}async function Bu(t){for(const e of t.zr)await e(!1)}function ju(t,e){const n=xs(t);n.Wr.has(e.targetId)||(n.Wr.set(e.targetId,e),Hu(n)?zu(n):lh(n).lr()&&$u(n,e))}function Ku(t,e){const n=xs(t),s=lh(n);n.Wr.delete(e),s.lr()&&Gu(n,e),0===n.Wr.size&&(s.lr()?s._r():Qu(n)&&n.Jr.set("Unknown"))}function $u(t,e){t.Yr.X(e.targetId),lh(t).Pr(e)}function Gu(t,e){t.Yr.X(e),lh(t).vr(e)}function zu(t){t.Yr=new So({getRemoteKeysForTarget:e=>t.remoteSyncer.getRemoteKeysForTarget(e),Et:e=>t.Wr.get(e)||null}),lh(t).start(),t.Jr.Br()}function Hu(t){return Qu(t)&&!lh(t).hr()&&t.Wr.size>0}function Qu(t){return 0===xs(t).Gr.size}function Wu(t){t.Yr=void 0}async function Yu(t){t.Wr.forEach(((e,n)=>{$u(t,e)}))}async function Xu(t,e){Wu(t),Hu(t)?(t.Jr.Kr(e),zu(t)):t.Jr.set("Unknown")}async function Ju(t,e,n){if(t.Jr.set("Online"),e instanceof Io&&2===e.state&&e.cause)try{await async function(t,e){const n=e.cause;for(const s of e.targetIds)t.Wr.has(s)&&(await t.remoteSyncer.rejectListen(s,n),t.Wr.delete(s),t.Yr.removeTarget(s))}(t,e)}catch(n){Ss("RemoteStore","Failed to remove targets %s: %s ",e.targetIds.join(","),n),await Zu(t,n)}else if(e instanceof To?t.Yr.ot(e):e instanceof bo?t.Yr.dt(e):t.Yr.ut(e),!n.isEqual(Xs.min()))try{const e=await Yc(t.localStore);n.compareTo(e)>=0&&await function(t,e){const n=t.Yr.gt(e);return n.targetChanges.forEach(((n,s)=>{if(n.resumeToken.approximateByteSize()>0){const r=t.Wr.get(s);r&&t.Wr.set(s,r.withResumeToken(n.resumeToken,e))}})),n.targetMismatches.forEach((e=>{const n=t.Wr.get(e);if(!n)return;t.Wr.set(e,n.withResumeToken(ar.EMPTY_BYTE_STRING,n.snapshotVersion)),Gu(t,e);const s=new Ka(n.target,e,1,n.sequenceNumber);$u(t,s)})),t.remoteSyncer.applyRemoteEvent(n)}(t,n)}catch(e){Ss("RemoteStore","Failed to raise snapshot:",e),await Zu(t,e)}}async function Zu(t,e,n){if(!Ma(e))throw e;t.Gr.add(1),await Bu(t),t.Jr.set("Offline"),n||(n=()=>Yc(t.localStore)),t.asyncQueue.enqueueRetryable((async()=>{Ss("RemoteStore","Retrying IndexedDB access"),await n(),t.Gr.delete(1),await Uu(t)}))}function th(t,e){return e().catch((n=>Zu(t,n,e)))}async function eh(t){const e=xs(t),n=dh(e);let s=e.Qr.length>0?e.Qr[e.Qr.length-1].batchId:-1;for(;nh(e);)try{const t=await Jc(e.localStore,s);if(null===t){0===e.Qr.length&&n._r();break}s=t.batchId,sh(e,t)}catch(t){await Zu(e,t)}rh(e)&&ih(e)}function nh(t){return Qu(t)&&t.Qr.length<10}function sh(t,e){t.Qr.push(e);const n=dh(t);n.lr()&&n.Sr&&n.Dr(e.mutations)}function rh(t){return Qu(t)&&!dh(t).hr()&&t.Qr.length>0}function ih(t){dh(t).start()}async function oh(t){dh(t).kr()}async function ah(t){const e=dh(t);for(const n of t.Qr)e.Dr(n.mutations)}async function ch(t,e,n){const s=t.Qr.shift(),r=ja.from(s,e,n);await th(t,(()=>t.remoteSyncer.applySuccessfulWrite(r))),await eh(t)}async function uh(t,e){e&&dh(t).Sr&&await async function(t,e){if(to(n=e.code)&&n!==Rs.ABORTED){const n=t.Qr.shift();dh(t).wr(),await th(t,(()=>t.remoteSyncer.rejectFailedWrite(n.batchId,e))),await eh(t)}var n}(t,e),rh(t)&&ih(t)}async function hh(t,e){const n=xs(t);e?(n.Gr.delete(2),await Uu(n)):e||(n.Gr.add(2),await Bu(n),n.Jr.set("Unknown"))}function lh(t){return t.Xr||(t.Xr=function(t,e,n){const s=xs(t);return s.Or(),new Pu(e,s.ir,s.authCredentials,s.appCheckCredentials,s.k,n)}(t.datastore,t.asyncQueue,{Di:Yu.bind(null,t),Ni:Xu.bind(null,t),br:Ju.bind(null,t)}),t.zr.push((async e=>{e?(t.Xr.wr(),Hu(t)?zu(t):t.Jr.set("Unknown")):(await t.Xr.stop(),Wu(t))}))),t.Xr}function dh(t){return t.Zr||(t.Zr=function(t,e,n){const s=xs(t);return s.Or(),new Ou(e,s.ir,s.authCredentials,s.appCheckCredentials,s.k,n)}(t.datastore,t.asyncQueue,{Di:oh.bind(null,t),Ni:uh.bind(null,t),Nr:ah.bind(null,t),Cr:ch.bind(null,t)}),t.zr.push((async e=>{e?(t.Zr.wr(),await eh(t)):(await t.Zr.stop(),t.Qr.length>0&&(Ss("RemoteStore",`Stopping write stream with ${t.Qr.length} pending writes`),t.Qr=[]))}))),t.Zr}class fh{constructor(t,e,n,s,r){this.asyncQueue=t,this.timerId=e,this.targetTimeMs=n,this.op=s,this.removalCallback=r,this.deferred=new Ms,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch((t=>{}))}static createAndSchedule(t,e,n,s,r){const i=Date.now()+n,o=new fh(t,e,i,s,r);return o.start(n),o}start(t){this.timerHandle=setTimeout((()=>this.handleDelayElapsed()),t)}skipDelay(){return this.handleDelayElapsed()}cancel(t){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new Ls(Rs.CANCELLED,"Operation cancelled"+(t?": "+t:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget((()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then((t=>this.deferred.resolve(t)))):Promise.resolve()))}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function mh(t,e){if(As("AsyncQueue",`${e}: ${t}`),Ma(t))return new Ls(Rs.UNAVAILABLE,`${e}: ${t}`);throw t}class gh{constructor(t){this.comparator=t?(e,n)=>t(e,n)||wr.comparator(e.key,n.key):(t,e)=>wr.comparator(t.key,e.key),this.keyedMap=ho(),this.sortedSet=new no(this.comparator)}static emptySet(t){return new gh(t.comparator)}has(t){return null!=this.keyedMap.get(t)}get(t){return this.keyedMap.get(t)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(t){const e=this.keyedMap.get(t);return e?this.sortedSet.indexOf(e):-1}get size(){return this.sortedSet.size}forEach(t){this.sortedSet.inorderTraversal(((e,n)=>(t(e),!1)))}add(t){const e=this.delete(t.key);return e.copy(e.keyedMap.insert(t.key,t),e.sortedSet.insert(t,null))}delete(t){const e=this.get(t);return e?this.copy(this.keyedMap.remove(t),this.sortedSet.remove(e)):this}isEqual(t){if(!(t instanceof gh))return!1;if(this.size!==t.size)return!1;const e=this.sortedSet.getIterator(),n=t.sortedSet.getIterator();for(;e.hasNext();){const t=e.getNext().key,s=n.getNext().key;if(!t.isEqual(s))return!1}return!0}toString(){const t=[];return this.forEach((e=>{t.push(e.toString())})),0===t.length?"DocumentSet ()":"DocumentSet (\n  "+t.join("  \n")+"\n)"}copy(t,e){const n=new gh;return n.comparator=this.comparator,n.keyedMap=t,n.sortedSet=e,n}}class ph{constructor(){this.eo=new no(wr.comparator)}track(t){const e=t.doc.key,n=this.eo.get(e);n?0!==t.type&&3===n.type?this.eo=this.eo.insert(e,t):3===t.type&&1!==n.type?this.eo=this.eo.insert(e,{type:n.type,doc:t.doc}):2===t.type&&2===n.type?this.eo=this.eo.insert(e,{type:2,doc:t.doc}):2===t.type&&0===n.type?this.eo=this.eo.insert(e,{type:0,doc:t.doc}):1===t.type&&0===n.type?this.eo=this.eo.remove(e):1===t.type&&2===n.type?this.eo=this.eo.insert(e,{type:1,doc:n.doc}):0===t.type&&1===n.type?this.eo=this.eo.insert(e,{type:2,doc:t.doc}):Ds():this.eo=this.eo.insert(e,t)}no(){const t=[];return this.eo.inorderTraversal(((e,n)=>{t.push(n)})),t}}class yh{constructor(t,e,n,s,r,i,o,a){this.query=t,this.docs=e,this.oldDocs=n,this.docChanges=s,this.mutatedKeys=r,this.fromCache=i,this.syncStateChanged=o,this.excludesMetadataChanges=a}static fromInitialDocuments(t,e,n,s){const r=[];return e.forEach((t=>{r.push({type:0,doc:t})})),new yh(t,e,gh.emptySet(e),r,n,s,!0,!1)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(t){if(!(this.fromCache===t.fromCache&&this.syncStateChanged===t.syncStateChanged&&this.mutatedKeys.isEqual(t.mutatedKeys)&&fi(this.query,t.query)&&this.docs.isEqual(t.docs)&&this.oldDocs.isEqual(t.oldDocs)))return!1;const e=this.docChanges,n=t.docChanges;if(e.length!==n.length)return!1;for(let t=0;t<e.length;t++)if(e[t].type!==n[t].type||!e[t].doc.isEqual(n[t].doc))return!1;return!0}}class wh{constructor(){this.so=void 0,this.listeners=[]}}class vh{constructor(){this.queries=new Cc((t=>mi(t)),fi),this.onlineState="Unknown",this.io=new Set}}async function Th(t,e){const n=xs(t),s=e.query;let r=!1,i=n.queries.get(s);if(i||(r=!0,i=new wh),r)try{i.so=await n.onListen(s)}catch(t){const n=mh(t,`Initialization of query '${gi(e.query)}' failed`);return void e.onError(n)}n.queries.set(s,i),i.listeners.push(e),e.ro(n.onlineState),i.so&&e.oo(i.so)&&Sh(n)}async function bh(t,e){const n=xs(t),s=e.query;let r=!1;const i=n.queries.get(s);if(i){const t=i.listeners.indexOf(e);t>=0&&(i.listeners.splice(t,1),r=0===i.listeners.length)}if(r)return n.queries.delete(s),n.onUnlisten(s)}function Ih(t,e){const n=xs(t);let s=!1;for(const t of e){const e=t.query,r=n.queries.get(e);if(r){for(const e of r.listeners)e.oo(t)&&(s=!0);r.so=t}}s&&Sh(n)}function Eh(t,e,n){const s=xs(t),r=s.queries.get(e);if(r)for(const t of r.listeners)t.onError(n);s.queries.delete(e)}function Sh(t){t.io.forEach((t=>{t.next()}))}class Ah{constructor(t,e,n){this.query=t,this.co=e,this.ao=!1,this.uo=null,this.onlineState="Unknown",this.options=n||{}}oo(t){if(!this.options.includeMetadataChanges){const e=[];for(const n of t.docChanges)3!==n.type&&e.push(n);t=new yh(t.query,t.docs,t.oldDocs,e,t.mutatedKeys,t.fromCache,t.syncStateChanged,!0)}let e=!1;return this.ao?this.ho(t)&&(this.co.next(t),e=!0):this.lo(t,this.onlineState)&&(this.fo(t),e=!0),this.uo=t,e}onError(t){this.co.error(t)}ro(t){this.onlineState=t;let e=!1;return this.uo&&!this.ao&&this.lo(this.uo,t)&&(this.fo(this.uo),e=!0),e}lo(t,e){if(!t.fromCache)return!0;const n="Offline"!==e;return!(this.options.wo&&n||t.docs.isEmpty()&&"Offline"!==e)}ho(t){if(t.docChanges.length>0)return!0;const e=this.uo&&this.uo.hasPendingWrites!==t.hasPendingWrites;return!(!t.syncStateChanged&&!e)&&!0===this.options.includeMetadataChanges}fo(t){t=yh.fromInitialDocuments(t.query,t.docs,t.mutatedKeys,t.fromCache),this.ao=!0,this.co.next(t)}}class _h{constructor(t,e){this.payload=t,this.byteLength=e}_o(){return"metadata"in this.payload}}class kh{constructor(t){this.k=t}Hn(t){return Fo(this.k,t)}Jn(t){return t.metadata.exists?Ko(this.k,t.document,!1):Pr.newNoDocument(this.Hn(t.metadata.name),this.Yn(t.metadata.readTime))}Yn(t){return Lo(t)}}class Dh{constructor(t,e,n){this.mo=t,this.localStore=e,this.k=n,this.queries=[],this.documents=[],this.progress=Ch(t)}yo(t){this.progress.bytesLoaded+=t.byteLength;let e=this.progress.documentsLoaded;return t.payload.namedQuery?this.queries.push(t.payload.namedQuery):t.payload.documentMetadata?(this.documents.push({metadata:t.payload.documentMetadata}),t.payload.documentMetadata.exists||++e):t.payload.document&&(this.documents[this.documents.length-1].document=t.payload.document,++e),e!==this.progress.documentsLoaded?(this.progress.documentsLoaded=e,Object.assign({},this.progress)):null}po(t){const e=new Map,n=new kh(this.k);for(const s of t)if(s.metadata.queries){const t=n.Hn(s.metadata.name);for(const n of s.metadata.queries){const s=(e.get(n)||go()).add(t);e.set(n,s)}}return e}async complete(){const t=await async function(t,e,n,s){const r=xs(t);let i=go(),o=co(),a=fo();for(const t of n){const n=e.Hn(t.metadata.name);t.document&&(i=i.add(n)),o=o.insert(n,e.Jn(t)),a=a.insert(n,e.Yn(t.metadata.readTime))}const c=r.Qn.newChangeBuffer({trackRemovals:!0}),u=await Zc(r,function(t){return li(ri(nr.fromString(`__bundle__/docs/${t}`)))}(s));return r.persistence.runTransaction("Apply bundle documents","readwrite",(t=>Xc(t,c,o,Xs.min(),a).next((e=>(c.apply(t),e))).next((e=>r.He.removeMatchingKeysForTargetId(t,u.targetId).next((()=>r.He.addMatchingKeys(t,i,u.targetId))).next((()=>r.Wn.Vn(t,e))).next((()=>e))))))}(this.localStore,new kh(this.k),this.documents,this.mo.id),e=this.po(this.documents);for(const t of this.queries)await ru(this.localStore,t,e.get(t.name));return this.progress.taskState="Success",new Kc(Object.assign({},this.progress),t)}}function Ch(t){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:t.totalDocuments,totalBytes:t.totalBytes}}class Nh{constructor(t){this.key=t}}class xh{constructor(t){this.key=t}}class Rh{constructor(t,e){this.query=t,this.To=e,this.Eo=null,this.current=!1,this.Io=go(),this.mutatedKeys=go(),this.Ao=yi(t),this.Ro=new gh(this.Ao)}get bo(){return this.To}Po(t,e){const n=e?e.vo:new ph,s=e?e.Ro:this.Ro;let r=e?e.mutatedKeys:this.mutatedKeys,i=s,o=!1;const a=ii(this.query)&&s.size===this.query.limit?s.last():null,c=oi(this.query)&&s.size===this.query.limit?s.first():null;if(t.inorderTraversal(((t,e)=>{const u=s.get(t),h=pi(this.query,e)?e:null,l=!!u&&this.mutatedKeys.has(u.key),d=!!h&&(h.hasLocalMutations||this.mutatedKeys.has(h.key)&&h.hasCommittedMutations);let f=!1;u&&h?u.data.isEqual(h.data)?l!==d&&(n.track({type:3,doc:h}),f=!0):this.Vo(u,h)||(n.track({type:2,doc:h}),f=!0,(a&&this.Ao(h,a)>0||c&&this.Ao(h,c)<0)&&(o=!0)):!u&&h?(n.track({type:0,doc:h}),f=!0):u&&!h&&(n.track({type:1,doc:u}),f=!0,(a||c)&&(o=!0)),f&&(h?(i=i.add(h),r=d?r.add(t):r.delete(t)):(i=i.delete(t),r=r.delete(t)))})),ii(this.query)||oi(this.query))for(;i.size>this.query.limit;){const t=ii(this.query)?i.last():i.first();i=i.delete(t.key),r=r.delete(t.key),n.track({type:1,doc:t})}return{Ro:i,vo:n,Bn:o,mutatedKeys:r}}Vo(t,e){return t.hasLocalMutations&&e.hasCommittedMutations&&!e.hasLocalMutations}applyChanges(t,e,n){const s=this.Ro;this.Ro=t.Ro,this.mutatedKeys=t.mutatedKeys;const r=t.vo.no();r.sort(((t,e)=>function(t,e){const n=t=>{switch(t){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return Ds()}};return n(t)-n(e)}(t.type,e.type)||this.Ao(t.doc,e.doc))),this.So(n);const i=e?this.Do():[],o=0===this.Io.size&&this.current?1:0,a=o!==this.Eo;return this.Eo=o,0!==r.length||a?{snapshot:new yh(this.query,t.Ro,s,r,t.mutatedKeys,0===o,a,!1),Co:i}:{Co:i}}ro(t){return this.current&&"Offline"===t?(this.current=!1,this.applyChanges({Ro:this.Ro,vo:new ph,mutatedKeys:this.mutatedKeys,Bn:!1},!1)):{Co:[]}}No(t){return!this.To.has(t)&&!!this.Ro.has(t)&&!this.Ro.get(t).hasLocalMutations}So(t){t&&(t.addedDocuments.forEach((t=>this.To=this.To.add(t))),t.modifiedDocuments.forEach((t=>{})),t.removedDocuments.forEach((t=>this.To=this.To.delete(t))),this.current=t.current)}Do(){if(!this.current)return[];const t=this.Io;this.Io=go(),this.Ro.forEach((t=>{this.No(t.key)&&(this.Io=this.Io.add(t.key))}));const e=[];return t.forEach((t=>{this.Io.has(t)||e.push(new xh(t))})),this.Io.forEach((n=>{t.has(n)||e.push(new Nh(n))})),e}ko(t){this.To=t.zn,this.Io=go();const e=this.Po(t.documents);return this.applyChanges(e,!0)}xo(){return yh.fromInitialDocuments(this.query,this.Ro,this.mutatedKeys,0===this.Eo)}}class Lh{constructor(t,e,n){this.query=t,this.targetId=e,this.view=n}}class Mh{constructor(t){this.key=t,this.$o=!1}}class Ph{constructor(t,e,n,s,r,i){this.localStore=t,this.remoteStore=e,this.eventManager=n,this.sharedClientState=s,this.currentUser=r,this.maxConcurrentLimboResolutions=i,this.Oo={},this.Mo=new Cc((t=>mi(t)),fi),this.Fo=new Map,this.Lo=new Set,this.Bo=new no(wr.comparator),this.Uo=new Map,this.qo=new ou,this.Ko={},this.jo=new Map,this.Qo=yc.re(),this.onlineState="Unknown",this.Wo=void 0}get isPrimaryClient(){return!0===this.Wo}}async function Oh(t,e){const n=cl(t);let s,r;const i=n.Mo.get(e);if(i)s=i.targetId,n.sharedClientState.addLocalQueryTarget(s),r=i.view.xo();else{const t=await Zc(n.localStore,li(e)),i=n.sharedClientState.addLocalQueryTarget(t.targetId);s=t.targetId,r=await Fh(n,e,s,"current"===i),n.isPrimaryClient&&ju(n.remoteStore,t)}return r}async function Fh(t,e,n,s){t.Go=(e,n,s)=>async function(t,e,n,s){let r=e.view.Po(n);r.Bn&&(r=await eu(t.localStore,e.query,!1).then((({documents:t})=>e.view.Po(t,r))));const i=s&&s.targetChanges.get(e.targetId),o=e.view.applyChanges(r,t.isPrimaryClient,i);return Qh(t,e.targetId,o.Co),o.snapshot}(t,e,n,s);const r=await eu(t.localStore,e,!0),i=new Rh(e,r.zn),o=i.Po(r.documents),a=vo.createSynthesizedTargetChangeForCurrentChange(n,s&&"Offline"!==t.onlineState),c=i.applyChanges(o,t.isPrimaryClient,a);Qh(t,n,c.Co);const u=new Lh(e,n,i);return t.Mo.set(e,u),t.Fo.has(n)?t.Fo.get(n).push(e):t.Fo.set(n,[e]),c.snapshot}async function Vh(t,e){const n=xs(t),s=n.Mo.get(e),r=n.Fo.get(s.targetId);if(r.length>1)return n.Fo.set(s.targetId,r.filter((t=>!fi(t,e)))),void n.Mo.delete(e);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(s.targetId),n.sharedClientState.isActiveQueryTarget(s.targetId)||await tu(n.localStore,s.targetId,!1).then((()=>{n.sharedClientState.clearQueryState(s.targetId),Ku(n.remoteStore,s.targetId),zh(n,s.targetId)})).catch(Ic)):(zh(n,s.targetId),await tu(n.localStore,s.targetId,!0))}async function qh(t,e){const n=xs(t);try{const t=await function(t,e){const n=xs(t),s=e.snapshotVersion;let r=n.qn;return n.persistence.runTransaction("Apply remote event","readwrite-primary",(t=>{const i=n.Qn.newChangeBuffer({trackRemovals:!0});r=n.qn;const o=[];e.targetChanges.forEach(((i,a)=>{const c=r.get(a);if(!c)return;o.push(n.He.removeMatchingKeys(t,i.removedDocuments,a).next((()=>n.He.addMatchingKeys(t,i.addedDocuments,a))));let u=c.withSequenceNumber(t.currentSequenceNumber);e.targetMismatches.has(a)?u=u.withResumeToken(ar.EMPTY_BYTE_STRING,Xs.min()).withLastLimboFreeSnapshotVersion(Xs.min()):i.resumeToken.approximateByteSize()>0&&(u=u.withResumeToken(i.resumeToken,s)),r=r.insert(a,u),function(t,e,n){return 0===t.resumeToken.approximateByteSize()||e.snapshotVersion.toMicroseconds()-t.snapshotVersion.toMicroseconds()>=3e8||n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size>0}(c,u,i)&&o.push(n.He.updateTargetData(t,u))}));let a=co();if(e.documentUpdates.forEach(((s,r)=>{e.resolvedLimboDocuments.has(s)&&o.push(n.persistence.referenceDelegate.updateLimboDocument(t,s))})),o.push(Xc(t,i,e.documentUpdates,s,void 0).next((t=>{a=t}))),!s.isEqual(Xs.min())){const e=n.He.getLastRemoteSnapshotVersion(t).next((e=>n.He.setTargetsMetadata(t,t.currentSequenceNumber,s)));o.push(e)}return Ca.waitFor(o).next((()=>i.apply(t))).next((()=>n.Wn.Vn(t,a))).next((()=>a))})).then((t=>(n.qn=r,t)))}(n.localStore,e);e.targetChanges.forEach(((t,e)=>{const s=n.Uo.get(e);s&&(Cs(t.addedDocuments.size+t.modifiedDocuments.size+t.removedDocuments.size<=1),t.addedDocuments.size>0?s.$o=!0:t.modifiedDocuments.size>0?Cs(s.$o):t.removedDocuments.size>0&&(Cs(s.$o),s.$o=!1))})),await Xh(n,t,e)}catch(t){await Ic(t)}}function Uh(t,e,n){const s=xs(t);if(s.isPrimaryClient&&0===n||!s.isPrimaryClient&&1===n){const t=[];s.Mo.forEach(((n,s)=>{const r=s.view.ro(e);r.snapshot&&t.push(r.snapshot)})),function(t,e){const n=xs(t);n.onlineState=e;let s=!1;n.queries.forEach(((t,n)=>{for(const t of n.listeners)t.ro(e)&&(s=!0)})),s&&Sh(n)}(s.eventManager,e),t.length&&s.Oo.br(t),s.onlineState=e,s.isPrimaryClient&&s.sharedClientState.setOnlineState(e)}}async function Bh(t,e,n){const s=xs(t);s.sharedClientState.updateQueryState(e,"rejected",n);const r=s.Uo.get(e),i=r&&r.key;if(i){let t=new no(wr.comparator);t=t.insert(i,Pr.newNoDocument(i,Xs.min()));const n=go().add(i),r=new wo(Xs.min(),new Map,new io(Hs),t,n);await qh(s,r),s.Bo=s.Bo.remove(i),s.Uo.delete(e),Yh(s)}else await tu(s.localStore,e,!1).then((()=>zh(s,e,n))).catch(Ic)}async function jh(t,e){const n=xs(t),s=e.batch.batchId;try{const t=await function(t,e){const n=xs(t);return n.persistence.runTransaction("Acknowledge batch","readwrite-primary",(t=>{const s=e.batch.keys(),r=n.Qn.newChangeBuffer({trackRemovals:!0});return function(t,e,n,s){const r=n.batch,i=r.keys();let o=Ca.resolve();return i.forEach((t=>{o=o.next((()=>s.getEntry(e,t))).next((e=>{const i=n.docVersions.get(t);Cs(null!==i),e.version.compareTo(i)<0&&(r.applyToRemoteDocument(e,n),e.isValidDocument()&&s.addEntry(e,n.commitVersion))}))})),o.next((()=>t.An.removeMutationBatch(e,r)))}(n,t,e,r).next((()=>r.apply(t))).next((()=>n.An.performConsistencyCheck(t))).next((()=>n.Wn.vn(t,s)))}))}(n.localStore,e);Gh(n,s,null),$h(n,s),n.sharedClientState.updateMutationState(s,"acknowledged"),await Xh(n,t)}catch(t){await Ic(t)}}async function Kh(t,e,n){const s=xs(t);try{const t=await function(t,e){const n=xs(t);return n.persistence.runTransaction("Reject batch","readwrite-primary",(t=>{let s;return n.An.lookupMutationBatch(t,e).next((e=>(Cs(null!==e),s=e.keys(),n.An.removeMutationBatch(t,e)))).next((()=>n.An.performConsistencyCheck(t))).next((()=>n.Wn.vn(t,s)))}))}(s.localStore,e);Gh(s,e,n),$h(s,e),s.sharedClientState.updateMutationState(e,"rejected",n),await Xh(s,t)}catch(n){await Ic(n)}}function $h(t,e){(t.jo.get(e)||[]).forEach((t=>{t.resolve()})),t.jo.delete(e)}function Gh(t,e,n){const s=xs(t);let r=s.Ko[s.currentUser.toKey()];if(r){const t=r.get(e);t&&(n?t.reject(n):t.resolve(),r=r.remove(e)),s.Ko[s.currentUser.toKey()]=r}}function zh(t,e,n=null){t.sharedClientState.removeLocalQueryTarget(e);for(const s of t.Fo.get(e))t.Mo.delete(s),n&&t.Oo.zo(s,n);t.Fo.delete(e),t.isPrimaryClient&&t.qo.us(e).forEach((e=>{t.qo.containsKey(e)||Hh(t,e)}))}function Hh(t,e){t.Lo.delete(e.path.canonicalString());const n=t.Bo.get(e);null!==n&&(Ku(t.remoteStore,n),t.Bo=t.Bo.remove(e),t.Uo.delete(n),Yh(t))}function Qh(t,e,n){for(const s of n)s instanceof Nh?(t.qo.addReference(s.key,e),Wh(t,s)):s instanceof xh?(Ss("SyncEngine","Document no longer in limbo: "+s.key),t.qo.removeReference(s.key,e),t.qo.containsKey(s.key)||Hh(t,s.key)):Ds()}function Wh(t,e){const n=e.key,s=n.path.canonicalString();t.Bo.get(n)||t.Lo.has(s)||(Ss("SyncEngine","New document in limbo: "+n),t.Lo.add(s),Yh(t))}function Yh(t){for(;t.Lo.size>0&&t.Bo.size<t.maxConcurrentLimboResolutions;){const e=t.Lo.values().next().value;t.Lo.delete(e);const n=new wr(nr.fromString(e)),s=t.Qo.next();t.Uo.set(s,new Mh(n)),t.Bo=t.Bo.insert(n,s),ju(t.remoteStore,new Ka(li(ri(n.path)),s,2,$s.I))}}async function Xh(t,e,n){const s=xs(t),r=[],i=[],o=[];s.Mo.isEmpty()||(s.Mo.forEach(((t,a)=>{o.push(s.Go(a,e,n).then((t=>{if(t){s.isPrimaryClient&&s.sharedClientState.updateQueryState(a.targetId,t.fromCache?"not-current":"current"),r.push(t);const e=Gc.$n(a.targetId,t);i.push(e)}})))})),await Promise.all(o),s.Oo.br(r),await async function(t,e){const n=xs(t);try{await n.persistence.runTransaction("notifyLocalViewChanges","readwrite",(t=>Ca.forEach(e,(e=>Ca.forEach(e.kn,(s=>n.persistence.referenceDelegate.addReference(t,e.targetId,s))).next((()=>Ca.forEach(e.xn,(s=>n.persistence.referenceDelegate.removeReference(t,e.targetId,s)))))))))}catch(t){if(!Ma(t))throw t;Ss("LocalStore","Failed to update sequence numbers: "+t)}for(const t of e){const e=t.targetId;if(!t.fromCache){const t=n.qn.get(e),s=t.snapshotVersion,r=t.withLastLimboFreeSnapshotVersion(s);n.qn=n.qn.insert(e,r)}}}(s.localStore,i))}async function Jh(t,e){const n=xs(t);if(!n.currentUser.isEqual(e)){Ss("SyncEngine","User change. New user:",e.toKey());const t=await Wc(n.localStore,e);n.currentUser=e,function(t,e){t.jo.forEach((t=>{t.forEach((t=>{t.reject(new Ls(Rs.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))}))})),t.jo.clear()}(n),n.sharedClientState.handleUserChange(e,t.removedBatchIds,t.addedBatchIds),await Xh(n,t.Gn)}}function Zh(t,e){const n=xs(t),s=n.Uo.get(e);if(s&&s.$o)return go().add(s.key);{let t=go();const s=n.Fo.get(e);if(!s)return t;for(const e of s){const s=n.Mo.get(e);t=t.unionWith(s.view.bo)}return t}}async function tl(t,e){const n=xs(t),s=await eu(n.localStore,e.query,!0),r=e.view.ko(s);return n.isPrimaryClient&&Qh(n,e.targetId,r.Co),r}async function el(t){const e=xs(t);return su(e.localStore).then((t=>Xh(e,t)))}async function nl(t,e,n,s){const r=xs(t),i=await function(t,e){const n=xs(t),s=xs(n.An);return n.persistence.runTransaction("Lookup mutation documents","readonly",(t=>s.Zt(t,e).next((e=>e?n.Wn.vn(t,e):Ca.resolve(null)))))}(r.localStore,e);null!==i?("pending"===n?await eh(r.remoteStore):"acknowledged"===n||"rejected"===n?(Gh(r,e,s||null),$h(r,e),function(t,e){xs(xs(t).An).ee(e)}(r.localStore,e)):Ds(),await Xh(r,i)):Ss("SyncEngine","Cannot apply mutation batch with id: "+e)}async function sl(t,e,n){const s=xs(t),r=[],i=[];for(const t of e){let e;const n=s.Fo.get(t);if(n&&0!==n.length){e=await Zc(s.localStore,li(n[0]));for(const t of n){const e=s.Mo.get(t),n=await tl(s,e);n.snapshot&&i.push(n.snapshot)}}else{const n=await nu(s.localStore,t);e=await Zc(s.localStore,n),await Fh(s,rl(n),t,!1)}r.push(e)}return s.Oo.br(i),r}function rl(t){return si(t.path,t.collectionGroup,t.orderBy,t.filters,t.limit,"F",t.startAt,t.endAt)}function il(t){const e=xs(t);return xs(xs(e.localStore).persistence).Tn()}async function ol(t,e,n,s){const r=xs(t);if(r.Wo)Ss("SyncEngine","Ignoring unexpected query state notification.");else if(r.Fo.has(e))switch(n){case"current":case"not-current":{const t=await su(r.localStore),s=wo.createSynthesizedRemoteEventForCurrentChange(e,"current"===n);await Xh(r,t,s);break}case"rejected":await tu(r.localStore,e,!0),zh(r,e,s);break;default:Ds()}}async function al(t,e,n){const s=cl(t);if(s.Wo){for(const t of e){if(s.Fo.has(t)){Ss("SyncEngine","Adding an already active target "+t);continue}const e=await nu(s.localStore,t),n=await Zc(s.localStore,e);await Fh(s,rl(e),n.targetId,!1),ju(s.remoteStore,n)}for(const t of n)s.Fo.has(t)&&await tu(s.localStore,t,!1).then((()=>{Ku(s.remoteStore,t),zh(s,t)})).catch(Ic)}}function cl(t){const e=xs(t);return e.remoteStore.remoteSyncer.applyRemoteEvent=qh.bind(null,e),e.remoteStore.remoteSyncer.getRemoteKeysForTarget=Zh.bind(null,e),e.remoteStore.remoteSyncer.rejectListen=Bh.bind(null,e),e.Oo.br=Ih.bind(null,e.eventManager),e.Oo.zo=Eh.bind(null,e.eventManager),e}function ul(t){const e=xs(t);return e.remoteStore.remoteSyncer.applySuccessfulWrite=jh.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=Kh.bind(null,e),e}class hl{constructor(){this.synchronizeTabs=!1}async initialize(t){this.k=Ru(t.databaseInfo.databaseId),this.sharedClientState=this.Jo(t),this.persistence=this.Yo(t),await this.persistence.start(),this.gcScheduler=this.Xo(t),this.localStore=this.Zo(t)}Xo(t){return null}Zo(t){return Qc(this.persistence,new zc,t.initialUser,this.k)}Yo(t){return new du(mu.ks,this.k)}Jo(t){return new Su}async terminate(){this.gcScheduler&&this.gcScheduler.stop(),await this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class ll extends hl{constructor(t,e,n){super(),this.tc=t,this.cacheSizeBytes=e,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(t){await super.initialize(t),await async function(t){const e=xs(t);return e.persistence.runTransaction("Synchronize last document change read time","readonly",(t=>function(t){const e=Mc(t);let n=Xs.min();return e.jt({index:ya.readTimeIndex,reverse:!0},((t,e,s)=>{e.readTime&&(n=Qa(e.readTime)),s.done()})).next((()=>n))}(t))).then((t=>{e.jn=t}))}(this.localStore),await this.tc.initialize(this,t),await ul(this.tc.syncEngine),await eh(this.tc.remoteStore),await this.persistence.sn((()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(this.localStore),Promise.resolve())))}Zo(t){return Qc(this.persistence,new zc,t.initialUser,this.k)}Xo(t){const e=this.persistence.referenceDelegate.garbageCollector;return new Ac(e,t.asyncQueue)}Yo(t){const e=jc(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?uc.withCacheSize(this.cacheSizeBytes):uc.DEFAULT;return new qc(this.synchronizeTabs,e,t.clientId,n,t.asyncQueue,Nu(),xu(),this.k,this.sharedClientState,!!this.forceOwnership)}Jo(t){return new Su}}class dl extends ll{constructor(t,e){super(t,e,!1),this.tc=t,this.cacheSizeBytes=e,this.synchronizeTabs=!0}async initialize(t){await super.initialize(t);const e=this.tc.syncEngine;this.sharedClientState instanceof Eu&&(this.sharedClientState.syncEngine={mi:nl.bind(null,e),gi:ol.bind(null,e),yi:al.bind(null,e),Tn:il.bind(null,e),_i:el.bind(null,e)},await this.sharedClientState.start()),await this.persistence.sn((async t=>{await async function(t,e){const n=xs(t);if(cl(n),ul(n),!0===e&&!0!==n.Wo){const t=n.sharedClientState.getAllActiveQueryTargets(),e=await sl(n,t.toArray());n.Wo=!0,await hh(n.remoteStore,!0);for(const t of e)ju(n.remoteStore,t)}else if(!1===e&&!1!==n.Wo){const t=[];let e=Promise.resolve();n.Fo.forEach(((s,r)=>{n.sharedClientState.isLocalQueryTarget(r)?t.push(r):e=e.then((()=>(zh(n,r),tu(n.localStore,r,!0)))),Ku(n.remoteStore,r)})),await e,await sl(n,t),function(t){const e=xs(t);e.Uo.forEach(((t,n)=>{Ku(e.remoteStore,n)})),e.qo.hs(),e.Uo=new Map,e.Bo=new no(wr.comparator)}(n),n.Wo=!1,await hh(n.remoteStore,!1)}}(this.tc.syncEngine,t),this.gcScheduler&&(t&&!this.gcScheduler.started?this.gcScheduler.start(this.localStore):t||this.gcScheduler.stop())}))}Jo(t){const e=Nu();if(!Eu.Pt(e))throw new Ls(Rs.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");const n=jc(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey);return new Eu(e,t.asyncQueue,n,t.clientId,t.initialUser)}}class fl{async initialize(t,e){this.localStore||(this.localStore=t.localStore,this.sharedClientState=t.sharedClientState,this.datastore=this.createDatastore(e),this.remoteStore=this.createRemoteStore(e),this.eventManager=this.createEventManager(e),this.syncEngine=this.createSyncEngine(e,!t.synchronizeTabs),this.sharedClientState.onlineStateHandler=t=>Uh(this.syncEngine,t,1),this.remoteStore.remoteSyncer.handleCredentialChange=Jh.bind(null,this.syncEngine),await hh(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(t){return new vh}createDatastore(t){const e=Ru(t.databaseInfo.databaseId),n=(s=t.databaseInfo,new Cu(s));var s;return function(t,e,n,s){return new Fu(t,e,n,s)}(t.authCredentials,t.appCheckCredentials,n,e)}createRemoteStore(t){return e=this.localStore,n=this.datastore,s=t.asyncQueue,r=t=>Uh(this.syncEngine,t,0),i=_u.Pt()?new _u:new Au,new qu(e,n,s,r,i);var e,n,s,r,i}createSyncEngine(t,e){return function(t,e,n,s,r,i,o){const a=new Ph(t,e,n,s,r,i);return o&&(a.Wo=!0),a}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,t.initialUser,t.maxConcurrentLimboResolutions,e)}terminate(){return async function(t){const e=xs(t);Ss("RemoteStore","RemoteStore shutting down."),e.Gr.add(5),await Bu(e),e.Hr.shutdown(),e.Jr.set("Unknown")}(this.remoteStore)}}function ml(t,e=10240){let n=0;return{async read(){if(n<t.byteLength){const s={value:t.slice(n,n+e),done:!1};return n+=e,s}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.reject("unimplemented")}}class gl{constructor(t){this.observer=t,this.muted=!1}next(t){this.observer.next&&this.ec(this.observer.next,t)}error(t){this.observer.error?this.ec(this.observer.error,t):console.error("Uncaught Error in snapshot listener:",t)}nc(){this.muted=!0}ec(t,e){this.muted||setTimeout((()=>{this.muted||t(e)}),0)}}class pl{constructor(t,e){this.sc=t,this.k=e,this.metadata=new Ms,this.buffer=new Uint8Array,this.ic=new TextDecoder("utf-8"),this.rc().then((t=>{t&&t._o()?this.metadata.resolve(t.payload.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is\n             ${JSON.stringify(null==t?void 0:t.payload)}`))}),(t=>this.metadata.reject(t)))}close(){return this.sc.cancel()}async getMetadata(){return this.metadata.promise}async Ho(){return await this.getMetadata(),this.rc()}async rc(){const t=await this.oc();if(null===t)return null;const e=this.ic.decode(t),n=Number(e);isNaN(n)&&this.cc(`length string (${e}) is not valid number`);const s=await this.ac(n);return new _h(JSON.parse(s),t.length+n)}uc(){return this.buffer.findIndex((t=>t==="{".charCodeAt(0)))}async oc(){for(;this.uc()<0&&!await this.hc(););if(0===this.buffer.length)return null;const t=this.uc();t<0&&this.cc("Reached the end of bundle when a length string is expected.");const e=this.buffer.slice(0,t);return this.buffer=this.buffer.slice(t),e}async ac(t){for(;this.buffer.length<t;)await this.hc()&&this.cc("Reached the end of bundle when more is expected.");const e=this.ic.decode(this.buffer.slice(0,t));return this.buffer=this.buffer.slice(t),e}cc(t){throw this.sc.cancel(),new Error(`Invalid bundle format: ${t}`)}async hc(){const t=await this.sc.read();if(!t.done){const e=new Uint8Array(this.buffer.length+t.value.length);e.set(this.buffer),e.set(t.value,this.buffer.length),this.buffer=e}return t.done}}class yl{constructor(t){this.datastore=t,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}async lookup(t){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw new Ls(Rs.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");const e=await async function(t,e){const n=xs(t),s=Uo(n.k)+"/documents",r={documents:e.map((t=>Oo(n.k,t)))},i=await n.ji("BatchGetDocuments",s,r),o=new Map;i.forEach((t=>{const e=function(t,e){return"found"in e?function(t,e){Cs(!!e.found),e.found.name,e.found.updateTime;const n=Fo(t,e.found.name),s=Lo(e.found.updateTime),r=new Lr({mapValue:{fields:e.found.fields}});return Pr.newFoundDocument(n,s,r)}(t,e):"missing"in e?function(t,e){Cs(!!e.missing),Cs(!!e.readTime);const n=Fo(t,e.missing),s=Lo(e.readTime);return Pr.newNoDocument(n,s)}(t,e):Ds()}(n.k,t);o.set(e.key.toString(),e)}));const a=[];return e.forEach((t=>{const e=o.get(t.toString());Cs(!!e),a.push(e)})),a}(this.datastore,t);return e.forEach((t=>this.recordVersion(t))),e}set(t,e){this.write(e.toMutation(t,this.precondition(t))),this.writtenDocs.add(t.toString())}update(t,e){try{this.write(e.toMutation(t,this.preconditionForUpdate(t)))}catch(t){this.lastWriteError=t}this.writtenDocs.add(t.toString())}delete(t){this.write(new Wi(t,this.precondition(t))),this.writtenDocs.add(t.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;const t=this.readVersions;this.mutations.forEach((e=>{t.delete(e.key.toString())})),t.forEach(((t,e)=>{const n=wr.fromPath(e);this.mutations.push(new Yi(n,this.precondition(n)))})),await async function(t,e){const n=xs(t),s=Uo(n.k)+"/documents",r={writes:e.map((t=>$o(n.k,t)))};await n.Bi("Commit",s,r)}(this.datastore,this.mutations),this.committed=!0}recordVersion(t){let e;if(t.isFoundDocument())e=t.version;else{if(!t.isNoDocument())throw Ds();e=Xs.min()}const n=this.readVersions.get(t.key.toString());if(n){if(!e.isEqual(n))throw new Ls(Rs.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(t.key.toString(),e)}precondition(t){const e=this.readVersions.get(t.toString());return!this.writtenDocs.has(t.toString())&&e?Oi.updateTime(e):Oi.none()}preconditionForUpdate(t){const e=this.readVersions.get(t.toString());if(!this.writtenDocs.has(t.toString())&&e){if(e.isEqual(Xs.min()))throw new Ls(Rs.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return Oi.updateTime(e)}return Oi.exists(!0)}write(t){this.ensureCommitNotCalled(),this.mutations.push(t)}ensureCommitNotCalled(){}}class wl{constructor(t,e,n,s){this.asyncQueue=t,this.datastore=e,this.updateFunction=n,this.deferred=s,this.lc=5,this.ur=new Lu(this.asyncQueue,"transaction_retry")}run(){this.lc-=1,this.fc()}fc(){this.ur.Zi((async()=>{const t=new yl(this.datastore),e=this.dc(t);e&&e.then((e=>{this.asyncQueue.enqueueAndForget((()=>t.commit().then((()=>{this.deferred.resolve(e)})).catch((t=>{this.wc(t)}))))})).catch((t=>{this.wc(t)}))}))}dc(t){try{const e=this.updateFunction(t);return!gr(e)&&e.catch&&e.then?e:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(t){return this.deferred.reject(t),null}}wc(t){this.lc>0&&this._c(t)?(this.lc-=1,this.asyncQueue.enqueueAndForget((()=>(this.fc(),Promise.resolve())))):this.deferred.reject(t)}_c(t){if("FirebaseError"===t.name){const e=t.code;return"aborted"===e||"failed-precondition"===e||!to(e)}return!1}}class vl{constructor(t,e,n,s){this.authCredentials=t,this.appCheckCredentials=e,this.asyncQueue=n,this.databaseInfo=s,this.user=vs.UNAUTHENTICATED,this.clientId=zs.A(),this.authCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,(async t=>{Ss("FirestoreClient","Received user=",t.uid),await this.authCredentialListener(t),this.user=t})),this.appCheckCredentials.start(n,(()=>Promise.resolve()))}async getConfiguration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(t){this.authCredentialListener=t}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new Ls(Rs.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const t=new Ms;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted((async()=>{try{this.onlineComponents&&await this.onlineComponents.terminate(),this.offlineComponents&&await this.offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),t.resolve()}catch(e){const n=mh(e,"Failed to shutdown persistence");t.reject(n)}})),t.promise}}async function Tl(t,e){t.asyncQueue.verifyOperationInProgress(),Ss("FirestoreClient","Initializing OfflineComponentProvider");const n=await t.getConfiguration();await e.initialize(n);let s=n.initialUser;t.setCredentialChangeListener((async t=>{s.isEqual(t)||(await Wc(e.localStore,t),s=t)})),e.persistence.setDatabaseDeletedListener((()=>t.terminate())),t.offlineComponents=e}async function bl(t,e){t.asyncQueue.verifyOperationInProgress();const n=await Il(t);Ss("FirestoreClient","Initializing OnlineComponentProvider");const s=await t.getConfiguration();await e.initialize(n,s),t.setCredentialChangeListener((t=>async function(t,e){const n=xs(t);n.asyncQueue.verifyOperationInProgress(),Ss("RemoteStore","RemoteStore received new credentials");const s=Qu(n);n.Gr.add(3),await Bu(n),s&&n.Jr.set("Unknown"),await n.remoteSyncer.handleCredentialChange(e),n.Gr.delete(3),await Uu(n)}(e.remoteStore,t))),t.onlineComponents=e}async function Il(t){return t.offlineComponents||(Ss("FirestoreClient","Using default OfflineComponentProvider"),await Tl(t,new hl)),t.offlineComponents}async function El(t){return t.onlineComponents||(Ss("FirestoreClient","Using default OnlineComponentProvider"),await bl(t,new fl)),t.onlineComponents}function Sl(t){return Il(t).then((t=>t.persistence))}function Al(t){return Il(t).then((t=>t.localStore))}function _l(t){return El(t).then((t=>t.remoteStore))}function kl(t){return El(t).then((t=>t.syncEngine))}async function Dl(t){const e=await El(t),n=e.eventManager;return n.onListen=Oh.bind(null,e.syncEngine),n.onUnlisten=Vh.bind(null,e.syncEngine),n}function Cl(t,e,n={}){const s=new Ms;return t.asyncQueue.enqueueAndForget((async()=>function(t,e,n,s,r){const i=new gl({next:i=>{e.enqueueAndForget((()=>bh(t,o)));const a=i.docs.has(n);!a&&i.fromCache?r.reject(new Ls(Rs.UNAVAILABLE,"Failed to get document because the client is offline.")):a&&i.fromCache&&s&&"server"===s.source?r.reject(new Ls(Rs.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):r.resolve(i)},error:t=>r.reject(t)}),o=new Ah(ri(n.path),i,{includeMetadataChanges:!0,wo:!0});return Th(t,o)}(await Dl(t),t.asyncQueue,e,n,s))),s.promise}function Nl(t,e,n={}){const s=new Ms;return t.asyncQueue.enqueueAndForget((async()=>function(t,e,n,s,r){const i=new gl({next:n=>{e.enqueueAndForget((()=>bh(t,o))),n.fromCache&&"server"===s.source?r.reject(new Ls(Rs.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):r.resolve(n)},error:t=>r.reject(t)}),o=new Ah(n,i,{includeMetadataChanges:!0,wo:!0});return Th(t,o)}(await Dl(t),t.asyncQueue,e,n,s))),s.promise}class xl{constructor(t,e,n,s,r,i,o,a){this.databaseId=t,this.appId=e,this.persistenceKey=n,this.host=s,this.ssl=r,this.forceLongPolling=i,this.autoDetectLongPolling=o,this.useFetchStreams=a}}class Rl{constructor(t,e){this.projectId=t,this.database=e||"(default)"}get isDefaultDatabase(){return"(default)"===this.database}isEqual(t){return t instanceof Rl&&t.projectId===this.projectId&&t.database===this.database}}const Ll=new Map;function Ml(t,e,n){if(!n)throw new Ls(Rs.INVALID_ARGUMENT,`Function ${t}() cannot be called with an empty ${e}.`)}function Pl(t,e,n,s){if(!0===e&&!0===s)throw new Ls(Rs.INVALID_ARGUMENT,`${t} and ${n} cannot be used together.`)}function Ol(t){if(!wr.isDocumentKey(t))throw new Ls(Rs.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${t} has ${t.length}.`)}function Fl(t){if(wr.isDocumentKey(t))throw new Ls(Rs.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${t} has ${t.length}.`)}function Vl(t){if(void 0===t)return"undefined";if(null===t)return"null";if("string"==typeof t)return t.length>20&&(t=`${t.substring(0,20)}...`),JSON.stringify(t);if("number"==typeof t||"boolean"==typeof t)return""+t;if("object"==typeof t){if(t instanceof Array)return"an array";{const e=function(t){return t.constructor?t.constructor.name:null}(t);return e?`a custom ${e} object`:"an object"}}return"function"==typeof t?"a function":Ds()}function ql(t,e){if("_delegate"in t&&(t=t._delegate),!(t instanceof e)){if(e.name===t.constructor.name)throw new Ls(Rs.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const n=Vl(t);throw new Ls(Rs.INVALID_ARGUMENT,`Expected type '${e.name}', but it was: ${n}`)}}return t}function Ul(t,e){if(e<=0)throw new Ls(Rs.INVALID_ARGUMENT,`Function ${t}() requires a positive number, but it was: ${e}.`)}class Bl{constructor(t){var e;if(void 0===t.host){if(void 0!==t.ssl)throw new Ls(Rs.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=t.host,this.ssl=null===(e=t.ssl)||void 0===e||e;if(this.credentials=t.credentials,this.ignoreUndefinedProperties=!!t.ignoreUndefinedProperties,void 0===t.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==t.cacheSizeBytes&&t.cacheSizeBytes<1048576)throw new Ls(Rs.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=t.cacheSizeBytes}this.experimentalForceLongPolling=!!t.experimentalForceLongPolling,this.experimentalAutoDetectLongPolling=!!t.experimentalAutoDetectLongPolling,this.useFetchStreams=!!t.useFetchStreams,Pl("experimentalForceLongPolling",t.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",t.experimentalAutoDetectLongPolling)}isEqual(t){return this.host===t.host&&this.ssl===t.ssl&&this.credentials===t.credentials&&this.cacheSizeBytes===t.cacheSizeBytes&&this.experimentalForceLongPolling===t.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===t.experimentalAutoDetectLongPolling&&this.ignoreUndefinedProperties===t.ignoreUndefinedProperties&&this.useFetchStreams===t.useFetchStreams}}class jl{constructor(t,e,n){this._authCredentials=e,this._appCheckCredentials=n,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new Bl({}),this._settingsFrozen=!1,t instanceof Rl?this._databaseId=t:(this._app=t,this._databaseId=function(t){if(!Object.prototype.hasOwnProperty.apply(t.options,["projectId"]))throw new Ls(Rs.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new Rl(t.options.projectId)}(t))}get app(){if(!this._app)throw new Ls(Rs.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(t){if(this._settingsFrozen)throw new Ls(Rs.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new Bl(t),void 0!==t.credentials&&(this._authCredentials=function(t){if(!t)return new Os;switch(t.type){case"gapi":const e=t.client;return Cs(!("object"!=typeof e||null===e||!e.auth||!e.auth.getAuthHeaderValueForFirstParty)),new Us(e,t.sessionIndex||"0",t.iamToken||null);case"provider":return t.client;default:throw new Ls(Rs.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(t.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(t){const e=Ll.get(t);e&&(Ss("ComponentProvider","Removing Datastore"),Ll.delete(t),e.terminate())}(this),Promise.resolve()}}function Kl(t,e,n,s={}){var r;const i=(t=ql(t,jl))._getSettings();if("firestore.googleapis.com"!==i.host&&i.host!==e&&_s("Host has been set in both settings() and useEmulator(), emulator host will be used"),t._setSettings(Object.assign(Object.assign({},i),{host:`${e}:${n}`,ssl:!1})),s.mockUserToken){let e,n;if("string"==typeof s.mockUserToken)e=s.mockUserToken,n=vs.MOCK_USER;else{e=(0,a.Sg)(s.mockUserToken,null===(r=t._app)||void 0===r?void 0:r.options.projectId);const i=s.mockUserToken.sub||s.mockUserToken.user_id;if(!i)throw new Ls(Rs.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");n=new vs(i)}t._authCredentials=new Fs(new Ps(e,n))}}class $l{constructor(t,e,n){this.converter=e,this._key=n,this.type="document",this.firestore=t}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new zl(this.firestore,this.converter,this._key.path.popLast())}withConverter(t){return new $l(this.firestore,t,this._key)}}class Gl{constructor(t,e,n){this.converter=e,this._query=n,this.type="query",this.firestore=t}withConverter(t){return new Gl(this.firestore,t,this._query)}}class zl extends Gl{constructor(t,e,n){super(t,e,ri(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const t=this._path.popLast();return t.isEmpty()?null:new $l(this.firestore,null,new wr(t))}withConverter(t){return new zl(this.firestore,t,this._path)}}function Hl(t,e,...n){if(t=(0,a.m9)(t),Ml("collection","path",e),t instanceof jl){const s=nr.fromString(e,...n);return Fl(s),new zl(t,null,s)}{if(!(t instanceof $l||t instanceof zl))throw new Ls(Rs.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const s=t._path.child(nr.fromString(e,...n));return Fl(s),new zl(t.firestore,null,s)}}function Ql(t,e){if(t=ql(t,jl),Ml("collectionGroup","collection id",e),e.indexOf("/")>=0)throw new Ls(Rs.INVALID_ARGUMENT,`Invalid collection ID '${e}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new Gl(t,null,function(t){return new ni(nr.emptyPath(),t)}(e))}function Wl(t,e,...n){if(t=(0,a.m9)(t),1===arguments.length&&(e=zs.A()),Ml("doc","path",e),t instanceof jl){const s=nr.fromString(e,...n);return Ol(s),new $l(t,null,new wr(s))}{if(!(t instanceof $l||t instanceof zl))throw new Ls(Rs.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const s=t._path.child(nr.fromString(e,...n));return Ol(s),new $l(t.firestore,t instanceof zl?t.converter:null,new wr(s))}}function Yl(t,e){return t=(0,a.m9)(t),e=(0,a.m9)(e),(t instanceof $l||t instanceof zl)&&(e instanceof $l||e instanceof zl)&&t.firestore===e.firestore&&t.path===e.path&&t.converter===e.converter}function Xl(t,e){return t=(0,a.m9)(t),e=(0,a.m9)(e),t instanceof Gl&&e instanceof Gl&&t.firestore===e.firestore&&fi(t._query,e._query)&&t.converter===e.converter}class Jl{constructor(){this.mc=Promise.resolve(),this.gc=[],this.yc=!1,this.Tc=[],this.Ec=null,this.Ic=!1,this.Ac=!1,this.Rc=[],this.ur=new Lu(this,"async_queue_retry"),this.bc=()=>{const t=xu();t&&Ss("AsyncQueue","Visibility state changed to "+t.visibilityState),this.ur.er()};const t=xu();t&&"function"==typeof t.addEventListener&&t.addEventListener("visibilitychange",this.bc)}get isShuttingDown(){return this.yc}enqueueAndForget(t){this.enqueue(t)}enqueueAndForgetEvenWhileRestricted(t){this.Pc(),this.vc(t)}enterRestrictedMode(t){if(!this.yc){this.yc=!0,this.Ac=t||!1;const e=xu();e&&"function"==typeof e.removeEventListener&&e.removeEventListener("visibilitychange",this.bc)}}enqueue(t){if(this.Pc(),this.yc)return new Promise((()=>{}));const e=new Ms;return this.vc((()=>this.yc&&this.Ac?Promise.resolve():(t().then(e.resolve,e.reject),e.promise))).then((()=>e.promise))}enqueueRetryable(t){this.enqueueAndForget((()=>(this.gc.push(t),this.Vc())))}async Vc(){if(0!==this.gc.length){try{await this.gc[0](),this.gc.shift(),this.ur.reset()}catch(t){if(!Ma(t))throw t;Ss("AsyncQueue","Operation failed with retryable error: "+t)}this.gc.length>0&&this.ur.Zi((()=>this.Vc()))}}vc(t){const e=this.mc.then((()=>(this.Ic=!0,t().catch((t=>{this.Ec=t,this.Ic=!1;const e=function(t){let e=t.message||"";return t.stack&&(e=t.stack.includes(t.message)?t.stack:t.message+"\n"+t.stack),e}(t);throw As("INTERNAL UNHANDLED ERROR: ",e),t})).then((t=>(this.Ic=!1,t))))));return this.mc=e,e}enqueueAfterDelay(t,e,n){this.Pc(),this.Rc.indexOf(t)>-1&&(e=0);const s=fh.createAndSchedule(this,t,e,n,(t=>this.Sc(t)));return this.Tc.push(s),s}Pc(){this.Ec&&Ds()}verifyOperationInProgress(){}async Dc(){let t;do{t=this.mc,await t}while(t!==this.mc)}Cc(t){for(const e of this.Tc)if(e.timerId===t)return!0;return!1}Nc(t){return this.Dc().then((()=>{this.Tc.sort(((t,e)=>t.targetTimeMs-e.targetTimeMs));for(const e of this.Tc)if(e.skipDelay(),"all"!==t&&e.timerId===t)break;return this.Dc()}))}kc(t){this.Rc.push(t)}Sc(t){const e=this.Tc.indexOf(t);this.Tc.splice(e,1)}}function Zl(t){return function(t,e){if("object"!=typeof t||null===t)return!1;const n=t;for(const t of["next","error","complete"])if(t in n&&"function"==typeof n[t])return!0;return!1}(t)}class td{constructor(){this._progressObserver={},this._taskCompletionResolver=new Ms,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(t,e,n){this._progressObserver={next:t,error:e,complete:n}}catch(t){return this._taskCompletionResolver.promise.catch(t)}then(t,e){return this._taskCompletionResolver.promise.then(t,e)}_completeWith(t){this._updateProgress(t),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(t)}_failWith(t){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(t),this._taskCompletionResolver.reject(t)}_updateProgress(t){this._lastProgress=t,this._progressObserver.next&&this._progressObserver.next(t)}}const ed=-1;class nd extends jl{constructor(t,e,n){super(t,e,n),this.type="firestore",this._queue=new Jl,this._persistenceKey="name"in t?t.name:"[DEFAULT]"}_terminate(){return this._firestoreClient||od(this),this._firestoreClient.terminate()}}function sd(t,e){const n=(0,r.qX)(t,"firestore");if(n.isInitialized()){const t=n.getImmediate(),s=n.getOptions();if((0,a.vZ)(s,e))return t;throw new Ls(Rs.FAILED_PRECONDITION,"initializeFirestore() has already been called with different options. To avoid this error, call initializeFirestore() with the same options as when it was originally called, or call getFirestore() to return the already initialized instance.")}if(void 0!==e.cacheSizeBytes&&-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new Ls(Rs.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");return n.initialize({options:e})}function rd(t=(0,r.Mq)()){return(0,r.qX)(t,"firestore").getImmediate()}function id(t){return t._firestoreClient||od(t),t._firestoreClient.verifyNotTerminated(),t._firestoreClient}function od(t){var e;const n=t._freezeSettings(),s=function(t,e,n,s){return new xl(t,e,n,s.host,s.ssl,s.experimentalForceLongPolling,s.experimentalAutoDetectLongPolling,s.useFetchStreams)}(t._databaseId,(null===(e=t._app)||void 0===e?void 0:e.options.appId)||"",t._persistenceKey,n);t._firestoreClient=new vl(t._authCredentials,t._appCheckCredentials,t._queue,s)}function ad(t,e){yd(t=ql(t,nd));const n=id(t),s=t._freezeSettings(),r=new fl;return ud(n,r,new ll(r,s.cacheSizeBytes,null==e?void 0:e.forceOwnership))}function cd(t){yd(t=ql(t,nd));const e=id(t),n=t._freezeSettings(),s=new fl;return ud(e,s,new dl(s,n.cacheSizeBytes))}function ud(t,e,n){const s=new Ms;return t.asyncQueue.enqueue((async()=>{try{await Tl(t,n),await bl(t,e),s.resolve()}catch(t){if(!function(t){return"FirebaseError"===t.name?t.code===Rs.FAILED_PRECONDITION||t.code===Rs.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&t instanceof DOMException)||22===t.code||20===t.code||11===t.code}(t))throw t;console.warn("Error enabling offline persistence. Falling back to persistence disabled: "+t),s.reject(t)}})).then((()=>s.promise))}function hd(t){if(t._initialized&&!t._terminated)throw new Ls(Rs.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const e=new Ms;return t._queue.enqueueAndForgetEvenWhileRestricted((async()=>{try{await async function(t){if(!xa.Pt())return Promise.resolve();const e=t+"main";await xa.delete(e)}(jc(t._databaseId,t._persistenceKey)),e.resolve()}catch(t){e.reject(t)}})),e.promise}function ld(t){return function(t){const e=new Ms;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e){const n=xs(t);Qu(n.remoteStore)||Ss("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const t=await function(t){const e=xs(t);return e.persistence.runTransaction("Get highest unacknowledged batch id","readonly",(t=>e.An.getHighestUnacknowledgedBatchId(t)))}(n.localStore);if(-1===t)return void e.resolve();const s=n.jo.get(t)||[];s.push(e),n.jo.set(t,s)}catch(t){const n=mh(t,"Initialization of waitForPendingWrites() operation failed");e.reject(n)}}(await kl(t),e))),e.promise}(id(t=ql(t,nd)))}function dd(t){return function(t){return t.asyncQueue.enqueue((async()=>{const e=await Sl(t),n=await _l(t);return e.setNetworkEnabled(!0),function(t){const e=xs(t);return e.Gr.delete(0),Uu(e)}(n)}))}(id(t=ql(t,nd)))}function fd(t){return function(t){return t.asyncQueue.enqueue((async()=>{const e=await Sl(t),n=await _l(t);return e.setNetworkEnabled(!1),async function(t){const e=xs(t);e.Gr.add(0),await Bu(e),e.Jr.set("Offline")}(n)}))}(id(t=ql(t,nd)))}function md(t){return(0,r.wN)(t.app,"firestore"),t._delete()}function gd(t,e){const n=id(t=ql(t,nd)),s=new td;return function(t,e,n,s){const r=function(t,e){let n;return n="string"==typeof t?(new TextEncoder).encode(t):t,function(t,e){return new pl(t,e)}(function(t,e){if(t instanceof Uint8Array)return ml(t,e);if(t instanceof ArrayBuffer)return ml(new Uint8Array(t),e);if(t instanceof ReadableStream)return t.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(n),e)}(n,Ru(e));t.asyncQueue.enqueueAndForget((async()=>{!function(t,e,n){const s=xs(t);(async function(t,e,n){try{const s=await e.getMetadata();if(await function(t,e){const n=xs(t),s=Lo(e.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",(t=>n.Ye.getBundleMetadata(t,e.id))).then((t=>!!t&&t.createTime.compareTo(s)>=0))}(t.localStore,s))return await e.close(),void n._completeWith(function(t){return{taskState:"Success",documentsLoaded:t.totalDocuments,bytesLoaded:t.totalBytes,totalDocuments:t.totalDocuments,totalBytes:t.totalBytes}}(s));n._updateProgress(Ch(s));const r=new Dh(s,t.localStore,e.k);let i=await e.Ho();for(;i;){const t=await r.yo(i);t&&n._updateProgress(t),i=await e.Ho()}const o=await r.complete();await Xh(t,o.In,void 0),await function(t,e){const n=xs(t);return n.persistence.runTransaction("Save bundle","readwrite",(t=>n.Ye.saveBundleMetadata(t,e)))}(t.localStore,s),n._completeWith(o.progress)}catch(t){_s("SyncEngine",`Loading bundle failed with ${t}`),n._failWith(t)}})(s,e,n).then((()=>{s.sharedClientState.notifyBundleLoaded()}))}(await kl(t),r,s)}))}(n,t._databaseId,e,s),s}function pd(t,e){return function(t,e){return t.asyncQueue.enqueue((async()=>function(t,e){const n=xs(t);return n.persistence.runTransaction("Get named query","readonly",(t=>n.Ye.getNamedQuery(t,e)))}(await Al(t),e)))}(id(t=ql(t,nd)),e).then((e=>e?new Gl(t,null,e.query):null))}function yd(t){if(t._initialized||t._terminated)throw new Ls(Rs.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class wd{constructor(...t){for(let e=0;e<t.length;++e)if(0===t[e].length)throw new Ls(Rs.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new rr(t)}isEqual(t){return this._internalPath.isEqual(t._internalPath)}}function vd(){return new wd("__name__")}class Td{constructor(t){this._byteString=t}static fromBase64String(t){try{return new Td(ar.fromBase64String(t))}catch(t){throw new Ls(Rs.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+t)}}static fromUint8Array(t){return new Td(ar.fromUint8Array(t))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(t){return this._byteString.isEqual(t._byteString)}}class bd{constructor(t){this._methodName=t}}class Id{constructor(t,e){if(!isFinite(t)||t<-90||t>90)throw new Ls(Rs.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+t);if(!isFinite(e)||e<-180||e>180)throw new Ls(Rs.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+e);this._lat=t,this._long=e}get latitude(){return this._lat}get longitude(){return this._long}isEqual(t){return this._lat===t._lat&&this._long===t._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(t){return Hs(this._lat,t._lat)||Hs(this._long,t._long)}}const Ed=/^__.*__$/;class Sd{constructor(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}toMutation(t,e){return null!==this.fieldMask?new Gi(t,this.data,this.fieldMask,e,this.fieldTransforms):new $i(t,this.data,e,this.fieldTransforms)}}class Ad{constructor(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}toMutation(t,e){return new Gi(t,this.data,this.fieldMask,e,this.fieldTransforms)}}function _d(t){switch(t){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw Ds()}}class kd{constructor(t,e,n,s,r,i){this.settings=t,this.databaseId=e,this.k=n,this.ignoreUndefinedProperties=s,void 0===r&&this.xc(),this.fieldTransforms=r||[],this.fieldMask=i||[]}get path(){return this.settings.path}get $c(){return this.settings.$c}Oc(t){return new kd(Object.assign(Object.assign({},this.settings),t),this.databaseId,this.k,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}Mc(t){var e;const n=null===(e=this.path)||void 0===e?void 0:e.child(t),s=this.Oc({path:n,Fc:!1});return s.Lc(t),s}Bc(t){var e;const n=null===(e=this.path)||void 0===e?void 0:e.child(t),s=this.Oc({path:n,Fc:!1});return s.xc(),s}Uc(t){return this.Oc({path:void 0,Fc:!0})}qc(t){return Hd(t,this.settings.methodName,this.settings.Kc||!1,this.path,this.settings.jc)}contains(t){return void 0!==this.fieldMask.find((e=>t.isPrefixOf(e)))||void 0!==this.fieldTransforms.find((e=>t.isPrefixOf(e.field)))}xc(){if(this.path)for(let t=0;t<this.path.length;t++)this.Lc(this.path.get(t))}Lc(t){if(0===t.length)throw this.qc("Document fields must not be empty");if(_d(this.$c)&&Ed.test(t))throw this.qc('Document fields cannot begin and end with "__"')}}class Dd{constructor(t,e,n){this.databaseId=t,this.ignoreUndefinedProperties=e,this.k=n||Ru(t)}Qc(t,e,n,s=!1){return new kd({$c:t,methodName:e,jc:n,path:rr.emptyPath(),Fc:!1,Kc:s},this.databaseId,this.k,this.ignoreUndefinedProperties)}}function Cd(t){const e=t._freezeSettings(),n=Ru(t._databaseId);return new Dd(t._databaseId,!!e.ignoreUndefinedProperties,n)}function Nd(t,e,n,s,r,i={}){const o=t.Qc(i.merge||i.mergeFields?2:0,e,n,r);Kd("Data must be an object, but it was:",o,s);const a=Bd(s,o);let c,u;if(i.merge)c=new ir(o.fieldMask),u=o.fieldTransforms;else if(i.mergeFields){const t=[];for(const s of i.mergeFields){const r=$d(e,s,n);if(!o.contains(r))throw new Ls(Rs.INVALID_ARGUMENT,`Field '${r}' is specified in your field mask but missing from your input data.`);Qd(t,r)||t.push(r)}c=new ir(t),u=o.fieldTransforms.filter((t=>c.covers(t.field)))}else c=null,u=o.fieldTransforms;return new Sd(new Lr(a),c,u)}class xd extends bd{_toFieldTransform(t){if(2!==t.$c)throw 1===t.$c?t.qc(`${this._methodName}() can only appear at the top level of your update data`):t.qc(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return t.fieldMask.push(t.path),null}isEqual(t){return t instanceof xd}}function Rd(t,e,n){return new kd({$c:3,jc:e.settings.jc,methodName:t._methodName,Fc:n},e.databaseId,e.k,e.ignoreUndefinedProperties)}class Ld extends bd{_toFieldTransform(t){return new Mi(t.path,new _i)}isEqual(t){return t instanceof Ld}}class Md extends bd{constructor(t,e){super(t),this.Wc=e}_toFieldTransform(t){const e=Rd(this,t,!0),n=this.Wc.map((t=>Ud(t,e))),s=new ki(n);return new Mi(t.path,s)}isEqual(t){return this===t}}class Pd extends bd{constructor(t,e){super(t),this.Wc=e}_toFieldTransform(t){const e=Rd(this,t,!0),n=this.Wc.map((t=>Ud(t,e))),s=new Ci(n);return new Mi(t.path,s)}isEqual(t){return this===t}}class Od extends bd{constructor(t,e){super(t),this.Gc=e}_toFieldTransform(t){const e=new xi(t.k,bi(t.k,this.Gc));return new Mi(t.path,e)}isEqual(t){return this===t}}function Fd(t,e,n,s){const r=t.Qc(1,e,n);Kd("Data must be an object, but it was:",r,s);const i=[],o=Lr.empty();Zs(s,((t,s)=>{const c=zd(e,t,n);s=(0,a.m9)(s);const u=r.Bc(c);if(s instanceof xd)i.push(c);else{const t=Ud(s,u);null!=t&&(i.push(c),o.set(c,t))}}));const c=new ir(i);return new Ad(o,c,r.fieldTransforms)}function Vd(t,e,n,s,r,i){const o=t.Qc(1,e,n),c=[$d(e,s,n)],u=[r];if(i.length%2!=0)throw new Ls(Rs.INVALID_ARGUMENT,`Function ${e}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let t=0;t<i.length;t+=2)c.push($d(e,i[t])),u.push(i[t+1]);const h=[],l=Lr.empty();for(let t=c.length-1;t>=0;--t)if(!Qd(h,c[t])){const e=c[t];let n=u[t];n=(0,a.m9)(n);const s=o.Bc(e);if(n instanceof xd)h.push(e);else{const t=Ud(n,s);null!=t&&(h.push(e),l.set(e,t))}}const d=new ir(h);return new Ad(l,d,o.fieldTransforms)}function qd(t,e,n,s=!1){return Ud(n,t.Qc(s?4:3,e))}function Ud(t,e){if(jd(t=(0,a.m9)(t)))return Kd("Unsupported field value:",e,t),Bd(t,e);if(t instanceof bd)return function(t,e){if(!_d(e.$c))throw e.qc(`${t._methodName}() can only be used with update() and set()`);if(!e.path)throw e.qc(`${t._methodName}() is not currently supported inside arrays`);const n=t._toFieldTransform(e);n&&e.fieldTransforms.push(n)}(t,e),null;if(void 0===t&&e.ignoreUndefinedProperties)return null;if(e.path&&e.fieldMask.push(e.path),t instanceof Array){if(e.settings.Fc&&4!==e.$c)throw e.qc("Nested arrays are not supported");return function(t,e){const n=[];let s=0;for(const r of t){let t=Ud(r,e.Uc(s));null==t&&(t={nullValue:"NULL_VALUE"}),n.push(t),s++}return{arrayValue:{values:n}}}(t,e)}return function(t,e){if(null===(t=(0,a.m9)(t)))return{nullValue:"NULL_VALUE"};if("number"==typeof t)return bi(e.k,t);if("boolean"==typeof t)return{booleanValue:t};if("string"==typeof t)return{stringValue:t};if(t instanceof Date){const n=Ys.fromDate(t);return{timestampValue:No(e.k,n)}}if(t instanceof Ys){const n=new Ys(t.seconds,1e3*Math.floor(t.nanoseconds/1e3));return{timestampValue:No(e.k,n)}}if(t instanceof Id)return{geoPointValue:{latitude:t.latitude,longitude:t.longitude}};if(t instanceof Td)return{bytesValue:xo(e.k,t._byteString)};if(t instanceof $l){const n=e.databaseId,s=t.firestore._databaseId;if(!s.isEqual(n))throw e.qc(`Document reference is for database ${s.projectId}/${s.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:Mo(t.firestore._databaseId||e.databaseId,t._key.path)}}throw e.qc(`Unsupported field value: ${Vl(t)}`)}(t,e)}function Bd(t,e){const n={};return tr(t)?e.path&&e.path.length>0&&e.fieldMask.push(e.path):Zs(t,((t,s)=>{const r=Ud(s,e.Mc(t));null!=r&&(n[t]=r)})),{mapValue:{fields:n}}}function jd(t){return!("object"!=typeof t||null===t||t instanceof Array||t instanceof Date||t instanceof Ys||t instanceof Id||t instanceof Td||t instanceof $l||t instanceof bd)}function Kd(t,e,n){if(!jd(n)||!function(t){return"object"==typeof t&&null!==t&&(Object.getPrototypeOf(t)===Object.prototype||null===Object.getPrototypeOf(t))}(n)){const s=Vl(n);throw"an object"===s?e.qc(t+" a custom object"):e.qc(t+" "+s)}}function $d(t,e,n){if((e=(0,a.m9)(e))instanceof wd)return e._internalPath;if("string"==typeof e)return zd(t,e);throw Hd("Field path arguments must be of type string or ",t,!1,void 0,n)}const Gd=new RegExp("[~\\*/\\[\\]]");function zd(t,e,n){if(e.search(Gd)>=0)throw Hd(`Invalid field path (${e}). Paths must not contain '~', '*', '/', '[', or ']'`,t,!1,void 0,n);try{return new wd(...e.split("."))._internalPath}catch(s){throw Hd(`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,t,!1,void 0,n)}}function Hd(t,e,n,s,r){const i=s&&!s.isEmpty(),o=void 0!==r;let a=`Function ${e}() called with invalid data`;n&&(a+=" (via `toFirestore()`)"),a+=". ";let c="";return(i||o)&&(c+=" (found",i&&(c+=` in field ${s}`),o&&(c+=` in document ${r}`),c+=")"),new Ls(Rs.INVALID_ARGUMENT,a+t+c)}function Qd(t,e){return t.some((t=>t.isEqual(e)))}class Wd{constructor(t,e,n,s,r){this._firestore=t,this._userDataWriter=e,this._key=n,this._document=s,this._converter=r}get id(){return this._key.path.lastSegment()}get ref(){return new $l(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){const t=new Yd(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(t)}return this._userDataWriter.convertValue(this._document.data.value)}}get(t){if(this._document){const e=this._document.data.field(Xd("DocumentSnapshot.get",t));if(null!==e)return this._userDataWriter.convertValue(e)}}}class Yd extends Wd{data(){return super.data()}}function Xd(t,e){return"string"==typeof e?zd(t,e):e instanceof wd?e._internalPath:e._delegate._internalPath}class Jd{constructor(t,e){this.hasPendingWrites=t,this.fromCache=e}isEqual(t){return this.hasPendingWrites===t.hasPendingWrites&&this.fromCache===t.fromCache}}class Zd extends Wd{constructor(t,e,n,s,r,i){super(t,e,n,s,i),this._firestore=t,this._firestoreImpl=t,this.metadata=r}exists(){return super.exists()}data(t={}){if(this._document){if(this._converter){const e=new tf(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(e,t)}return this._userDataWriter.convertValue(this._document.data.value,t.serverTimestamps)}}get(t,e={}){if(this._document){const n=this._document.data.field(Xd("DocumentSnapshot.get",t));if(null!==n)return this._userDataWriter.convertValue(n,e.serverTimestamps)}}}class tf extends Zd{data(t={}){return super.data(t)}}class ef{constructor(t,e,n,s){this._firestore=t,this._userDataWriter=e,this._snapshot=s,this.metadata=new Jd(s.hasPendingWrites,s.fromCache),this.query=n}get docs(){const t=[];return this.forEach((e=>t.push(e))),t}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(t,e){this._snapshot.docs.forEach((n=>{t.call(e,new tf(this._firestore,this._userDataWriter,n.key,n,new Jd(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))}))}docChanges(t={}){const e=!!t.includeMetadataChanges;if(e&&this._snapshot.excludesMetadataChanges)throw new Ls(Rs.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===e||(this._cachedChanges=function(t,e){if(t._snapshot.oldDocs.isEmpty()){let e=0;return t._snapshot.docChanges.map((n=>({type:"added",doc:new tf(t._firestore,t._userDataWriter,n.doc.key,n.doc,new Jd(t._snapshot.mutatedKeys.has(n.doc.key),t._snapshot.fromCache),t.query.converter),oldIndex:-1,newIndex:e++})))}{let n=t._snapshot.oldDocs;return t._snapshot.docChanges.filter((t=>e||3!==t.type)).map((e=>{const s=new tf(t._firestore,t._userDataWriter,e.doc.key,e.doc,new Jd(t._snapshot.mutatedKeys.has(e.doc.key),t._snapshot.fromCache),t.query.converter);let r=-1,i=-1;return 0!==e.type&&(r=n.indexOf(e.doc.key),n=n.delete(e.doc.key)),1!==e.type&&(n=n.add(e.doc),i=n.indexOf(e.doc.key)),{type:nf(e.type),doc:s,oldIndex:r,newIndex:i}}))}}(this,e),this._cachedChangesIncludeMetadataChanges=e),this._cachedChanges}}function nf(t){switch(t){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return Ds()}}function sf(t,e){return t instanceof Zd&&e instanceof Zd?t._firestore===e._firestore&&t._key.isEqual(e._key)&&(null===t._document?null===e._document:t._document.isEqual(e._document))&&t._converter===e._converter:t instanceof ef&&e instanceof ef&&t._firestore===e._firestore&&Xl(t.query,e.query)&&t.metadata.isEqual(e.metadata)&&t._snapshot.isEqual(e._snapshot)}function rf(t){if(oi(t)&&0===t.explicitOrderBy.length)throw new Ls(Rs.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class of{}function af(t,...e){for(const n of e)t=n._apply(t);return t}class cf extends of{constructor(t,e,n){super(),this.zc=t,this.Hc=e,this.Jc=n,this.type="where"}_apply(t){const e=Cd(t.firestore),n=function(t,e,n,s,r,i,o){let a;if(r.isKeyField()){if("array-contains"===i||"array-contains-any"===i)throw new Ls(Rs.INVALID_ARGUMENT,`Invalid Query. You can't perform '${i}' queries on documentId().`);if("in"===i||"not-in"===i){Ef(o,i);const e=[];for(const n of o)e.push(If(s,t,n));a={arrayValue:{values:e}}}else a=If(s,t,o)}else"in"!==i&&"not-in"!==i&&"array-contains-any"!==i||Ef(o,i),a=qd(n,"where",o,"in"===i||"not-in"===i);const c=Br.create(r,i,a);return function(t,e){if(e.V()){const n=ci(t);if(null!==n&&!n.isEqual(e.field))throw new Ls(Rs.INVALID_ARGUMENT,`Invalid query. All where filters with an inequality (<, <=, !=, not-in, >, or >=) must be on the same field. But you have inequality filters on '${n.toString()}' and '${e.field.toString()}'`);const s=ai(t);null!==s&&Sf(0,e.field,s)}const n=function(t,e){for(const n of t.filters)if(e.indexOf(n.op)>=0)return n.op;return null}(t,function(t){switch(t){case"!=":return["!=","not-in"];case"array-contains":return["array-contains","array-contains-any","not-in"];case"in":return["array-contains-any","in","not-in"];case"array-contains-any":return["array-contains","array-contains-any","in","not-in"];case"not-in":return["array-contains","array-contains-any","in","not-in","!="];default:return[]}}(e.op));if(null!==n)throw n===e.op?new Ls(Rs.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${e.op.toString()}' filter.`):new Ls(Rs.INVALID_ARGUMENT,`Invalid query. You cannot use '${e.op.toString()}' filters with '${n.toString()}' filters.`)}(t,c),c}(t._query,0,e,t.firestore._databaseId,this.zc,this.Hc,this.Jc);return new Gl(t.firestore,t.converter,function(t,e){const n=t.filters.concat([e]);return new ni(t.path,t.collectionGroup,t.explicitOrderBy.slice(),n,t.limit,t.limitType,t.startAt,t.endAt)}(t._query,n))}}function uf(t,e,n){const s=e,r=Xd("where",t);return new cf(r,s,n)}class hf extends of{constructor(t,e){super(),this.zc=t,this.Yc=e,this.type="orderBy"}_apply(t){const e=function(t,e,n){if(null!==t.startAt)throw new Ls(Rs.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==t.endAt)throw new Ls(Rs.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");const s=new Jr(e,n);return function(t,e){if(null===ai(t)){const n=ci(t);null!==n&&Sf(0,n,e.field)}}(t,s),s}(t._query,this.zc,this.Yc);return new Gl(t.firestore,t.converter,function(t,e){const n=t.explicitOrderBy.concat([e]);return new ni(t.path,t.collectionGroup,n,t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt)}(t._query,e))}}function lf(t,e="asc"){const n=e,s=Xd("orderBy",t);return new hf(s,n)}class df extends of{constructor(t,e,n){super(),this.type=t,this.Xc=e,this.Zc=n}_apply(t){return new Gl(t.firestore,t.converter,di(t._query,this.Xc,this.Zc))}}function ff(t){return Ul("limit",t),new df("limit",t,"F")}function mf(t){return Ul("limitToLast",t),new df("limitToLast",t,"L")}class gf extends of{constructor(t,e,n){super(),this.type=t,this.ta=e,this.ea=n}_apply(t){const e=bf(t,this.type,this.ta,this.ea);return new Gl(t.firestore,t.converter,function(t,e){return new ni(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,e,t.endAt)}(t._query,e))}}function pf(...t){return new gf("startAt",t,!0)}function yf(...t){return new gf("startAfter",t,!1)}class wf extends of{constructor(t,e,n){super(),this.type=t,this.ta=e,this.ea=n}_apply(t){const e=bf(t,this.type,this.ta,this.ea);return new Gl(t.firestore,t.converter,function(t,e){return new ni(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,e)}(t._query,e))}}function vf(...t){return new wf("endBefore",t,!0)}function Tf(...t){return new wf("endAt",t,!1)}function bf(t,e,n,s){if(n[0]=(0,a.m9)(n[0]),n[0]instanceof Wd)return function(t,e,n,s,r){if(!s)throw new Ls(Rs.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);const i=[];for(const n of hi(t))if(n.field.isKeyField())i.push(_r(e,s.key));else{const t=s.data.field(n.field);if(dr(t))throw new Ls(Rs.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+n.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===t){const t=n.field.canonicalString();throw new Ls(Rs.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${t}' (used as the orderBy) does not exist.`)}i.push(t)}return new Yr(i,r)}(t._query,t.firestore._databaseId,e,n[0]._document,s);{const r=Cd(t.firestore);return function(t,e,n,s,r,i){const o=t.explicitOrderBy;if(r.length>o.length)throw new Ls(Rs.INVALID_ARGUMENT,`Too many arguments provided to ${s}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const a=[];for(let i=0;i<r.length;i++){const c=r[i];if(o[i].field.isKeyField()){if("string"!=typeof c)throw new Ls(Rs.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${s}(), but got a ${typeof c}`);if(!ui(t)&&-1!==c.indexOf("/"))throw new Ls(Rs.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${s}() must be a plain document ID, but '${c}' contains a slash.`);const n=t.path.child(nr.fromString(c));if(!wr.isDocumentKey(n))throw new Ls(Rs.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${s}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);const r=new wr(n);a.push(_r(e,r))}else{const t=qd(n,s,c);a.push(t)}}return new Yr(a,i)}(t._query,t.firestore._databaseId,r,e,n,s)}}function If(t,e,n){if("string"==typeof(n=(0,a.m9)(n))){if(""===n)throw new Ls(Rs.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!ui(e)&&-1!==n.indexOf("/"))throw new Ls(Rs.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);const s=e.path.child(nr.fromString(n));if(!wr.isDocumentKey(s))throw new Ls(Rs.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${s}' is not because it has an odd number of segments (${s.length}).`);return _r(t,new wr(s))}if(n instanceof $l)return _r(t,n._key);throw new Ls(Rs.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${Vl(n)}.`)}function Ef(t,e){if(!Array.isArray(t)||0===t.length)throw new Ls(Rs.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${e.toString()}' filters.`);if(t.length>10)throw new Ls(Rs.INVALID_ARGUMENT,`Invalid Query. '${e.toString()}' filters support a maximum of 10 elements in the value array.`)}function Sf(t,e,n){if(!n.isEqual(e))throw new Ls(Rs.INVALID_ARGUMENT,`Invalid query. You have a where filter with an inequality (<, <=, !=, not-in, >, or >=) on field '${e.toString()}' and so you must also use '${e.toString()}' as your first argument to orderBy(), but your first orderBy() is on field '${n.toString()}' instead.`)}class Af{convertValue(t,e="none"){switch(vr(t)){case 0:return null;case 1:return t.booleanValue;case 2:return hr(t.integerValue||t.doubleValue);case 3:return this.convertTimestamp(t.timestampValue);case 4:return this.convertServerTimestamp(t,e);case 5:return t.stringValue;case 6:return this.convertBytes(lr(t.bytesValue));case 7:return this.convertReference(t.referenceValue);case 8:return this.convertGeoPoint(t.geoPointValue);case 9:return this.convertArray(t.arrayValue,e);case 10:return this.convertObject(t.mapValue,e);default:throw Ds()}}convertObject(t,e){const n={};return Zs(t.fields,((t,s)=>{n[t]=this.convertValue(s,e)})),n}convertGeoPoint(t){return new Id(hr(t.latitude),hr(t.longitude))}convertArray(t,e){return(t.values||[]).map((t=>this.convertValue(t,e)))}convertServerTimestamp(t,e){switch(e){case"previous":const n=fr(t);return null==n?null:this.convertValue(n,e);case"estimate":return this.convertTimestamp(mr(t));default:return null}}convertTimestamp(t){const e=ur(t);return new Ys(e.seconds,e.nanos)}convertDocumentKey(t,e){const n=nr.fromString(t);Cs(ia(n));const s=new Rl(n.get(1),n.get(3)),r=new wr(n.popFirst(5));return s.isEqual(e)||As(`Document ${r} contains a document reference within a different database (${s.projectId}/${s.database}) which is not supported. It will be treated as a reference in the current database (${e.projectId}/${e.database}) instead.`),r}}function _f(t,e,n){let s;return s=t?n&&(n.merge||n.mergeFields)?t.toFirestore(e,n):t.toFirestore(e):e,s}class kf extends Af{constructor(t){super(),this.firestore=t}convertBytes(t){return new Td(t)}convertReference(t){const e=this.convertDocumentKey(t,this.firestore._databaseId);return new $l(this.firestore,null,e)}}class Df{constructor(t,e){this._firestore=t,this._commitHandler=e,this._mutations=[],this._committed=!1,this._dataReader=Cd(t)}set(t,e,n){this._verifyNotCommitted();const s=Cf(t,this._firestore),r=_f(s.converter,e,n),i=Nd(this._dataReader,"WriteBatch.set",s._key,r,null!==s.converter,n);return this._mutations.push(i.toMutation(s._key,Oi.none())),this}update(t,e,n,...s){this._verifyNotCommitted();const r=Cf(t,this._firestore);let i;return i="string"==typeof(e=(0,a.m9)(e))||e instanceof wd?Vd(this._dataReader,"WriteBatch.update",r._key,e,n,s):Fd(this._dataReader,"WriteBatch.update",r._key,e),this._mutations.push(i.toMutation(r._key,Oi.exists(!0))),this}delete(t){this._verifyNotCommitted();const e=Cf(t,this._firestore);return this._mutations=this._mutations.concat(new Wi(e._key,Oi.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new Ls(Rs.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function Cf(t,e){if((t=(0,a.m9)(t)).firestore!==e)throw new Ls(Rs.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return t}function Nf(t){t=ql(t,$l);const e=ql(t.firestore,nd);return Cl(id(e),t._key).then((n=>$f(e,t,n)))}class xf extends Af{constructor(t){super(),this.firestore=t}convertBytes(t){return new Td(t)}convertReference(t){const e=this.convertDocumentKey(t,this.firestore._databaseId);return new $l(this.firestore,null,e)}}function Rf(t){t=ql(t,$l);const e=ql(t.firestore,nd),n=id(e),s=new xf(e);return function(t,e){const n=new Ms;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){try{const s=await function(t,e){const n=xs(t);return n.persistence.runTransaction("read document","readonly",(t=>n.Wn.Rn(t,e)))}(t,e);s.isFoundDocument()?n.resolve(s):s.isNoDocument()?n.resolve(null):n.reject(new Ls(Rs.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(t){const s=mh(t,`Failed to get document '${e} from cache`);n.reject(s)}}(await Al(t),e,n))),n.promise}(n,t._key).then((n=>new Zd(e,s,t._key,n,new Jd(null!==n&&n.hasLocalMutations,!0),t.converter)))}function Lf(t){t=ql(t,$l);const e=ql(t.firestore,nd);return Cl(id(e),t._key,{source:"server"}).then((n=>$f(e,t,n)))}function Mf(t){t=ql(t,Gl);const e=ql(t.firestore,nd),n=id(e),s=new xf(e);return rf(t._query),Nl(n,t._query).then((n=>new ef(e,s,t,n)))}function Pf(t){t=ql(t,Gl);const e=ql(t.firestore,nd),n=id(e),s=new xf(e);return function(t,e){const n=new Ms;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){try{const s=await eu(t,e,!0),r=new Rh(e,s.zn),i=r.Po(s.documents),o=r.applyChanges(i,!1);n.resolve(o.snapshot)}catch(t){const s=mh(t,`Failed to execute query '${e} against cache`);n.reject(s)}}(await Al(t),e,n))),n.promise}(n,t._query).then((n=>new ef(e,s,t,n)))}function Of(t){t=ql(t,Gl);const e=ql(t.firestore,nd),n=id(e),s=new xf(e);return Nl(n,t._query,{source:"server"}).then((n=>new ef(e,s,t,n)))}function Ff(t,e,n){t=ql(t,$l);const s=ql(t.firestore,nd),r=_f(t.converter,e,n);return Kf(s,[Nd(Cd(s),"setDoc",t._key,r,null!==t.converter,n).toMutation(t._key,Oi.none())])}function Vf(t,e,n,...s){t=ql(t,$l);const r=ql(t.firestore,nd),i=Cd(r);let o;return o="string"==typeof(e=(0,a.m9)(e))||e instanceof wd?Vd(i,"updateDoc",t._key,e,n,s):Fd(i,"updateDoc",t._key,e),Kf(r,[o.toMutation(t._key,Oi.exists(!0))])}function qf(t){return Kf(ql(t.firestore,nd),[new Wi(t._key,Oi.none())])}function Uf(t,e){const n=ql(t.firestore,nd),s=Wl(t),r=_f(t.converter,e);return Kf(n,[Nd(Cd(t.firestore),"addDoc",s._key,r,null!==t.converter,{}).toMutation(s._key,Oi.exists(!1))]).then((()=>s))}function Bf(t,...e){var n,s,r;t=(0,a.m9)(t);let i={includeMetadataChanges:!1},o=0;"object"!=typeof e[o]||Zl(e[o])||(i=e[o],o++);const c={includeMetadataChanges:i.includeMetadataChanges};if(Zl(e[o])){const t=e[o];e[o]=null===(n=t.next)||void 0===n?void 0:n.bind(t),e[o+1]=null===(s=t.error)||void 0===s?void 0:s.bind(t),e[o+2]=null===(r=t.complete)||void 0===r?void 0:r.bind(t)}let u,h,l;if(t instanceof $l)h=ql(t.firestore,nd),l=ri(t._key.path),u={next:n=>{e[o]&&e[o]($f(h,t,n))},error:e[o+1],complete:e[o+2]};else{const n=ql(t,Gl);h=ql(n.firestore,nd),l=n._query;const s=new xf(h);u={next:t=>{e[o]&&e[o](new ef(h,s,n,t))},error:e[o+1],complete:e[o+2]},rf(t._query)}return function(t,e,n,s){const r=new gl(s),i=new Ah(e,r,n);return t.asyncQueue.enqueueAndForget((async()=>Th(await Dl(t),i))),()=>{r.nc(),t.asyncQueue.enqueueAndForget((async()=>bh(await Dl(t),i)))}}(id(h),l,c,u)}function jf(t,e){return function(t,e){const n=new gl(e);return t.asyncQueue.enqueueAndForget((async()=>function(t,e){xs(t).io.add(e),e.next()}(await Dl(t),n))),()=>{n.nc(),t.asyncQueue.enqueueAndForget((async()=>function(t,e){xs(t).io.delete(e)}(await Dl(t),n)))}}(id(t=ql(t,nd)),Zl(e)?e:{next:e})}function Kf(t,e){return function(t,e){const n=new Ms;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){const s=ul(t);try{const t=await function(t,e){const n=xs(t),s=Ys.now(),r=e.reduce(((t,e)=>t.add(e.key)),go());let i;return n.persistence.runTransaction("Locally write mutations","readwrite",(t=>n.Wn.vn(t,r).next((r=>{i=r;const o=[];for(const t of e){const e=Bi(t,i.get(t.key));null!=e&&o.push(new Gi(t.key,e,Mr(e.value.mapValue),Oi.exists(!0)))}return n.An.addMutationBatch(t,s,o,e)})))).then((t=>(t.applyToLocalDocumentSet(i),{batchId:t.batchId,changes:i})))}(s.localStore,e);s.sharedClientState.addPendingMutation(t.batchId),function(t,e,n){let s=t.Ko[t.currentUser.toKey()];s||(s=new no(Hs)),s=s.insert(e,n),t.Ko[t.currentUser.toKey()]=s}(s,t.batchId,n),await Xh(s,t.changes),await eh(s.remoteStore)}catch(t){const e=mh(t,"Failed to persist write");n.reject(e)}}(await kl(t),e,n))),n.promise}(id(t),e)}function $f(t,e,n){const s=n.docs.get(e._key),r=new xf(t);return new Zd(t,r,e._key,s,new Jd(n.hasPendingWrites,n.fromCache),e.converter)}class Gf extends class{constructor(t,e){this._firestore=t,this._transaction=e,this._dataReader=Cd(t)}get(t){const e=Cf(t,this._firestore),n=new kf(this._firestore);return this._transaction.lookup([e._key]).then((t=>{if(!t||1!==t.length)return Ds();const s=t[0];if(s.isFoundDocument())return new Wd(this._firestore,n,s.key,s,e.converter);if(s.isNoDocument())return new Wd(this._firestore,n,e._key,null,e.converter);throw Ds()}))}set(t,e,n){const s=Cf(t,this._firestore),r=_f(s.converter,e,n),i=Nd(this._dataReader,"Transaction.set",s._key,r,null!==s.converter,n);return this._transaction.set(s._key,i),this}update(t,e,n,...s){const r=Cf(t,this._firestore);let i;return i="string"==typeof(e=(0,a.m9)(e))||e instanceof wd?Vd(this._dataReader,"Transaction.update",r._key,e,n,s):Fd(this._dataReader,"Transaction.update",r._key,e),this._transaction.update(r._key,i),this}delete(t){const e=Cf(t,this._firestore);return this._transaction.delete(e._key),this}}{constructor(t,e){super(t,e),this._firestore=t}get(t){const e=Cf(t,this._firestore),n=new xf(this._firestore);return super.get(t).then((t=>new Zd(this._firestore,n,e._key,t._document,new Jd(!1,!1),e.converter)))}}function zf(t,e){return function(t,e){const n=new Ms;return t.asyncQueue.enqueueAndForget((async()=>{const s=await function(t){return El(t).then((t=>t.datastore))}(t);new wl(t.asyncQueue,s,e,n).run()})),n.promise}(id(t=ql(t,nd)),(n=>e(new Gf(t,n))))}function Hf(){return new xd("deleteField")}function Qf(){return new Ld("serverTimestamp")}function Wf(...t){return new Md("arrayUnion",t)}function Yf(...t){return new Pd("arrayRemove",t)}function Xf(t){return new Od("increment",t)}function Jf(t){return id(t=ql(t,nd)),new Df(t,(e=>Kf(t,e)))}!function(t,e=!0){!function(t){Ts=t}(r.Jn),(0,r.Xd)(new i.wA("firestore",((t,{options:n})=>{const s=t.getProvider("app").getImmediate(),r=new nd(s,new Vs(t.getProvider("auth-internal")),new js(t.getProvider("app-check-internal")));return n=Object.assign({useFetchStreams:e},n),r._setSettings(n),r}),"PUBLIC")),(0,r.KN)(ws,"3.4.3",t),(0,r.KN)(ws,"3.4.3","esm2017")}()}}]);